2357c35b9c665762bc72d3e0daa25a7a
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

exports.__esModule = true;
exports["default"] = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _isPromise = _interopRequireDefault(require("is-promise"));

var _SubmissionError = require("./SubmissionError");

var mergeErrors = function mergeErrors(_ref) {
  var asyncErrors = _ref.asyncErrors,
      syncErrors = _ref.syncErrors;
  return asyncErrors && typeof asyncErrors.merge === 'function' ? asyncErrors.merge(syncErrors).toJS() : (0, _extends2["default"])({}, asyncErrors, {}, syncErrors);
};

var executeSubmit = function executeSubmit(submit, fields, props) {
  var dispatch = props.dispatch,
      submitAsSideEffect = props.submitAsSideEffect,
      onSubmitFail = props.onSubmitFail,
      onSubmitSuccess = props.onSubmitSuccess,
      startSubmit = props.startSubmit,
      stopSubmit = props.stopSubmit,
      setSubmitFailed = props.setSubmitFailed,
      setSubmitSucceeded = props.setSubmitSucceeded,
      values = props.values;
  var result;

  try {
    result = submit(values, dispatch, props);
  } catch (submitError) {
    var error = (0, _SubmissionError.isSubmissionError)(submitError) ? submitError.errors : undefined;
    stopSubmit(error);
    setSubmitFailed.apply(void 0, fields);

    if (onSubmitFail) {
      onSubmitFail(error, dispatch, submitError, props);
    }

    if (error || onSubmitFail) {
      return error;
    } else {
      throw submitError;
    }
  }

  if (submitAsSideEffect) {
    if (result) {
      dispatch(result);
    }
  } else {
    if ((0, _isPromise["default"])(result)) {
      startSubmit();
      return result.then(function (submitResult) {
        stopSubmit();
        setSubmitSucceeded();

        if (onSubmitSuccess) {
          onSubmitSuccess(submitResult, dispatch, props);
        }

        return submitResult;
      }, function (submitError) {
        var error = (0, _SubmissionError.isSubmissionError)(submitError) ? submitError.errors : undefined;
        stopSubmit(error);
        setSubmitFailed.apply(void 0, fields);

        if (onSubmitFail) {
          onSubmitFail(error, dispatch, submitError, props);
        }

        if (error || onSubmitFail) {
          return error;
        } else {
          throw submitError;
        }
      });
    } else {
      setSubmitSucceeded();

      if (onSubmitSuccess) {
        onSubmitSuccess(result, dispatch, props);
      }
    }
  }

  return result;
};

var handleSubmit = function handleSubmit(submit, props, valid, asyncValidate, fields) {
  var dispatch = props.dispatch,
      onSubmitFail = props.onSubmitFail,
      setSubmitFailed = props.setSubmitFailed,
      syncErrors = props.syncErrors,
      asyncErrors = props.asyncErrors,
      touch = props.touch,
      persistentSubmitErrors = props.persistentSubmitErrors;
  touch.apply(void 0, fields);

  if (valid || persistentSubmitErrors) {
    var asyncValidateResult = asyncValidate && asyncValidate();

    if (asyncValidateResult) {
      return asyncValidateResult.then(function (asyncErrors) {
        if (asyncErrors) {
          throw asyncErrors;
        }

        return executeSubmit(submit, fields, props);
      })["catch"](function (asyncErrors) {
        setSubmitFailed.apply(void 0, fields);

        if (onSubmitFail) {
          onSubmitFail(asyncErrors, dispatch, null, props);
        }

        return Promise.reject(asyncErrors);
      });
    } else {
      return executeSubmit(submit, fields, props);
    }
  } else {
    setSubmitFailed.apply(void 0, fields);
    var errors = mergeErrors({
      asyncErrors: asyncErrors,
      syncErrors: syncErrors
    });

    if (onSubmitFail) {
      onSubmitFail(errors, dispatch, null, props);
    }

    return errors;
  }
};

var _default = handleSubmit;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhhbmRsZVN1Ym1pdC5qcyJdLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsImV4cG9ydHMiLCJfX2VzTW9kdWxlIiwiX2V4dGVuZHMyIiwiX2lzUHJvbWlzZSIsIl9TdWJtaXNzaW9uRXJyb3IiLCJtZXJnZUVycm9ycyIsIl9yZWYiLCJhc3luY0Vycm9ycyIsInN5bmNFcnJvcnMiLCJtZXJnZSIsInRvSlMiLCJleGVjdXRlU3VibWl0Iiwic3VibWl0IiwiZmllbGRzIiwicHJvcHMiLCJkaXNwYXRjaCIsInN1Ym1pdEFzU2lkZUVmZmVjdCIsIm9uU3VibWl0RmFpbCIsIm9uU3VibWl0U3VjY2VzcyIsInN0YXJ0U3VibWl0Iiwic3RvcFN1Ym1pdCIsInNldFN1Ym1pdEZhaWxlZCIsInNldFN1Ym1pdFN1Y2NlZWRlZCIsInZhbHVlcyIsInJlc3VsdCIsInN1Ym1pdEVycm9yIiwiZXJyb3IiLCJpc1N1Ym1pc3Npb25FcnJvciIsImVycm9ycyIsInVuZGVmaW5lZCIsImFwcGx5IiwidGhlbiIsInN1Ym1pdFJlc3VsdCIsImhhbmRsZVN1Ym1pdCIsInZhbGlkIiwiYXN5bmNWYWxpZGF0ZSIsInRvdWNoIiwicGVyc2lzdGVudFN1Ym1pdEVycm9ycyIsImFzeW5jVmFsaWRhdGVSZXN1bHQiLCJQcm9taXNlIiwicmVqZWN0IiwiX2RlZmF1bHQiXSwibWFwcGluZ3MiOiJBQUFBOztBQUVBLElBQUlBLHNCQUFzQixHQUFHQyxPQUFPLENBQUMsOENBQUQsQ0FBcEM7O0FBRUFDLE9BQU8sQ0FBQ0MsVUFBUixHQUFxQixJQUFyQjtBQUNBRCxPQUFPLENBQUMsU0FBRCxDQUFQLEdBQXFCLEtBQUssQ0FBMUI7O0FBRUEsSUFBSUUsU0FBUyxHQUFHSixzQkFBc0IsQ0FBQ0MsT0FBTyxDQUFDLGdDQUFELENBQVIsQ0FBdEM7O0FBRUEsSUFBSUksVUFBVSxHQUFHTCxzQkFBc0IsQ0FBQ0MsT0FBTyxDQUFDLFlBQUQsQ0FBUixDQUF2Qzs7QUFFQSxJQUFJSyxnQkFBZ0IsR0FBR0wsT0FBTyxDQUFDLG1CQUFELENBQTlCOztBQUVBLElBQUlNLFdBQVcsR0FBRyxTQUFTQSxXQUFULENBQXFCQyxJQUFyQixFQUEyQjtBQUMzQyxNQUFJQyxXQUFXLEdBQUdELElBQUksQ0FBQ0MsV0FBdkI7QUFBQSxNQUNJQyxVQUFVLEdBQUdGLElBQUksQ0FBQ0UsVUFEdEI7QUFFQSxTQUFPRCxXQUFXLElBQUksT0FBT0EsV0FBVyxDQUFDRSxLQUFuQixLQUE2QixVQUE1QyxHQUF5REYsV0FBVyxDQUFDRSxLQUFaLENBQWtCRCxVQUFsQixFQUE4QkUsSUFBOUIsRUFBekQsR0FBZ0csQ0FBQyxHQUFHUixTQUFTLENBQUMsU0FBRCxDQUFiLEVBQTBCLEVBQTFCLEVBQThCSyxXQUE5QixFQUEyQyxFQUEzQyxFQUErQ0MsVUFBL0MsQ0FBdkc7QUFDRCxDQUpEOztBQU1BLElBQUlHLGFBQWEsR0FBRyxTQUFTQSxhQUFULENBQXVCQyxNQUF2QixFQUErQkMsTUFBL0IsRUFBdUNDLEtBQXZDLEVBQThDO0FBQ2hFLE1BQUlDLFFBQVEsR0FBR0QsS0FBSyxDQUFDQyxRQUFyQjtBQUFBLE1BQ0lDLGtCQUFrQixHQUFHRixLQUFLLENBQUNFLGtCQUQvQjtBQUFBLE1BRUlDLFlBQVksR0FBR0gsS0FBSyxDQUFDRyxZQUZ6QjtBQUFBLE1BR0lDLGVBQWUsR0FBR0osS0FBSyxDQUFDSSxlQUg1QjtBQUFBLE1BSUlDLFdBQVcsR0FBR0wsS0FBSyxDQUFDSyxXQUp4QjtBQUFBLE1BS0lDLFVBQVUsR0FBR04sS0FBSyxDQUFDTSxVQUx2QjtBQUFBLE1BTUlDLGVBQWUsR0FBR1AsS0FBSyxDQUFDTyxlQU41QjtBQUFBLE1BT0lDLGtCQUFrQixHQUFHUixLQUFLLENBQUNRLGtCQVAvQjtBQUFBLE1BUUlDLE1BQU0sR0FBR1QsS0FBSyxDQUFDUyxNQVJuQjtBQVNBLE1BQUlDLE1BQUo7O0FBRUEsTUFBSTtBQUNGQSxJQUFBQSxNQUFNLEdBQUdaLE1BQU0sQ0FBQ1csTUFBRCxFQUFTUixRQUFULEVBQW1CRCxLQUFuQixDQUFmO0FBQ0QsR0FGRCxDQUVFLE9BQU9XLFdBQVAsRUFBb0I7QUFDcEIsUUFBSUMsS0FBSyxHQUFHLENBQUMsR0FBR3RCLGdCQUFnQixDQUFDdUIsaUJBQXJCLEVBQXdDRixXQUF4QyxJQUF1REEsV0FBVyxDQUFDRyxNQUFuRSxHQUE0RUMsU0FBeEY7QUFDQVQsSUFBQUEsVUFBVSxDQUFDTSxLQUFELENBQVY7QUFDQUwsSUFBQUEsZUFBZSxDQUFDUyxLQUFoQixDQUFzQixLQUFLLENBQTNCLEVBQThCakIsTUFBOUI7O0FBRUEsUUFBSUksWUFBSixFQUFrQjtBQUNoQkEsTUFBQUEsWUFBWSxDQUFDUyxLQUFELEVBQVFYLFFBQVIsRUFBa0JVLFdBQWxCLEVBQStCWCxLQUEvQixDQUFaO0FBQ0Q7O0FBRUQsUUFBSVksS0FBSyxJQUFJVCxZQUFiLEVBQTJCO0FBRXpCLGFBQU9TLEtBQVA7QUFDRCxLQUhELE1BR087QUFDTCxZQUFNRCxXQUFOO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJVCxrQkFBSixFQUF3QjtBQUN0QixRQUFJUSxNQUFKLEVBQVk7QUFDVlQsTUFBQUEsUUFBUSxDQUFDUyxNQUFELENBQVI7QUFDRDtBQUNGLEdBSkQsTUFJTztBQUNMLFFBQUksQ0FBQyxHQUFHckIsVUFBVSxDQUFDLFNBQUQsQ0FBZCxFQUEyQnFCLE1BQTNCLENBQUosRUFBd0M7QUFDdENMLE1BQUFBLFdBQVc7QUFDWCxhQUFPSyxNQUFNLENBQUNPLElBQVAsQ0FBWSxVQUFVQyxZQUFWLEVBQXdCO0FBQ3pDWixRQUFBQSxVQUFVO0FBQ1ZFLFFBQUFBLGtCQUFrQjs7QUFFbEIsWUFBSUosZUFBSixFQUFxQjtBQUNuQkEsVUFBQUEsZUFBZSxDQUFDYyxZQUFELEVBQWVqQixRQUFmLEVBQXlCRCxLQUF6QixDQUFmO0FBQ0Q7O0FBRUQsZUFBT2tCLFlBQVA7QUFDRCxPQVRNLEVBU0osVUFBVVAsV0FBVixFQUF1QjtBQUN4QixZQUFJQyxLQUFLLEdBQUcsQ0FBQyxHQUFHdEIsZ0JBQWdCLENBQUN1QixpQkFBckIsRUFBd0NGLFdBQXhDLElBQXVEQSxXQUFXLENBQUNHLE1BQW5FLEdBQTRFQyxTQUF4RjtBQUNBVCxRQUFBQSxVQUFVLENBQUNNLEtBQUQsQ0FBVjtBQUNBTCxRQUFBQSxlQUFlLENBQUNTLEtBQWhCLENBQXNCLEtBQUssQ0FBM0IsRUFBOEJqQixNQUE5Qjs7QUFFQSxZQUFJSSxZQUFKLEVBQWtCO0FBQ2hCQSxVQUFBQSxZQUFZLENBQUNTLEtBQUQsRUFBUVgsUUFBUixFQUFrQlUsV0FBbEIsRUFBK0JYLEtBQS9CLENBQVo7QUFDRDs7QUFFRCxZQUFJWSxLQUFLLElBQUlULFlBQWIsRUFBMkI7QUFFekIsaUJBQU9TLEtBQVA7QUFDRCxTQUhELE1BR087QUFDTCxnQkFBTUQsV0FBTjtBQUNEO0FBQ0YsT0F4Qk0sQ0FBUDtBQXlCRCxLQTNCRCxNQTJCTztBQUNMSCxNQUFBQSxrQkFBa0I7O0FBRWxCLFVBQUlKLGVBQUosRUFBcUI7QUFDbkJBLFFBQUFBLGVBQWUsQ0FBQ00sTUFBRCxFQUFTVCxRQUFULEVBQW1CRCxLQUFuQixDQUFmO0FBQ0Q7QUFDRjtBQUNGOztBQUVELFNBQU9VLE1BQVA7QUFDRCxDQXpFRDs7QUEyRUEsSUFBSVMsWUFBWSxHQUFHLFNBQVNBLFlBQVQsQ0FBc0JyQixNQUF0QixFQUE4QkUsS0FBOUIsRUFBcUNvQixLQUFyQyxFQUE0Q0MsYUFBNUMsRUFBMkR0QixNQUEzRCxFQUFtRTtBQUNwRixNQUFJRSxRQUFRLEdBQUdELEtBQUssQ0FBQ0MsUUFBckI7QUFBQSxNQUNJRSxZQUFZLEdBQUdILEtBQUssQ0FBQ0csWUFEekI7QUFBQSxNQUVJSSxlQUFlLEdBQUdQLEtBQUssQ0FBQ08sZUFGNUI7QUFBQSxNQUdJYixVQUFVLEdBQUdNLEtBQUssQ0FBQ04sVUFIdkI7QUFBQSxNQUlJRCxXQUFXLEdBQUdPLEtBQUssQ0FBQ1AsV0FKeEI7QUFBQSxNQUtJNkIsS0FBSyxHQUFHdEIsS0FBSyxDQUFDc0IsS0FMbEI7QUFBQSxNQU1JQyxzQkFBc0IsR0FBR3ZCLEtBQUssQ0FBQ3VCLHNCQU5uQztBQU9BRCxFQUFBQSxLQUFLLENBQUNOLEtBQU4sQ0FBWSxLQUFLLENBQWpCLEVBQW9CakIsTUFBcEI7O0FBRUEsTUFBSXFCLEtBQUssSUFBSUcsc0JBQWIsRUFBcUM7QUFDbkMsUUFBSUMsbUJBQW1CLEdBQUdILGFBQWEsSUFBSUEsYUFBYSxFQUF4RDs7QUFFQSxRQUFJRyxtQkFBSixFQUF5QjtBQUN2QixhQUFPQSxtQkFBbUIsQ0FBQ1AsSUFBcEIsQ0FBeUIsVUFBVXhCLFdBQVYsRUFBdUI7QUFDckQsWUFBSUEsV0FBSixFQUFpQjtBQUNmLGdCQUFNQSxXQUFOO0FBQ0Q7O0FBRUQsZUFBT0ksYUFBYSxDQUFDQyxNQUFELEVBQVNDLE1BQVQsRUFBaUJDLEtBQWpCLENBQXBCO0FBQ0QsT0FOTSxFQU1KLE9BTkksRUFNSyxVQUFVUCxXQUFWLEVBQXVCO0FBQ2pDYyxRQUFBQSxlQUFlLENBQUNTLEtBQWhCLENBQXNCLEtBQUssQ0FBM0IsRUFBOEJqQixNQUE5Qjs7QUFFQSxZQUFJSSxZQUFKLEVBQWtCO0FBQ2hCQSxVQUFBQSxZQUFZLENBQUNWLFdBQUQsRUFBY1EsUUFBZCxFQUF3QixJQUF4QixFQUE4QkQsS0FBOUIsQ0FBWjtBQUNEOztBQUVELGVBQU95QixPQUFPLENBQUNDLE1BQVIsQ0FBZWpDLFdBQWYsQ0FBUDtBQUNELE9BZE0sQ0FBUDtBQWVELEtBaEJELE1BZ0JPO0FBQ0wsYUFBT0ksYUFBYSxDQUFDQyxNQUFELEVBQVNDLE1BQVQsRUFBaUJDLEtBQWpCLENBQXBCO0FBQ0Q7QUFDRixHQXRCRCxNQXNCTztBQUNMTyxJQUFBQSxlQUFlLENBQUNTLEtBQWhCLENBQXNCLEtBQUssQ0FBM0IsRUFBOEJqQixNQUE5QjtBQUNBLFFBQUllLE1BQU0sR0FBR3ZCLFdBQVcsQ0FBQztBQUN2QkUsTUFBQUEsV0FBVyxFQUFFQSxXQURVO0FBRXZCQyxNQUFBQSxVQUFVLEVBQUVBO0FBRlcsS0FBRCxDQUF4Qjs7QUFLQSxRQUFJUyxZQUFKLEVBQWtCO0FBQ2hCQSxNQUFBQSxZQUFZLENBQUNXLE1BQUQsRUFBU2IsUUFBVCxFQUFtQixJQUFuQixFQUF5QkQsS0FBekIsQ0FBWjtBQUNEOztBQUVELFdBQU9jLE1BQVA7QUFDRDtBQUNGLENBN0NEOztBQStDQSxJQUFJYSxRQUFRLEdBQUdSLFlBQWY7QUFDQWpDLE9BQU8sQ0FBQyxTQUFELENBQVAsR0FBcUJ5QyxRQUFyQiIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG52YXIgX2ludGVyb3BSZXF1aXJlRGVmYXVsdCA9IHJlcXVpcmUoXCJAYmFiZWwvcnVudGltZS9oZWxwZXJzL2ludGVyb3BSZXF1aXJlRGVmYXVsdFwiKTtcblxuZXhwb3J0cy5fX2VzTW9kdWxlID0gdHJ1ZTtcbmV4cG9ydHNbXCJkZWZhdWx0XCJdID0gdm9pZCAwO1xuXG52YXIgX2V4dGVuZHMyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiQGJhYmVsL3J1bnRpbWUvaGVscGVycy9leHRlbmRzXCIpKTtcblxudmFyIF9pc1Byb21pc2UgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJpcy1wcm9taXNlXCIpKTtcblxudmFyIF9TdWJtaXNzaW9uRXJyb3IgPSByZXF1aXJlKFwiLi9TdWJtaXNzaW9uRXJyb3JcIik7XG5cbnZhciBtZXJnZUVycm9ycyA9IGZ1bmN0aW9uIG1lcmdlRXJyb3JzKF9yZWYpIHtcbiAgdmFyIGFzeW5jRXJyb3JzID0gX3JlZi5hc3luY0Vycm9ycyxcbiAgICAgIHN5bmNFcnJvcnMgPSBfcmVmLnN5bmNFcnJvcnM7XG4gIHJldHVybiBhc3luY0Vycm9ycyAmJiB0eXBlb2YgYXN5bmNFcnJvcnMubWVyZ2UgPT09ICdmdW5jdGlvbicgPyBhc3luY0Vycm9ycy5tZXJnZShzeW5jRXJyb3JzKS50b0pTKCkgOiAoMCwgX2V4dGVuZHMyW1wiZGVmYXVsdFwiXSkoe30sIGFzeW5jRXJyb3JzLCB7fSwgc3luY0Vycm9ycyk7XG59O1xuXG52YXIgZXhlY3V0ZVN1Ym1pdCA9IGZ1bmN0aW9uIGV4ZWN1dGVTdWJtaXQoc3VibWl0LCBmaWVsZHMsIHByb3BzKSB7XG4gIHZhciBkaXNwYXRjaCA9IHByb3BzLmRpc3BhdGNoLFxuICAgICAgc3VibWl0QXNTaWRlRWZmZWN0ID0gcHJvcHMuc3VibWl0QXNTaWRlRWZmZWN0LFxuICAgICAgb25TdWJtaXRGYWlsID0gcHJvcHMub25TdWJtaXRGYWlsLFxuICAgICAgb25TdWJtaXRTdWNjZXNzID0gcHJvcHMub25TdWJtaXRTdWNjZXNzLFxuICAgICAgc3RhcnRTdWJtaXQgPSBwcm9wcy5zdGFydFN1Ym1pdCxcbiAgICAgIHN0b3BTdWJtaXQgPSBwcm9wcy5zdG9wU3VibWl0LFxuICAgICAgc2V0U3VibWl0RmFpbGVkID0gcHJvcHMuc2V0U3VibWl0RmFpbGVkLFxuICAgICAgc2V0U3VibWl0U3VjY2VlZGVkID0gcHJvcHMuc2V0U3VibWl0U3VjY2VlZGVkLFxuICAgICAgdmFsdWVzID0gcHJvcHMudmFsdWVzO1xuICB2YXIgcmVzdWx0O1xuXG4gIHRyeSB7XG4gICAgcmVzdWx0ID0gc3VibWl0KHZhbHVlcywgZGlzcGF0Y2gsIHByb3BzKTtcbiAgfSBjYXRjaCAoc3VibWl0RXJyb3IpIHtcbiAgICB2YXIgZXJyb3IgPSAoMCwgX1N1Ym1pc3Npb25FcnJvci5pc1N1Ym1pc3Npb25FcnJvcikoc3VibWl0RXJyb3IpID8gc3VibWl0RXJyb3IuZXJyb3JzIDogdW5kZWZpbmVkO1xuICAgIHN0b3BTdWJtaXQoZXJyb3IpO1xuICAgIHNldFN1Ym1pdEZhaWxlZC5hcHBseSh2b2lkIDAsIGZpZWxkcyk7XG5cbiAgICBpZiAob25TdWJtaXRGYWlsKSB7XG4gICAgICBvblN1Ym1pdEZhaWwoZXJyb3IsIGRpc3BhdGNoLCBzdWJtaXRFcnJvciwgcHJvcHMpO1xuICAgIH1cblxuICAgIGlmIChlcnJvciB8fCBvblN1Ym1pdEZhaWwpIHtcbiAgICAgIC8vIGlmIHlvdSd2ZSBwcm92aWRlZCBhbiBvblN1Ym1pdEZhaWwgY2FsbGJhY2ssIGRvbid0IHJlLXRocm93IHRoZSBlcnJvclxuICAgICAgcmV0dXJuIGVycm9yO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBzdWJtaXRFcnJvcjtcbiAgICB9XG4gIH1cblxuICBpZiAoc3VibWl0QXNTaWRlRWZmZWN0KSB7XG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgZGlzcGF0Y2gocmVzdWx0KTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgaWYgKCgwLCBfaXNQcm9taXNlW1wiZGVmYXVsdFwiXSkocmVzdWx0KSkge1xuICAgICAgc3RhcnRTdWJtaXQoKTtcbiAgICAgIHJldHVybiByZXN1bHQudGhlbihmdW5jdGlvbiAoc3VibWl0UmVzdWx0KSB7XG4gICAgICAgIHN0b3BTdWJtaXQoKTtcbiAgICAgICAgc2V0U3VibWl0U3VjY2VlZGVkKCk7XG5cbiAgICAgICAgaWYgKG9uU3VibWl0U3VjY2Vzcykge1xuICAgICAgICAgIG9uU3VibWl0U3VjY2VzcyhzdWJtaXRSZXN1bHQsIGRpc3BhdGNoLCBwcm9wcyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gc3VibWl0UmVzdWx0O1xuICAgICAgfSwgZnVuY3Rpb24gKHN1Ym1pdEVycm9yKSB7XG4gICAgICAgIHZhciBlcnJvciA9ICgwLCBfU3VibWlzc2lvbkVycm9yLmlzU3VibWlzc2lvbkVycm9yKShzdWJtaXRFcnJvcikgPyBzdWJtaXRFcnJvci5lcnJvcnMgOiB1bmRlZmluZWQ7XG4gICAgICAgIHN0b3BTdWJtaXQoZXJyb3IpO1xuICAgICAgICBzZXRTdWJtaXRGYWlsZWQuYXBwbHkodm9pZCAwLCBmaWVsZHMpO1xuXG4gICAgICAgIGlmIChvblN1Ym1pdEZhaWwpIHtcbiAgICAgICAgICBvblN1Ym1pdEZhaWwoZXJyb3IsIGRpc3BhdGNoLCBzdWJtaXRFcnJvciwgcHJvcHMpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGVycm9yIHx8IG9uU3VibWl0RmFpbCkge1xuICAgICAgICAgIC8vIGlmIHlvdSd2ZSBwcm92aWRlZCBhbiBvblN1Ym1pdEZhaWwgY2FsbGJhY2ssIGRvbid0IHJlLXRocm93IHRoZSBlcnJvclxuICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aHJvdyBzdWJtaXRFcnJvcjtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHNldFN1Ym1pdFN1Y2NlZWRlZCgpO1xuXG4gICAgICBpZiAob25TdWJtaXRTdWNjZXNzKSB7XG4gICAgICAgIG9uU3VibWl0U3VjY2VzcyhyZXN1bHQsIGRpc3BhdGNoLCBwcm9wcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn07XG5cbnZhciBoYW5kbGVTdWJtaXQgPSBmdW5jdGlvbiBoYW5kbGVTdWJtaXQoc3VibWl0LCBwcm9wcywgdmFsaWQsIGFzeW5jVmFsaWRhdGUsIGZpZWxkcykge1xuICB2YXIgZGlzcGF0Y2ggPSBwcm9wcy5kaXNwYXRjaCxcbiAgICAgIG9uU3VibWl0RmFpbCA9IHByb3BzLm9uU3VibWl0RmFpbCxcbiAgICAgIHNldFN1Ym1pdEZhaWxlZCA9IHByb3BzLnNldFN1Ym1pdEZhaWxlZCxcbiAgICAgIHN5bmNFcnJvcnMgPSBwcm9wcy5zeW5jRXJyb3JzLFxuICAgICAgYXN5bmNFcnJvcnMgPSBwcm9wcy5hc3luY0Vycm9ycyxcbiAgICAgIHRvdWNoID0gcHJvcHMudG91Y2gsXG4gICAgICBwZXJzaXN0ZW50U3VibWl0RXJyb3JzID0gcHJvcHMucGVyc2lzdGVudFN1Ym1pdEVycm9ycztcbiAgdG91Y2guYXBwbHkodm9pZCAwLCBmaWVsZHMpO1xuXG4gIGlmICh2YWxpZCB8fCBwZXJzaXN0ZW50U3VibWl0RXJyb3JzKSB7XG4gICAgdmFyIGFzeW5jVmFsaWRhdGVSZXN1bHQgPSBhc3luY1ZhbGlkYXRlICYmIGFzeW5jVmFsaWRhdGUoKTtcblxuICAgIGlmIChhc3luY1ZhbGlkYXRlUmVzdWx0KSB7XG4gICAgICByZXR1cm4gYXN5bmNWYWxpZGF0ZVJlc3VsdC50aGVuKGZ1bmN0aW9uIChhc3luY0Vycm9ycykge1xuICAgICAgICBpZiAoYXN5bmNFcnJvcnMpIHtcbiAgICAgICAgICB0aHJvdyBhc3luY0Vycm9ycztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBleGVjdXRlU3VibWl0KHN1Ym1pdCwgZmllbGRzLCBwcm9wcyk7XG4gICAgICB9KVtcImNhdGNoXCJdKGZ1bmN0aW9uIChhc3luY0Vycm9ycykge1xuICAgICAgICBzZXRTdWJtaXRGYWlsZWQuYXBwbHkodm9pZCAwLCBmaWVsZHMpO1xuXG4gICAgICAgIGlmIChvblN1Ym1pdEZhaWwpIHtcbiAgICAgICAgICBvblN1Ym1pdEZhaWwoYXN5bmNFcnJvcnMsIGRpc3BhdGNoLCBudWxsLCBwcm9wcyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QoYXN5bmNFcnJvcnMpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBleGVjdXRlU3VibWl0KHN1Ym1pdCwgZmllbGRzLCBwcm9wcyk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHNldFN1Ym1pdEZhaWxlZC5hcHBseSh2b2lkIDAsIGZpZWxkcyk7XG4gICAgdmFyIGVycm9ycyA9IG1lcmdlRXJyb3JzKHtcbiAgICAgIGFzeW5jRXJyb3JzOiBhc3luY0Vycm9ycyxcbiAgICAgIHN5bmNFcnJvcnM6IHN5bmNFcnJvcnNcbiAgICB9KTtcblxuICAgIGlmIChvblN1Ym1pdEZhaWwpIHtcbiAgICAgIG9uU3VibWl0RmFpbChlcnJvcnMsIGRpc3BhdGNoLCBudWxsLCBwcm9wcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVycm9ycztcbiAgfVxufTtcblxudmFyIF9kZWZhdWx0ID0gaGFuZGxlU3VibWl0O1xuZXhwb3J0c1tcImRlZmF1bHRcIl0gPSBfZGVmYXVsdDsiXX0=