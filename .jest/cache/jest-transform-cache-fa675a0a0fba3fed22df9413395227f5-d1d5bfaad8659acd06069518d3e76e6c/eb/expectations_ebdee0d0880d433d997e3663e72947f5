5a78bf87b93cc3b1b183e6a2ce469413
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createEffectExpectation = createEffectExpectation;
exports.createReturnExpectation = createReturnExpectation;
exports.createStoreStateExpectation = createStoreStateExpectation;
exports.createErrorExpectation = createErrorExpectation;

var _utilInspect = _interopRequireDefault(require("util-inspect"));

var _lodash = _interopRequireDefault(require("lodash.ismatch"));

var _lodash2 = _interopRequireDefault(require("lodash.isequal"));

var _SagaTestError = _interopRequireDefault(require("../shared/SagaTestError"));

var _serializeEffect = _interopRequireDefault(require("../shared/serializeEffect"));

var _reportActualEffects = _interopRequireDefault(require("./reportActualEffects"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function createEffectExpectation(_ref) {
  var effectName = _ref.effectName,
      expectedEffect = _ref.expectedEffect,
      storeKey = _ref.storeKey,
      like = _ref.like,
      extractEffect = _ref.extractEffect,
      store = _ref.store,
      expected = _ref.expected;
  return function () {
    var deleted = like ? store.deleteBy(function (item) {
      return (0, _lodash.default)(extractEffect(item), expectedEffect);
    }) : store.delete(expectedEffect);
    var errorMessage = '';

    if (deleted && !expected) {
      var serializedEffect = (0, _serializeEffect.default)(expectedEffect, storeKey);
      errorMessage = "\n" + effectName + " expectation unmet:" + ("\n\nNot Expected\n------------\n" + serializedEffect + "\n");
    } else if (!deleted && expected) {
      var _serializedEffect = (0, _serializeEffect.default)(expectedEffect, storeKey);

      errorMessage = "\n" + effectName + " expectation unmet:" + ("\n\nExpected\n--------\n" + _serializedEffect + "\n");
      errorMessage += (0, _reportActualEffects.default)(store, storeKey, effectName);
    }

    if (errorMessage) {
      throw new _SagaTestError.default(errorMessage);
    }
  };
}

function createReturnExpectation(_ref2) {
  var value = _ref2.value,
      expected = _ref2.expected;
  return function (_ref3) {
    var returnValue = _ref3.returnValue;

    if (expected && !(0, _lodash2.default)(value, returnValue)) {
      var serializedActual = (0, _utilInspect.default)(returnValue, {
        depth: 3
      });
      var serializedExpected = (0, _utilInspect.default)(value, {
        depth: 3
      });
      var errorMessage = "\nExpected to return:\n-------------------\n" + serializedExpected + "\n\nBut returned instead:\n---------------------\n" + serializedActual + "\n";
      throw new _SagaTestError.default(errorMessage);
    } else if (!expected && (0, _lodash2.default)(value, returnValue)) {
      var _serializedExpected = (0, _utilInspect.default)(value, {
        depth: 3
      });

      var _errorMessage = "\nDid not expect to return:\n-------------------------\n" + _serializedExpected + "\n";

      throw new _SagaTestError.default(_errorMessage);
    }
  };
}

function createStoreStateExpectation(_ref4) {
  var expectedState = _ref4.state,
      expected = _ref4.expected;
  return function (_ref5) {
    var storeState = _ref5.storeState;

    if (expected && !(0, _lodash2.default)(expectedState, storeState)) {
      var serializedActual = (0, _utilInspect.default)(storeState, {
        depth: 3
      });
      var serializedExpected = (0, _utilInspect.default)(expectedState, {
        depth: 3
      });
      var errorMessage = "\nExpected to have final store state:\n-----------------------------------\n" + serializedExpected + "\n\nBut instead had final store state:\n----------------------------------\n" + serializedActual + "\n";
      throw new _SagaTestError.default(errorMessage);
    } else if (!expected && (0, _lodash2.default)(expectedState, storeState)) {
      var _serializedExpected2 = (0, _utilInspect.default)(expectedState, {
        depth: 3
      });

      var _errorMessage2 = "\nExpected to not have final store state:\n---------------------------------------\n" + _serializedExpected2 + "\n";

      throw new _SagaTestError.default(_errorMessage2);
    }
  };
}

function createErrorExpectation(_ref6) {
  var type = _ref6.type,
      expected = _ref6.expected;
  return function (_ref7) {
    var errorValue = _ref7.errorValue;
    var serializedExpected = typeof type;

    if (typeof type === 'object') {
      serializedExpected = (0, _utilInspect.default)(type, {
        depth: 3
      });
    } else if (typeof type === 'function') {
      serializedExpected = type.name;
    }

    var matches = function matches() {
      return typeof type === 'object' && (0, _lodash2.default)(type, errorValue) || typeof type === 'function' && errorValue instanceof type;
    };

    if (!expected) {
      if (typeof errorValue === 'undefined' || !matches()) return;
      throw new _SagaTestError.default("\nExpected not to throw:\n----------------------\n" + serializedExpected + "\n");
    } else if (typeof errorValue === 'undefined') {
      throw new _SagaTestError.default("\nExpected to throw:\n-------------------\n" + serializedExpected + "\n\nBut no error thrown\n---------------------\n");
    } else if (typeof type === 'object' && !matches()) {
      var serializedActual = (0, _utilInspect.default)(errorValue, {
        depth: 3
      });
      throw new _SagaTestError.default("\nExpected to throw:\n-------------------\n" + serializedExpected + "\n\nBut instead threw:\n---------------------\n" + serializedActual + "\n");
    } else if (typeof type === 'function' && !matches()) {
      var _serializedActual = typeof errorValue === 'function' ? errorValue.constructor.name : typeof errorValue;

      throw new _SagaTestError.default("\nExpected to throw error of type:\n--------------------------------\n" + serializedExpected + "\n\nBut instead threw:\n--------------------------------\n" + _serializedActual + "\n");
    }
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV4cGVjdGF0aW9ucy5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImNyZWF0ZUVmZmVjdEV4cGVjdGF0aW9uIiwiY3JlYXRlUmV0dXJuRXhwZWN0YXRpb24iLCJjcmVhdGVTdG9yZVN0YXRlRXhwZWN0YXRpb24iLCJjcmVhdGVFcnJvckV4cGVjdGF0aW9uIiwiX3V0aWxJbnNwZWN0IiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfbG9kYXNoIiwiX2xvZGFzaDIiLCJfU2FnYVRlc3RFcnJvciIsIl9zZXJpYWxpemVFZmZlY3QiLCJfcmVwb3J0QWN0dWFsRWZmZWN0cyIsIm9iaiIsIl9fZXNNb2R1bGUiLCJkZWZhdWx0IiwiZWZmZWN0TmFtZSIsImV4cGVjdGVkRWZmZWN0Iiwic3RvcmVLZXkiLCJsaWtlIiwiZXh0cmFjdEVmZmVjdCIsInN0b3JlIiwiZXhwZWN0ZWQiLCJkZWxldGVkIiwiZGVsZXRlQnkiLCJpdGVtIiwiZGVsZXRlIiwiZXJyb3JNZXNzYWdlIiwic2VyaWFsaXplZEVmZmVjdCIsInJldHVyblZhbHVlIiwic2VyaWFsaXplZEFjdHVhbCIsImRlcHRoIiwic2VyaWFsaXplZEV4cGVjdGVkIiwiZXhwZWN0ZWRTdGF0ZSIsInN0YXRlIiwic3RvcmVTdGF0ZSIsInR5cGUiLCJlcnJvclZhbHVlIiwibmFtZSIsIm1hdGNoZXMiLCJjb25zdHJ1Y3RvciJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBRUFBLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkMsT0FBdEIsRUFBK0IsWUFBL0IsRUFBNkM7QUFDM0NDLEVBQUFBLEtBQUssRUFBRTtBQURvQyxDQUE3QztBQUdBRCxPQUFPLENBQUNFLHVCQUFSLEdBQWtDQSx1QkFBbEM7QUFDQUYsT0FBTyxDQUFDRyx1QkFBUixHQUFrQ0EsdUJBQWxDO0FBQ0FILE9BQU8sQ0FBQ0ksMkJBQVIsR0FBc0NBLDJCQUF0QztBQUNBSixPQUFPLENBQUNL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bkQsVUFBTVQsaUJBQWdCLEdBQUcsT0FBT08sVUFBUCxLQUFzQixVQUF0QixHQUFtQ0EsVUFBVSxDQUFDRyxXQUFYLENBQXVCRixJQUExRCxHQUFpRSxPQUFPRCxVQUFqRzs7QUFDQSxZQUFNLElBQUkzQixjQUFjLENBQUNLLE9BQW5CLDRFQUdWaUIsa0JBSFUsa0VBT1ZGLGlCQVBVLFFBQU47QUFTRDtBQUNGLEdBeEREO0FBeUREIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLmNyZWF0ZUVmZmVjdEV4cGVjdGF0aW9uID0gY3JlYXRlRWZmZWN0RXhwZWN0YXRpb247XG5leHBvcnRzLmNyZWF0ZVJldHVybkV4cGVjdGF0aW9uID0gY3JlYXRlUmV0dXJuRXhwZWN0YXRpb247XG5leHBvcnRzLmNyZWF0ZVN0b3JlU3RhdGVFeHBlY3RhdGlvbiA9IGNyZWF0ZVN0b3JlU3RhdGVFeHBlY3RhdGlvbjtcbmV4cG9ydHMuY3JlYXRlRXJyb3JFeHBlY3RhdGlvbiA9IGNyZWF0ZUVycm9yRXhwZWN0YXRpb247XG5cbnZhciBfdXRpbEluc3BlY3QgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJ1dGlsLWluc3BlY3RcIikpO1xuXG52YXIgX2xvZGFzaCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcImxvZGFzaC5pc21hdGNoXCIpKTtcblxudmFyIF9sb2Rhc2gyID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwibG9kYXNoLmlzZXF1YWxcIikpO1xuXG52YXIgX1NhZ2FUZXN0RXJyb3IgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuLi9zaGFyZWQvU2FnYVRlc3RFcnJvclwiKSk7XG5cbnZhciBfc2VyaWFsaXplRWZmZWN0ID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwiLi4vc2hhcmVkL3NlcmlhbGl6ZUVmZmVjdFwiKSk7XG5cbnZhciBfcmVwb3J0QWN0dWFsRWZmZWN0cyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcIi4vcmVwb3J0QWN0dWFsRWZmZWN0c1wiKSk7XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7IHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7IGRlZmF1bHQ6IG9iaiB9OyB9XG5cbmZ1bmN0aW9uIGNyZWF0ZUVmZmVjdEV4cGVjdGF0aW9uKHtcbiAgZWZmZWN0TmFtZSxcbiAgZXhwZWN0ZWRFZmZlY3QsXG4gIHN0b3JlS2V5LFxuICBsaWtlLFxuICBleHRyYWN0RWZmZWN0LFxuICBzdG9yZSxcbiAgZXhwZWN0ZWRcbn0pIHtcbiAgcmV0dXJuICgpID0+IHtcbiAgICBjb25zdCBkZWxldGVkID0gbGlrZSA/IHN0b3JlLmRlbGV0ZUJ5KGl0ZW0gPT4gKDAsIF9sb2Rhc2guZGVmYXVsdCkoZXh0cmFjdEVmZmVjdChpdGVtKSwgZXhwZWN0ZWRFZmZlY3QpKSA6IHN0b3JlLmRlbGV0ZShleHBlY3RlZEVmZmVjdCk7XG4gICAgbGV0IGVycm9yTWVzc2FnZSA9ICcnO1xuXG4gICAgaWYgKGRlbGV0ZWQgJiYgIWV4cGVjdGVkKSB7XG4gICAgICBjb25zdCBzZXJpYWxpemVkRWZmZWN0ID0gKDAsIF9zZXJpYWxpemVFZmZlY3QuZGVmYXVsdCkoZXhwZWN0ZWRFZmZlY3QsIHN0b3JlS2V5KTtcbiAgICAgIGVycm9yTWVzc2FnZSA9IGBcXG4ke2VmZmVjdE5hbWV9IGV4cGVjdGF0aW9uIHVubWV0OmAgKyBgXFxuXFxuTm90IEV4cGVjdGVkXFxuLS0tLS0tLS0tLS0tXFxuJHtzZXJpYWxpemVkRWZmZWN0fVxcbmA7XG4gICAgfSBlbHNlIGlmICghZGVsZXRlZCAmJiBleHBlY3RlZCkge1xuICAgICAgY29uc3Qgc2VyaWFsaXplZEVmZmVjdCA9ICgwLCBfc2VyaWFsaXplRWZmZWN0LmRlZmF1bHQpKGV4cGVjdGVkRWZmZWN0LCBzdG9yZUtleSk7XG4gICAgICBlcnJvck1lc3NhZ2UgPSBgXFxuJHtlZmZlY3ROYW1lfSBleHBlY3RhdGlvbiB1bm1ldDpgICsgYFxcblxcbkV4cGVjdGVkXFxuLS0tLS0tLS1cXG4ke3NlcmlhbGl6ZWRFZmZlY3R9XFxuYDtcbiAgICAgIGVycm9yTWVzc2FnZSArPSAoMCwgX3JlcG9ydEFjdHVhbEVmZmVjdHMuZGVmYXVsdCkoc3RvcmUsIHN0b3JlS2V5LCBlZmZlY3ROYW1lKTtcbiAgICB9XG5cbiAgICBpZiAoZXJyb3JNZXNzYWdlKSB7XG4gICAgICB0aHJvdyBuZXcgX1NhZ2FUZXN0RXJyb3IuZGVmYXVsdChlcnJvck1lc3NhZ2UpO1xuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlUmV0dXJuRXhwZWN0YXRpb24oe1xuICB2YWx1ZSxcbiAgZXhwZWN0ZWRcbn0pIHtcbiAgcmV0dXJuICh7XG4gICAgcmV0dXJuVmFsdWVcbiAgfSkgPT4ge1xuICAgIGlmIChleHBlY3RlZCAmJiAhKDAsIF9sb2Rhc2gyLmRlZmF1bHQpKHZhbHVlLCByZXR1cm5WYWx1ZSkpIHtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWRBY3R1YWwgPSAoMCwgX3V0aWxJbnNwZWN0LmRlZmF1bHQpKHJldHVyblZhbHVlLCB7XG4gICAgICAgIGRlcHRoOiAzXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWRFeHBlY3RlZCA9ICgwLCBfdXRpbEluc3BlY3QuZGVmYXVsdCkodmFsdWUsIHtcbiAgICAgICAgZGVwdGg6IDNcbiAgICAgIH0pO1xuICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gYFxuRXhwZWN0ZWQgdG8gcmV0dXJuOlxuLS0tLS0tLS0tLS0tLS0tLS0tLVxuJHtzZXJpYWxpemVkRXhwZWN0ZWR9XG5cbkJ1dCByZXR1cm5lZCBpbnN0ZWFkOlxuLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4ke3NlcmlhbGl6ZWRBY3R1YWx9XG5gO1xuICAgICAgdGhyb3cgbmV3IF9TYWdhVGVzdEVycm9yLmRlZmF1bHQoZXJyb3JNZXNzYWdlKTtcbiAgICB9IGVsc2UgaWYgKCFleHBlY3RlZCAmJiAoMCwgX2xvZGFzaDIuZGVmYXVsdCkodmFsdWUsIHJldHVyblZhbHVlKSkge1xuICAgICAgY29uc3Qgc2VyaWFsaXplZEV4cGVjdGVkID0gKDAsIF91dGlsSW5zcGVjdC5kZWZhdWx0KSh2YWx1ZSwge1xuICAgICAgICBkZXB0aDogM1xuICAgICAgfSk7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgXG5EaWQgbm90IGV4cGVjdCB0byByZXR1cm46XG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4ke3NlcmlhbGl6ZWRFeHBlY3RlZH1cbmA7XG4gICAgICB0aHJvdyBuZXcgX1NhZ2FUZXN0RXJyb3IuZGVmYXVsdChlcnJvck1lc3NhZ2UpO1xuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU3RvcmVTdGF0ZUV4cGVjdGF0aW9uKHtcbiAgc3RhdGU6IGV4cGVjdGVkU3RhdGUsXG4gIGV4cGVjdGVkXG59KSB7XG4gIHJldHVybiAoe1xuICAgIHN0b3JlU3RhdGVcbiAgfSkgPT4ge1xuICAgIGlmIChleHBlY3RlZCAmJiAhKDAsIF9sb2Rhc2gyLmRlZmF1bHQpKGV4cGVjdGVkU3RhdGUsIHN0b3JlU3RhdGUpKSB7XG4gICAgICBjb25zdCBzZXJpYWxpemVkQWN0dWFsID0gKDAsIF91dGlsSW5zcGVjdC5kZWZhdWx0KShzdG9yZVN0YXRlLCB7XG4gICAgICAgIGRlcHRoOiAzXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWRFeHBlY3RlZCA9ICgwLCBfdXRpbEluc3BlY3QuZGVmYXVsdCkoZXhwZWN0ZWRTdGF0ZSwge1xuICAgICAgICBkZXB0aDogM1xuICAgICAgfSk7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgXG5FeHBlY3RlZCB0byBoYXZlIGZpbmFsIHN0b3JlIHN0YXRlOlxuLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiR7c2VyaWFsaXplZEV4cGVjdGVkfVxuXG5CdXQgaW5zdGVhZCBoYWQgZmluYWwgc3RvcmUgc3RhdGU6XG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4ke3NlcmlhbGl6ZWRBY3R1YWx9XG5gO1xuICAgICAgdGhyb3cgbmV3IF9TYWdhVGVzdEVycm9yLmRlZmF1bHQoZXJyb3JNZXNzYWdlKTtcbiAgICB9IGVsc2UgaWYgKCFleHBlY3RlZCAmJiAoMCwgX2xvZGFzaDIuZGVmYXVsdCkoZXhwZWN0ZWRTdGF0ZSwgc3RvcmVTdGF0ZSkpIHtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWRFeHBlY3RlZCA9ICgwLCBfdXRpbEluc3BlY3QuZGVmYXVsdCkoZXhwZWN0ZWRTdGF0ZSwge1xuICAgICAgICBkZXB0aDogM1xuICAgICAgfSk7XG4gICAgICBjb25zdCBlcnJvck1lc3NhZ2UgPSBgXG5FeHBlY3RlZCB0byBub3QgaGF2ZSBmaW5hbCBzdG9yZSBzdGF0ZTpcbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJHtzZXJpYWxpemVkRXhwZWN0ZWR9XG5gO1xuICAgICAgdGhyb3cgbmV3IF9TYWdhVGVzdEVycm9yLmRlZmF1bHQoZXJyb3JNZXNzYWdlKTtcbiAgICB9XG4gIH07XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUVycm9yRXhwZWN0YXRpb24oe1xuICB0eXBlLFxuICBleHBlY3RlZFxufSkge1xuICByZXR1cm4gKHtcbiAgICBlcnJvclZhbHVlXG4gIH0pID0+IHtcbiAgICBsZXQgc2VyaWFsaXplZEV4cGVjdGVkID0gdHlwZW9mIHR5cGU7XG5cbiAgICBpZiAodHlwZW9mIHR5cGUgPT09ICdvYmplY3QnKSB7XG4gICAgICBzZXJpYWxpemVkRXhwZWN0ZWQgPSAoMCwgX3V0aWxJbnNwZWN0LmRlZmF1bHQpKHR5cGUsIHtcbiAgICAgICAgZGVwdGg6IDNcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIHNlcmlhbGl6ZWRFeHBlY3RlZCA9IHR5cGUubmFtZTtcbiAgICB9XG5cbiAgICBjb25zdCBtYXRjaGVzID0gKCkgPT4gdHlwZW9mIHR5cGUgPT09ICdvYmplY3QnICYmICgwLCBfbG9kYXNoMi5kZWZhdWx0KSh0eXBlLCBlcnJvclZhbHVlKSB8fCB0eXBlb2YgdHlwZSA9PT0gJ2Z1bmN0aW9uJyAmJiBlcnJvclZhbHVlIGluc3RhbmNlb2YgdHlwZTtcblxuICAgIGlmICghZXhwZWN0ZWQpIHtcbiAgICAgIGlmICh0eXBlb2YgZXJyb3JWYWx1ZSA9PT0gJ3VuZGVmaW5lZCcgfHwgIW1hdGNoZXMoKSkgcmV0dXJuO1xuICAgICAgdGhyb3cgbmV3IF9TYWdhVGVzdEVycm9yLmRlZmF1bHQoYFxuRXhwZWN0ZWQgbm90IHRvIHRocm93OlxuLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJHtzZXJpYWxpemVkRXhwZWN0ZWR9XG5gKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiBlcnJvclZhbHVlID09PSAndW5kZWZpbmVkJykge1xuICAgICAgdGhyb3cgbmV3IF9TYWdhVGVzdEVycm9yLmRlZmF1bHQoYFxuRXhwZWN0ZWQgdG8gdGhyb3c6XG4tLS0tLS0tLS0tLS0tLS0tLS0tXG4ke3NlcmlhbGl6ZWRFeHBlY3RlZH1cblxuQnV0IG5vIGVycm9yIHRocm93blxuLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG5gKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAnb2JqZWN0JyAmJiAhbWF0Y2hlcygpKSB7XG4gICAgICBjb25zdCBzZXJpYWxpemVkQWN0dWFsID0gKDAsIF91dGlsSW5zcGVjdC5kZWZhdWx0KShlcnJvclZhbHVlLCB7XG4gICAgICAgIGRlcHRoOiAzXG4gICAgICB9KTtcbiAgICAgIHRocm93IG5ldyBfU2FnYVRlc3RFcnJvci5kZWZhdWx0KGBcbkV4cGVjdGVkIHRvIHRocm93OlxuLS0tLS0tLS0tLS0tLS0tLS0tLVxuJHtzZXJpYWxpemVkRXhwZWN0ZWR9XG5cbkJ1dCBpbnN0ZWFkIHRocmV3OlxuLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4ke3NlcmlhbGl6ZWRBY3R1YWx9XG5gKTtcbiAgICB9IGVsc2UgaWYgKHR5cGVvZiB0eXBlID09PSAnZnVuY3Rpb24nICYmICFtYXRjaGVzKCkpIHtcbiAgICAgIGNvbnN0IHNlcmlhbGl6ZWRBY3R1YWwgPSB0eXBlb2YgZXJyb3JWYWx1ZSA9PT0gJ2Z1bmN0aW9uJyA/IGVycm9yVmFsdWUuY29uc3RydWN0b3IubmFtZSA6IHR5cGVvZiBlcnJvclZhbHVlO1xuICAgICAgdGhyb3cgbmV3IF9TYWdhVGVzdEVycm9yLmRlZmF1bHQoYFxuRXhwZWN0ZWQgdG8gdGhyb3cgZXJyb3Igb2YgdHlwZTpcbi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4ke3NlcmlhbGl6ZWRFeHBlY3RlZH1cblxuQnV0IGluc3RlYWQgdGhyZXc6XG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuJHtzZXJpYWxpemVkQWN0dWFsfVxuYCk7XG4gICAgfVxuICB9O1xufSJdfQ==