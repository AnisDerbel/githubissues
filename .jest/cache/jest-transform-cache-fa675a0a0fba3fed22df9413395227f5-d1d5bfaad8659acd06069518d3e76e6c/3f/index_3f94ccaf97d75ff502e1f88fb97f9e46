52d03ddf5576545ddc8ccae6f0ec6461
"use strict";

var __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {
  if (k2 === undefined) k2 = k;
  Object.defineProperty(o, k2, {
    enumerable: true,
    get: function get() {
      return m[k];
    }
  });
} : function (o, m, k, k2) {
  if (k2 === undefined) k2 = k;
  o[k2] = m[k];
});

var __exportStar = this && this.__exportStar || function (m, exports) {
  for (var p in m) {
    if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
  }
};

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.DomHandler = void 0;

var node_1 = require("./node");

__exportStar(require("./node"), exports);

var reWhitespace = /\s+/g;
var defaultOpts = {
  normalizeWhitespace: false,
  withStartIndices: false,
  withEndIndices: false
};

var DomHandler = function () {
  function DomHandler(callback, options, elementCB) {
    this.dom = [];
    this.root = new node_1.Document(this.dom);
    this.done = false;
    this.tagStack = [this.root];
    this.lastNode = null;
    this.parser = null;

    if (typeof options === "function") {
      elementCB = options;
      options = defaultOpts;
    }

    if (typeof callback === "object") {
      options = callback;
      callback = undefined;
    }

    this.callback = callback !== null && callback !== void 0 ? callback : null;
    this.options = options !== null && options !== void 0 ? options : defaultOpts;
    this.elementCB = elementCB !== null && elementCB !== void 0 ? elementCB : null;
  }

  DomHandler.prototype.onparserinit = function (parser) {
    this.parser = parser;
  };

  DomHandler.prototype.onreset = function () {
    var _a;

    this.dom = [];
    this.root = new node_1.Document(this.dom);
    this.done = false;
    this.tagStack = [this.root];
    this.lastNode = null;
    this.parser = (_a = this.parser) !== null && _a !== void 0 ? _a : null;
  };

  DomHandler.prototype.onend = function () {
    if (this.done) return;
    this.done = true;
    this.parser = null;
    this.handleCallback(null);
  };

  DomHandler.prototype.onerror = function (error) {
    this.handleCallback(error);
  };

  DomHandler.prototype.onclosetag = function () {
    this.lastNode = null;
    var elem = this.tagStack.pop();

    if (this.options.withEndIndices) {
      elem.endIndex = this.parser.endIndex;
    }

    if (this.elementCB) this.elementCB(elem);
  };

  DomHandler.prototype.onopentag = function (name, attribs) {
    var element = new node_1.Element(name, attribs);
    this.addNode(element);
    this.tagStack.push(element);
  };

  DomHandler.prototype.ontext = function (data) {
    var normalizeWhitespace = this.options.normalizeWhitespace;
    var lastNode = this.lastNode;

    if (lastNode && lastNode.type === "text") {
        if (normalizeWhitespace) {
          lastNode.data = (lastNode.data + data).replace(reWhitespace, " ");
        } else {
          lastNode.data += data;
        }
      } else {
      if (normalizeWhitespace) {
        data = data.replace(reWhitespace, " ");
      }

      var node = new node_1.Text(data);
      this.addNode(node);
      this.lastNode = node;
    }
  };

  DomHandler.prototype.oncomment = function (data) {
    if (this.lastNode && this.lastNode.type === "comment") {
        this.lastNode.data += data;
        return;
      }

    var node = new node_1.Comment(data);
    this.addNode(node);
    this.lastNode = node;
  };

  DomHandler.prototype.oncommentend = function () {
    this.lastNode = null;
  };

  DomHandler.prototype.oncdatastart = function () {
    var text = new node_1.Text("");
    var node = new node_1.NodeWithChildren("cdata", [text]);
    this.addNode(node);
    text.parent = node;
    this.lastNode = text;
  };

  DomHandler.prototype.oncdataend = function () {
    this.lastNode = null;
  };

  DomHandler.prototype.onprocessinginstruction = function (name, data) {
    var node = new node_1.ProcessingInstruction(name, data);
    this.addNode(node);
  };

  DomHandler.prototype.handleCallback = function (error) {
    if (typeof this.callback === "function") {
      this.callback(error, this.dom);
    } else if (error) {
      throw error;
    }
  };

  DomHandler.prototype.addNode = function (node) {
    var parent = this.tagStack[this.tagStack.length - 1];
    var previousSibling = parent.children[parent.children.length - 1];

    if (this.options.withStartIndices) {
      node.startIndex = this.parser.startIndex;
    }

    if (this.options.withEndIndices) {
      node.endIndex = this.parser.endIndex;
    }

    parent.children.push(node);

    if (previousSibling) {
      node.prev = previousSibling;
      previousSibling.next = node;
    }

    node.parent = parent;
    this.lastNode = null;
  };

  DomHandler.prototype.addDataNode = function (node) {
    this.addNode(node);
    this.lastNode = node;
  };

  return DomHandler;
}();

exports.DomHandler = DomHandler;
exports.default = DomHandler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIl9fY3JlYXRlQmluZGluZyIsIk9iamVjdCIsImNyZWF0ZSIsIm8iLCJtIiwiayIsImsyIiwidW5kZWZpbmVkIiwiZGVmaW5lUHJvcGVydHkiLCJlbnVtZXJhYmxlIiwiZ2V0IiwiX19leHBvcnRTdGFyIiwiZXhwb3J0cyIsInAiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJ2YWx1ZSIsIkRvbUhhbmRsZXIiLCJub2RlXzEiLCJyZXF1aXJlIiwicmVXaGl0ZXNwYWNlIiwiZGVmYXVsdE9wdHMiLCJub3JtYWxpemVXaGl0ZXNwYWNlIiwid2l0aFN0YXJ0SW5kaWNlcyIsIndpdGhFbmRJbmRpY2VzIiwiY2FsbGJhY2siLCJvcHRpb25zIiwiZWxlbWVudENCIiwiZG9tIiwicm9vdCIsIkRvY3VtZW50IiwiZG9uZSIsInRhZ1N0YWNrIiwibGFzdE5vZGUiLCJwYXJzZXIiLCJvbnBhcnNlcmluaXQiLCJvbnJlc2V0IiwiX2EiLCJvbmVuZCIsImhhbmRsZUNhbGxiYWNrIiwib25lcnJvciIsImVycm9yIiwib25jbG9zZXRhZyIsImVsZW0iLCJwb3AiLCJlbmRJbmRleCIsIm9ub3BlbnRhZyIsIm5hbWUiLCJhdHRyaWJzIiwiZWxlbWVudCIsIkVsZW1lbnQiLCJhZGROb2RlIiwicHVzaCIsIm9udGV4dCIsImRhdGEiLCJ0eXBlIiwicmVwbGFjZSIsIm5vZGUiLCJUZXh0Iiwib25jb21tZW50IiwiQ29tbWVudCIsIm9uY29tbWVudGVuZCIsIm9uY2RhdGFzdGFydCIsInRleHQiLCJOb2RlV2l0aENoaWxkcmVuIiwicGFyZW50Iiwib25jZGF0YWVuZCIsIm9ucHJvY2Vzc2luZ2luc3RydWN0aW9uIiwiUHJvY2Vzc2luZ0luc3RydWN0aW9uIiwibGVuZ3RoIiwicHJldmlvdXNTaWJsaW5nIiwiY2hpbGRyZW4iLCJzdGFydEluZGV4IiwicHJldiIsIm5leHQiLCJhZGREYXRhTm9kZSIsImRlZmF1bHQiXSwibWFw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TSxRQUFQLENBQWdCRixNQUFoQixHQUF5QixDQUF6QyxDQUF0Qjs7QUFDQSxRQUFJLEtBQUszQyxPQUFMLENBQWFILGdCQUFqQixFQUFtQztBQUMvQmtDLE1BQUFBLElBQUksQ0FBQ2UsVUFBTCxHQUFrQixLQUFLdEMsTUFBTCxDQUFZc0MsVUFBOUI7QUFDSDs7QUFDRCxRQUFJLEtBQUs5QyxPQUFMLENBQWFGLGNBQWpCLEVBQWlDO0FBQzdCaUMsTUFBQUEsSUFBSSxDQUFDWixRQUFMLEdBQWdCLEtBQUtYLE1BQUwsQ0FBWVcsUUFBNUI7QUFDSDs7QUFDRG9CLElBQUFBLE1BQU0sQ0FBQ00sUUFBUCxDQUFnQm5CLElBQWhCLENBQXFCSyxJQUFyQjs7QUFDQSxRQUFJYSxlQUFKLEVBQXFCO0FBQ2pCYixNQUFBQSxJQUFJLENBQUNnQixJQUFMLEdBQVlILGVBQVo7QUFDQUEsTUFBQUEsZUFBZSxDQUFDSSxJQUFoQixHQUF1QmpCLElBQXZCO0FBQ0g7O0FBQ0RBLElBQUFBLElBQUksQ0FBQ1EsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS2hDLFFBQUwsR0FBZ0IsSUFBaEI7QUFDSCxHQWhCRDs7QUFpQkFoQixFQUFBQSxVQUFVLENBQUNKLFNBQVgsQ0FBcUI4RCxXQUFyQixHQUFtQyxVQUFVbEIsSUFBVixFQUFnQjtBQUMvQyxTQUFLTixPQUFMLENBQWFNLElBQWI7QUFDQSxTQUFLeEIsUUFBTCxHQUFnQndCLElBQWhCO0FBQ0gsR0FIRDs7QUFJQSxTQUFPeEMsVUFBUDtBQUNILENBbEorQixFQUFoQzs7QUFtSkFOLE9BQU8sQ0FBQ00sVUFBUixHQUFxQkEsVUFBckI7QUFDQU4sT0FBTyxDQUFDaUUsT0FBUixHQUFrQjNELFVBQWxCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19jcmVhdGVCaW5kaW5nID0gKHRoaXMgJiYgdGhpcy5fX2NyZWF0ZUJpbmRpbmcpIHx8IChPYmplY3QuY3JlYXRlID8gKGZ1bmN0aW9uKG8sIG0sIGssIGsyKSB7XG4gICAgaWYgKGsyID09PSB1bmRlZmluZWQpIGsyID0gaztcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobywgazIsIHsgZW51bWVyYWJsZTogdHJ1ZSwgZ2V0OiBmdW5jdGlvbigpIHsgcmV0dXJuIG1ba107IH0gfSk7XG59KSA6IChmdW5jdGlvbihvLCBtLCBrLCBrMikge1xuICAgIGlmIChrMiA9PT0gdW5kZWZpbmVkKSBrMiA9IGs7XG4gICAgb1trMl0gPSBtW2tdO1xufSkpO1xudmFyIF9fZXhwb3J0U3RhciA9ICh0aGlzICYmIHRoaXMuX19leHBvcnRTdGFyKSB8fCBmdW5jdGlvbihtLCBleHBvcnRzKSB7XG4gICAgZm9yICh2YXIgcCBpbiBtKSBpZiAocCAhPT0gXCJkZWZhdWx0XCIgJiYgIU9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChleHBvcnRzLCBwKSkgX19jcmVhdGVCaW5kaW5nKGV4cG9ydHMsIG0sIHApO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmV4cG9ydHMuRG9tSGFuZGxlciA9IHZvaWQgMDtcbnZhciBub2RlXzEgPSByZXF1aXJlKFwiLi9ub2RlXCIpO1xuX19leHBvcnRTdGFyKHJlcXVpcmUoXCIuL25vZGVcIiksIGV4cG9ydHMpO1xudmFyIHJlV2hpdGVzcGFjZSA9IC9cXHMrL2c7XG4vLyBEZWZhdWx0IG9wdGlvbnNcbnZhciBkZWZhdWx0T3B0cyA9IHtcbiAgICBub3JtYWxpemVXaGl0ZXNwYWNlOiBmYWxzZSxcbiAgICB3aXRoU3RhcnRJbmRpY2VzOiBmYWxzZSxcbiAgICB3aXRoRW5kSW5kaWNlczogZmFsc2UsXG59O1xudmFyIERvbUhhbmRsZXIgPSAvKiogQGNsYXNzICovIChmdW5jdGlvbiAoKSB7XG4gICAgLyoqXG4gICAgICogQHBhcmFtIGNhbGxiYWNrIENhbGxlZCBvbmNlIHBhcnNpbmcgaGFzIGNvbXBsZXRlZC5cbiAgICAgKiBAcGFyYW0gb3B0aW9ucyBTZXR0aW5ncyBmb3IgdGhlIGhhbmRsZXIuXG4gICAgICogQHBhcmFtIGVsZW1lbnRDQiBDYWxsYmFjayB3aGVuZXZlciBhIHRhZyBpcyBjbG9zZWQuXG4gICAgICovXG4gICAgZnVuY3Rpb24gRG9tSGFuZGxlcihjYWxsYmFjaywgb3B0aW9ucywgZWxlbWVudENCKSB7XG4gICAgICAgIC8qKiBUaGUgZWxlbWVudHMgb2YgdGhlIERPTSAqL1xuICAgICAgICB0aGlzLmRvbSA9IFtdO1xuICAgICAgICAvKiogVGhlIHJvb3QgZWxlbWVudCBmb3IgdGhlIERPTSAqL1xuICAgICAgICB0aGlzLnJvb3QgPSBuZXcgbm9kZV8xLkRvY3VtZW50KHRoaXMuZG9tKTtcbiAgICAgICAgLyoqIEluZGljYXRlZCB3aGV0aGVyIHBhcnNpbmcgaGFzIGJlZW4gY29tcGxldGVkLiAqL1xuICAgICAgICB0aGlzLmRvbmUgPSBmYWxzZTtcbiAgICAgICAgLyoqIFN0YWNrIG9mIG9wZW4gdGFncy4gKi9cbiAgICAgICAgdGhpcy50YWdTdGFjayA9IFt0aGlzLnJvb3RdO1xuICAgICAgICAvKiogQSBkYXRhIG5vZGUgdGhhdCBpcyBzdGlsbCBiZWluZyB3cml0dGVuIHRvLiAqL1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICAgICAgLyoqIFJlZmVyZW5jZSB0byB0aGUgcGFyc2VyIGluc3RhbmNlLiBVc2VkIGZvciBsb2NhdGlvbiBpbmZvcm1hdGlvbi4gKi9cbiAgICAgICAgdGhpcy5wYXJzZXIgPSBudWxsO1xuICAgICAgICAvLyBNYWtlIGl0IHBvc3NpYmxlIHRvIHNraXAgYXJndW1lbnRzLCBmb3IgYmFja3dhcmRzLWNvbXBhdGliaWxpdHlcbiAgICAgICAgaWYgKHR5cGVvZiBvcHRpb25zID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIGVsZW1lbnRDQiA9IG9wdGlvbnM7XG4gICAgICAgICAgICBvcHRpb25zID0gZGVmYXVsdE9wdHM7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBjYWxsYmFjayA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgb3B0aW9ucyA9IGNhbGxiYWNrO1xuICAgICAgICAgICAgY2FsbGJhY2sgPSB1bmRlZmluZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5jYWxsYmFjayA9IGNhbGxiYWNrICE9PSBudWxsICYmIGNhbGxiYWNrICE9PSB2b2lkIDAgPyBjYWxsYmFjayA6IG51bGw7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgIT09IG51bGwgJiYgb3B0aW9ucyAhPT0gdm9pZCAwID8gb3B0aW9ucyA6IGRlZmF1bHRPcHRzO1xuICAgICAgICB0aGlzLmVsZW1lbnRDQiA9IGVsZW1lbnRDQiAhPT0gbnVsbCAmJiBlbGVtZW50Q0IgIT09IHZvaWQgMCA/IGVsZW1lbnRDQiA6IG51bGw7XG4gICAgfVxuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9ucGFyc2VyaW5pdCA9IGZ1bmN0aW9uIChwYXJzZXIpIHtcbiAgICAgICAgdGhpcy5wYXJzZXIgPSBwYXJzZXI7XG4gICAgfTtcbiAgICAvLyBSZXNldHMgdGhlIGhhbmRsZXIgYmFjayB0byBzdGFydGluZyBzdGF0ZVxuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9ucmVzZXQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBfYTtcbiAgICAgICAgdGhpcy5kb20gPSBbXTtcbiAgICAgICAgdGhpcy5yb290ID0gbmV3IG5vZGVfMS5Eb2N1bWVudCh0aGlzLmRvbSk7XG4gICAgICAgIHRoaXMuZG9uZSA9IGZhbHNlO1xuICAgICAgICB0aGlzLnRhZ1N0YWNrID0gW3RoaXMucm9vdF07XG4gICAgICAgIHRoaXMubGFzdE5vZGUgPSBudWxsO1xuICAgICAgICB0aGlzLnBhcnNlciA9IChfYSA9IHRoaXMucGFyc2VyKSAhPT0gbnVsbCAmJiBfYSAhPT0gdm9pZCAwID8gX2EgOiBudWxsO1xuICAgIH07XG4gICAgLy8gU2lnbmFscyB0aGUgaGFuZGxlciB0aGF0IHBhcnNpbmcgaXMgZG9uZVxuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9uZW5kID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5kb25lKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB0aGlzLmRvbmUgPSB0cnVlO1xuICAgICAgICB0aGlzLnBhcnNlciA9IG51bGw7XG4gICAgICAgIHRoaXMuaGFuZGxlQ2FsbGJhY2sobnVsbCk7XG4gICAgfTtcbiAgICBEb21IYW5kbGVyLnByb3RvdHlwZS5vbmVycm9yID0gZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlQ2FsbGJhY2soZXJyb3IpO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub25jbG9zZXRhZyA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5sYXN0Tm9kZSA9IG51bGw7XG4gICAgICAgIHZhciBlbGVtID0gdGhpcy50YWdTdGFjay5wb3AoKTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy53aXRoRW5kSW5kaWNlcykge1xuICAgICAgICAgICAgZWxlbS5lbmRJbmRleCA9IHRoaXMucGFyc2VyLmVuZEluZGV4O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmVsZW1lbnRDQilcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudENCKGVsZW0pO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub25vcGVudGFnID0gZnVuY3Rpb24gKG5hbWUsIGF0dHJpYnMpIHtcbiAgICAgICAgdmFyIGVsZW1lbnQgPSBuZXcgbm9kZV8xLkVsZW1lbnQobmFtZSwgYXR0cmlicyk7XG4gICAgICAgIHRoaXMuYWRkTm9kZShlbGVtZW50KTtcbiAgICAgICAgdGhpcy50YWdTdGFjay5wdXNoKGVsZW1lbnQpO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub250ZXh0ID0gZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgdmFyIG5vcm1hbGl6ZVdoaXRlc3BhY2UgPSB0aGlzLm9wdGlvbnMubm9ybWFsaXplV2hpdGVzcGFjZTtcbiAgICAgICAgdmFyIGxhc3ROb2RlID0gdGhpcy5sYXN0Tm9kZTtcbiAgICAgICAgaWYgKGxhc3ROb2RlICYmIGxhc3ROb2RlLnR5cGUgPT09IFwidGV4dFwiIC8qIFRleHQgKi8pIHtcbiAgICAgICAgICAgIGlmIChub3JtYWxpemVXaGl0ZXNwYWNlKSB7XG4gICAgICAgICAgICAgICAgbGFzdE5vZGUuZGF0YSA9IChsYXN0Tm9kZS5kYXRhICsgZGF0YSkucmVwbGFjZShyZVdoaXRlc3BhY2UsIFwiIFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGxhc3ROb2RlLmRhdGEgKz0gZGF0YTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGlmIChub3JtYWxpemVXaGl0ZXNwYWNlKSB7XG4gICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEucmVwbGFjZShyZVdoaXRlc3BhY2UsIFwiIFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciBub2RlID0gbmV3IG5vZGVfMS5UZXh0KGRhdGEpO1xuICAgICAgICAgICAgdGhpcy5hZGROb2RlKG5vZGUpO1xuICAgICAgICAgICAgdGhpcy5sYXN0Tm9kZSA9IG5vZGU7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9uY29tbWVudCA9IGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgIGlmICh0aGlzLmxhc3ROb2RlICYmIHRoaXMubGFzdE5vZGUudHlwZSA9PT0gXCJjb21tZW50XCIgLyogQ29tbWVudCAqLykge1xuICAgICAgICAgICAgdGhpcy5sYXN0Tm9kZS5kYXRhICs9IGRhdGE7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdmFyIG5vZGUgPSBuZXcgbm9kZV8xLkNvbW1lbnQoZGF0YSk7XG4gICAgICAgIHRoaXMuYWRkTm9kZShub2RlKTtcbiAgICAgICAgdGhpcy5sYXN0Tm9kZSA9IG5vZGU7XG4gICAgfTtcbiAgICBEb21IYW5kbGVyLnByb3RvdHlwZS5vbmNvbW1lbnRlbmQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHRoaXMubGFzdE5vZGUgPSBudWxsO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUub25jZGF0YXN0YXJ0ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgdGV4dCA9IG5ldyBub2RlXzEuVGV4dChcIlwiKTtcbiAgICAgICAgdmFyIG5vZGUgPSBuZXcgbm9kZV8xLk5vZGVXaXRoQ2hpbGRyZW4oXCJjZGF0YVwiIC8qIENEQVRBICovLCBbdGV4dF0pO1xuICAgICAgICB0aGlzLmFkZE5vZGUobm9kZSk7XG4gICAgICAgIHRleHQucGFyZW50ID0gbm9kZTtcbiAgICAgICAgdGhpcy5sYXN0Tm9kZSA9IHRleHQ7XG4gICAgfTtcbiAgICBEb21IYW5kbGVyLnByb3RvdHlwZS5vbmNkYXRhZW5kID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLm9ucHJvY2Vzc2luZ2luc3RydWN0aW9uID0gZnVuY3Rpb24gKG5hbWUsIGRhdGEpIHtcbiAgICAgICAgdmFyIG5vZGUgPSBuZXcgbm9kZV8xLlByb2Nlc3NpbmdJbnN0cnVjdGlvbihuYW1lLCBkYXRhKTtcbiAgICAgICAgdGhpcy5hZGROb2RlKG5vZGUpO1xuICAgIH07XG4gICAgRG9tSGFuZGxlci5wcm90b3R5cGUuaGFuZGxlQ2FsbGJhY2sgPSBmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLmNhbGxiYWNrID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2soZXJyb3IsIHRoaXMuZG9tKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLmFkZE5vZGUgPSBmdW5jdGlvbiAobm9kZSkge1xuICAgICAgICB2YXIgcGFyZW50ID0gdGhpcy50YWdTdGFja1t0aGlzLnRhZ1N0YWNrLmxlbmd0aCAtIDFdO1xuICAgICAgICB2YXIgcHJldmlvdXNTaWJsaW5nID0gcGFyZW50LmNoaWxkcmVuW3BhcmVudC5jaGlsZHJlbi5sZW5ndGggLSAxXTtcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy53aXRoU3RhcnRJbmRpY2VzKSB7XG4gICAgICAgICAgICBub2RlLnN0YXJ0SW5kZXggPSB0aGlzLnBhcnNlci5zdGFydEluZGV4O1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMud2l0aEVuZEluZGljZXMpIHtcbiAgICAgICAgICAgIG5vZGUuZW5kSW5kZXggPSB0aGlzLnBhcnNlci5lbmRJbmRleDtcbiAgICAgICAgfVxuICAgICAgICBwYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlKTtcbiAgICAgICAgaWYgKHByZXZpb3VzU2libGluZykge1xuICAgICAgICAgICAgbm9kZS5wcmV2ID0gcHJldmlvdXNTaWJsaW5nO1xuICAgICAgICAgICAgcHJldmlvdXNTaWJsaW5nLm5leHQgPSBub2RlO1xuICAgICAgICB9XG4gICAgICAgIG5vZGUucGFyZW50ID0gcGFyZW50O1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbnVsbDtcbiAgICB9O1xuICAgIERvbUhhbmRsZXIucHJvdG90eXBlLmFkZERhdGFOb2RlID0gZnVuY3Rpb24gKG5vZGUpIHtcbiAgICAgICAgdGhpcy5hZGROb2RlKG5vZGUpO1xuICAgICAgICB0aGlzLmxhc3ROb2RlID0gbm9kZTtcbiAgICB9O1xuICAgIHJldHVybiBEb21IYW5kbGVyO1xufSgpKTtcbmV4cG9ydHMuRG9tSGFuZGxlciA9IERvbUhhbmRsZXI7XG5leHBvcnRzLmRlZmF1bHQgPSBEb21IYW5kbGVyO1xuIl19