5e99b9dbd5b4a2b3e81886d4c19696b3
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var NOAH_ARK_CAPACITY = 3;

var FormattingElementList = function () {
  function FormattingElementList(treeAdapter) {
    (0, _classCallCheck2.default)(this, FormattingElementList);
    this.length = 0;
    this.entries = [];
    this.treeAdapter = treeAdapter;
    this.bookmark = null;
  }

  (0, _createClass2.default)(FormattingElementList, [{
    key: "_getNoahArkConditionCandidates",
    value: function _getNoahArkConditionCandidates(newElement) {
      var candidates = [];

      if (this.length >= NOAH_ARK_CAPACITY) {
        var neAttrsLength = this.treeAdapter.getAttrList(newElement).length;
        var neTagName = this.treeAdapter.getTagName(newElement);
        var neNamespaceURI = this.treeAdapter.getNamespaceURI(newElement);

        for (var i = this.length - 1; i >= 0; i--) {
          var entry = this.entries[i];

          if (entry.type === FormattingElementList.MARKER_ENTRY) {
            break;
          }

          var element = entry.element;
          var elementAttrs = this.treeAdapter.getAttrList(element);
          var isCandidate = this.treeAdapter.getTagName(element) === neTagName && this.treeAdapter.getNamespaceURI(element) === neNamespaceURI && elementAttrs.length === neAttrsLength;

          if (isCandidate) {
            candidates.push({
              idx: i,
              attrs: elementAttrs
            });
          }
        }
      }

      return candidates.length < NOAH_ARK_CAPACITY ? [] : candidates;
    }
  }, {
    key: "_ensureNoahArkCondition",
    value: function _ensureNoahArkCondition(newElement) {
      var candidates = this._getNoahArkConditionCandidates(newElement);

      var cLength = candidates.length;

      if (cLength) {
        var neAttrs = this.treeAdapter.getAttrList(newElement);
        var neAttrsLength = neAttrs.length;
        var neAttrsMap = Object.create(null);

        for (var i = 0; i < neAttrsLength; i++) {
          var neAttr = neAttrs[i];
          neAttrsMap[neAttr.name] = neAttr.value;
        }

        for (var _i = 0; _i < neAttrsLength; _i++) {
          for (var j = 0; j < cLength; j++) {
            var cAttr = candidates[j].attrs[_i];

            if (neAttrsMap[cAttr.name] !== cAttr.value) {
              candidates.splice(j, 1);
              cLength--;
            }

            if (candidates.length < NOAH_ARK_CAPACITY) {
              return;
            }
          }
        }

        for (var _i2 = cLength - 1; _i2 >= NOAH_ARK_CAPACITY - 1; _i2--) {
          this.entries.splice(candidates[_i2].idx, 1);
          this.length--;
        }
      }
    }
  }, {
    key: "insertMarker",
    value: function insertMarker() {
      this.entries.push({
        type: FormattingElementList.MARKER_ENTRY
      });
      this.length++;
    }
  }, {
    key: "pushElement",
    value: function pushElement(element, token) {
      this._ensureNoahArkCondition(element);

      this.entries.push({
        type: FormattingElementList.ELEMENT_ENTRY,
        element: element,
        token: token
      });
      this.length++;
    }
  }, {
    key: "insertElementAfterBookmark",
    value: function insertElementAfterBookmark(element, token) {
      var bookmarkIdx = this.length - 1;

      for (; bookmarkIdx >= 0; bookmarkIdx--) {
        if (this.entries[bookmarkIdx] === this.bookmark) {
          break;
        }
      }

      this.entries.splice(bookmarkIdx + 1, 0, {
        type: FormattingElementList.ELEMENT_ENTRY,
        element: element,
        token: token
      });
      this.length++;
    }
  }, {
    key: "removeEntry",
    value: function removeEntry(entry) {
      for (var i = this.length - 1; i >= 0; i--) {
        if (this.entries[i] === entry) {
          this.entries.splice(i, 1);
          this.length--;
          break;
        }
      }
    }
  }, {
    key: "clearToLastMarker",
    value: function clearToLastMarker() {
      while (this.length) {
        var entry = this.entries.pop();
        this.length--;

        if (entry.type === FormattingElementList.MARKER_ENTRY) {
          break;
        }
      }
    }
  }, {
    key: "getElementEntryInScopeWithTagName",
    value: function getElementEntryInScopeWithTagName(tagName) {
      for (var i = this.length - 1; i >= 0; i--) {
        var entry = this.entries[i];

        if (entry.type === FormattingElementList.MARKER_ENTRY) {
          return null;
        }

        if (this.treeAdapter.getTagName(entry.element) === tagName) {
          return entry;
        }
      }

      return null;
    }
  }, {
    key: "getElementEntry",
    value: function getElementEntry(element) {
      for (var i = this.length - 1; i >= 0; i--) {
        var entry = this.entries[i];

        if (entry.type === FormattingElementList.ELEMENT_ENTRY && entry.element === element) {
          return entry;
        }
      }

      return null;
    }
  }]);
  return FormattingElementList;
}();

FormattingElementList.MARKER_ENTRY = 'MARKER_ENTRY';
FormattingElementList.ELEMENT_ENTRY = 'ELEMENT_ENTRY';
module.exports = FormattingElementList;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImZvcm1hdHRpbmctZWxlbWVudC1saXN0LmpzIl0sIm5hbWVzIjpbIk5PQUhfQVJLX0NBUEFDSVRZIiwiRm9ybWF0dGluZ0VsZW1lbnRMaXN0IiwidHJlZUFkYXB0ZXIiLCJsZW5ndGgiLCJlbnRyaWVzIiwiYm9va21hcmsiLCJuZXdFbGVtZW50IiwiY2FuZGlkYXRlcyIsIm5lQXR0cnNMZW5ndGgiLCJnZXRBdHRyTGlzdCIsIm5lVGFnTmFtZSIsImdldFRhZ05hbWUiLCJuZU5hbWVzcGFjZVVSSSIsImdldE5hbWVzcGFjZVVSSSIsImkiLCJlbnRyeSIsInR5cGUiLCJNQVJLRVJfRU5UUlkiLCJlbGVtZW50IiwiZWxlbWVudEF0dHJzIiwiaXNDYW5kaWRhdGUiLCJwdXNoIiwiaWR4IiwiYXR0cnMiLCJfZ2V0Tm9haEFya0NvbmRpdGlvbkNhbmRpZGF0ZXMiLCJjTGVuZ3RoIiwibmVBdHRycyIsIm5lQXR0cnNNYXAiLCJPYmplY3QiLCJjcmVhdGUiLCJuZUF0dHIiLCJuYW1lIiwidmFsdWUiLCJqIiwiY0F0dHIiLCJzcGxpY2UiLCJ0b2tlbiIsIl9lbnN1cmVOb2FoQXJrQ29uZGl0aW9uIiwiRUxFTUVOVF9FTlRSWSIsImJvb2ttYXJrSWR4IiwicG9wIiwidGFnTmFtZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUdBLElBQU1BLGlCQUFpQixHQUFHLENBQTFCOztJQUdNQyxxQjtBQUNGLGlDQUFZQyxXQUFaLEVBQXlCO0FBQUE7QUFDckIsU0FBS0MsTUFBTCxHQUFjLENBQWQ7QUFDQSxTQUFLQyxPQUFMLEdBQWUsRUFBZjtBQUNBLFNBQUtGLFdBQUwsR0FBbUJBLFdBQW5CO0FBQ0EsU0FBS0csUUFBTCxHQUFnQixJQUFoQjtBQUNIOzs7O1dBS0Qsd0NBQStCQyxVQUEvQixFQUEyQztBQUN2QyxVQUFNQyxVQUFVLEdBQUcsRUFBbkI7O0FBRUEsVUFBSSxLQUFLSixNQUFMLElBQWVILGlCQUFuQixFQUFzQztBQUNsQyxZ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Q0csT0FBbEMsTUFBK0N1QixPQUFuRCxFQUE0RDtBQUN4RCxpQkFBTzFCLEtBQVA7QUFDSDtBQUNKOztBQUVELGFBQU8sSUFBUDtBQUNIOzs7V0FFRCx5QkFBZ0JHLE9BQWhCLEVBQXlCO0FBQ3JCLFdBQUssSUFBSUosQ0FBQyxHQUFHLEtBQUtYLE1BQUwsR0FBYyxDQUEzQixFQUE4QlcsQ0FBQyxJQUFJLENBQW5DLEVBQXNDQSxDQUFDLEVBQXZDLEVBQTJDO0FBQ3ZDLFlBQU1DLEtBQUssR0FBRyxLQUFLWCxPQUFMLENBQWFVLENBQWIsQ0FBZDs7QUFFQSxZQUFJQyxLQUFLLENBQUNDLElBQU4sS0FBZWYscUJBQXFCLENBQUNxQyxhQUFyQyxJQUFzRHZCLEtBQUssQ0FBQ0csT0FBTixLQUFrQkEsT0FBNUUsRUFBcUY7QUFDakYsaUJBQU9ILEtBQVA7QUFDSDtBQUNKOztBQUVELGFBQU8sSUFBUDtBQUNIOzs7OztBQUlMZCxxQkFBcUIsQ0FBQ2dCLFlBQXRCLEdBQXFDLGNBQXJDO0FBQ0FoQixxQkFBcUIsQ0FBQ3FDLGFBQXRCLEdBQXNDLGVBQXRDO0FBRUFJLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQjFDLHFCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuLy9Db25zdFxuY29uc3QgTk9BSF9BUktfQ0FQQUNJVFkgPSAzO1xuXG4vL0xpc3Qgb2YgZm9ybWF0dGluZyBlbGVtZW50c1xuY2xhc3MgRm9ybWF0dGluZ0VsZW1lbnRMaXN0IHtcbiAgICBjb25zdHJ1Y3Rvcih0cmVlQWRhcHRlcikge1xuICAgICAgICB0aGlzLmxlbmd0aCA9IDA7XG4gICAgICAgIHRoaXMuZW50cmllcyA9IFtdO1xuICAgICAgICB0aGlzLnRyZWVBZGFwdGVyID0gdHJlZUFkYXB0ZXI7XG4gICAgICAgIHRoaXMuYm9va21hcmsgPSBudWxsO1xuICAgIH1cblxuICAgIC8vTm9haCBBcmsncyBjb25kaXRpb25cbiAgICAvL09QVElNSVpBVElPTjogYXQgZmlyc3Qgd2UgdHJ5IHRvIGZpbmQgcG9zc2libGUgY2FuZGlkYXRlcyBmb3IgZXhjbHVzaW9uIHVzaW5nXG4gICAgLy9saWdodHdlaWdodCBoZXVyaXN0aWNzIHdpdGhvdXQgdGhvcm91Z2ggYXR0cmlidXRlcyBjaGVjay5cbiAgICBfZ2V0Tm9haEFya0NvbmRpdGlvbkNhbmRpZGF0ZXMobmV3RWxlbWVudCkge1xuICAgICAgICBjb25zdCBjYW5kaWRhdGVzID0gW107XG5cbiAgICAgICAgaWYgKHRoaXMubGVuZ3RoID49IE5PQUhfQVJLX0NBUEFDSVRZKSB7XG4gICAgICAgICAgICBjb25zdCBuZUF0dHJzTGVuZ3RoID0gdGhpcy50cmVlQWRhcHRlci5nZXRBdHRyTGlzdChuZXdFbGVtZW50KS5sZW5ndGg7XG4gICAgICAgICAgICBjb25zdCBuZVRhZ05hbWUgPSB0aGlzLnRyZWVBZGFwdGVyLmdldFRhZ05hbWUobmV3RWxlbWVudCk7XG4gICAgICAgICAgICBjb25zdCBuZU5hbWVzcGFjZVVSSSA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0TmFtZXNwYWNlVVJJKG5ld0VsZW1lbnQpO1xuXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5lbnRyaWVzW2ldO1xuXG4gICAgICAgICAgICAgICAgaWYgKGVudHJ5LnR5cGUgPT09IEZvcm1hdHRpbmdFbGVtZW50TGlzdC5NQVJLRVJfRU5UUlkpIHtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGVudHJ5LmVsZW1lbnQ7XG4gICAgICAgICAgICAgICAgY29uc3QgZWxlbWVudEF0dHJzID0gdGhpcy50cmVlQWRhcHRlci5nZXRBdHRyTGlzdChlbGVtZW50KTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGlzQ2FuZGlkYXRlID1cbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmVlQWRhcHRlci5nZXRUYWdOYW1lKGVsZW1lbnQpID09PSBuZVRhZ05hbWUgJiZcbiAgICAgICAgICAgICAgICAgICAgdGhpcy50cmVlQWRhcHRlci5nZXROYW1lc3BhY2VVUkkoZWxlbWVudCkgPT09IG5lTmFtZXNwYWNlVVJJICYmXG4gICAgICAgICAgICAgICAgICAgIGVsZW1lbnRBdHRycy5sZW5ndGggPT09IG5lQXR0cnNMZW5ndGg7XG5cbiAgICAgICAgICAgICAgICBpZiAoaXNDYW5kaWRhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2FuZGlkYXRlcy5wdXNoKHsgaWR4OiBpLCBhdHRyczogZWxlbWVudEF0dHJzIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjYW5kaWRhdGVzLmxlbmd0aCA8IE5PQUhfQVJLX0NBUEFDSVRZID8gW10gOiBjYW5kaWRhdGVzO1xuICAgIH1cblxuICAgIF9lbnN1cmVOb2FoQXJrQ29uZGl0aW9uKG5ld0VsZW1lbnQpIHtcbiAgICAgICAgY29uc3QgY2FuZGlkYXRlcyA9IHRoaXMuX2dldE5vYWhBcmtDb25kaXRpb25DYW5kaWRhdGVzKG5ld0VsZW1lbnQpO1xuICAgICAgICBsZXQgY0xlbmd0aCA9IGNhbmRpZGF0ZXMubGVuZ3RoO1xuXG4gICAgICAgIGlmIChjTGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBuZUF0dHJzID0gdGhpcy50cmVlQWRhcHRlci5nZXRBdHRyTGlzdChuZXdFbGVtZW50KTtcbiAgICAgICAgICAgIGNvbnN0IG5lQXR0cnNMZW5ndGggPSBuZUF0dHJzLmxlbmd0aDtcbiAgICAgICAgICAgIGNvbnN0IG5lQXR0cnNNYXAgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gICAgICAgICAgICAvL05PVEU6IGJ1aWxkIGF0dHJzIG1hcCBmb3IgdGhlIG5ldyBlbGVtZW50IHNvIHdlIGNhbiBwZXJmb3JtIGZhc3QgbG9va3Vwc1xuICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBuZUF0dHJzTGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZUF0dHIgPSBuZUF0dHJzW2ldO1xuXG4gICAgICAgICAgICAgICAgbmVBdHRyc01hcFtuZUF0dHIubmFtZV0gPSBuZUF0dHIudmFsdWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbmVBdHRyc0xlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBjTGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY0F0dHIgPSBjYW5kaWRhdGVzW2pdLmF0dHJzW2ldO1xuXG4gICAgICAgICAgICAgICAgICAgIGlmIChuZUF0dHJzTWFwW2NBdHRyLm5hbWVdICE9PSBjQXR0ci52YWx1ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FuZGlkYXRlcy5zcGxpY2UoaiwgMSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjTGVuZ3RoLS07XG4gICAgICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgICAgICBpZiAoY2FuZGlkYXRlcy5sZW5ndGggPCBOT0FIX0FSS19DQVBBQ0lUWSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvL05PVEU6IHJlbW92ZSBib3R0b21tb3N0IGNhbmRpZGF0ZXMgdW50aWwgTm9haCdzIEFyayBjb25kaXRpb24gd2lsbCBub3QgYmUgbWV0XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gY0xlbmd0aCAtIDE7IGkgPj0gTk9BSF9BUktfQ0FQQUNJVFkgLSAxOyBpLS0pIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudHJpZXMuc3BsaWNlKGNhbmRpZGF0ZXNbaV0uaWR4LCAxKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxlbmd0aC0tO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy9NdXRhdGlvbnNcbiAgICBpbnNlcnRNYXJrZXIoKSB7XG4gICAgICAgIHRoaXMuZW50cmllcy5wdXNoKHsgdHlwZTogRm9ybWF0dGluZ0VsZW1lbnRMaXN0Lk1BUktFUl9FTlRSWSB9KTtcbiAgICAgICAgdGhpcy5sZW5ndGgrKztcbiAgICB9XG5cbiAgICBwdXNoRWxlbWVudChlbGVtZW50LCB0b2tlbikge1xuICAgICAgICB0aGlzLl9lbnN1cmVOb2FoQXJrQ29uZGl0aW9uKGVsZW1lbnQpO1xuXG4gICAgICAgIHRoaXMuZW50cmllcy5wdXNoKHtcbiAgICAgICAgICAgIHR5cGU6IEZvcm1hdHRpbmdFbGVtZW50TGlzdC5FTEVNRU5UX0VOVFJZLFxuICAgICAgICAgICAgZWxlbWVudDogZWxlbWVudCxcbiAgICAgICAgICAgIHRva2VuOiB0b2tlblxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmxlbmd0aCsrO1xuICAgIH1cblxuICAgIGluc2VydEVsZW1lbnRBZnRlckJvb2ttYXJrKGVsZW1lbnQsIHRva2VuKSB7XG4gICAgICAgIGxldCBib29rbWFya0lkeCA9IHRoaXMubGVuZ3RoIC0gMTtcblxuICAgICAgICBmb3IgKDsgYm9va21hcmtJZHggPj0gMDsgYm9va21hcmtJZHgtLSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZW50cmllc1tib29rbWFya0lkeF0gPT09IHRoaXMuYm9va21hcmspIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZW50cmllcy5zcGxpY2UoYm9va21hcmtJZHggKyAxLCAwLCB7XG4gICAgICAgICAgICB0eXBlOiBGb3JtYXR0aW5nRWxlbWVudExpc3QuRUxFTUVOVF9FTlRSWSxcbiAgICAgICAgICAgIGVsZW1lbnQ6IGVsZW1lbnQsXG4gICAgICAgICAgICB0b2tlbjogdG9rZW5cbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5sZW5ndGgrKztcbiAgICB9XG5cbiAgICByZW1vdmVFbnRyeShlbnRyeSkge1xuICAgICAgICBmb3IgKGxldCBpID0gdGhpcy5sZW5ndGggLSAxOyBpID49IDA7IGktLSkge1xuICAgICAgICAgICAgaWYgKHRoaXMuZW50cmllc1tpXSA9PT0gZW50cnkpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmVudHJpZXMuc3BsaWNlKGksIDEpO1xuICAgICAgICAgICAgICAgIHRoaXMubGVuZ3RoLS07XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjbGVhclRvTGFzdE1hcmtlcigpIHtcbiAgICAgICAgd2hpbGUgKHRoaXMubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb25zdCBlbnRyeSA9IHRoaXMuZW50cmllcy5wb3AoKTtcblxuICAgICAgICAgICAgdGhpcy5sZW5ndGgtLTtcblxuICAgICAgICAgICAgaWYgKGVudHJ5LnR5cGUgPT09IEZvcm1hdHRpbmdFbGVtZW50TGlzdC5NQVJLRVJfRU5UUlkpIHtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vU2VhcmNoXG4gICAgZ2V0RWxlbWVudEVudHJ5SW5TY29wZVdpdGhUYWdOYW1lKHRhZ05hbWUpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5lbnRyaWVzW2ldO1xuXG4gICAgICAgICAgICBpZiAoZW50cnkudHlwZSA9PT0gRm9ybWF0dGluZ0VsZW1lbnRMaXN0Lk1BUktFUl9FTlRSWSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAodGhpcy50cmVlQWRhcHRlci5nZXRUYWdOYW1lKGVudHJ5LmVsZW1lbnQpID09PSB0YWdOYW1lKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGVudHJ5O1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZ2V0RWxlbWVudEVudHJ5KGVsZW1lbnQpIHtcbiAgICAgICAgZm9yIChsZXQgaSA9IHRoaXMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5lbnRyaWVzW2ldO1xuXG4gICAgICAgICAgICBpZiAoZW50cnkudHlwZSA9PT0gRm9ybWF0dGluZ0VsZW1lbnRMaXN0LkVMRU1FTlRfRU5UUlkgJiYgZW50cnkuZWxlbWVudCA9PT0gZWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBlbnRyeTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbn1cblxuLy9FbnRyeSB0eXBlc1xuRm9ybWF0dGluZ0VsZW1lbnRMaXN0Lk1BUktFUl9FTlRSWSA9ICdNQVJLRVJfRU5UUlknO1xuRm9ybWF0dGluZ0VsZW1lbnRMaXN0LkVMRU1FTlRfRU5UUlkgPSAnRUxFTUVOVF9FTlRSWSc7XG5cbm1vZHVsZS5leHBvcnRzID0gRm9ybWF0dGluZ0VsZW1lbnRMaXN0O1xuIl19