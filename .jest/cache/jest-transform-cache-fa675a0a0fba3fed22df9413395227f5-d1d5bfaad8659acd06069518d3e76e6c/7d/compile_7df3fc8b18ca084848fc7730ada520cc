f720fe1b2bbd9e62a6f8cdd00aca16c0
"use strict";

var __importDefault = this && this.__importDefault || function (mod) {
  return mod && mod.__esModule ? mod : {
    "default": mod
  };
};

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.compileToken = exports.compileUnsafe = exports.compile = void 0;

var css_what_1 = require("css-what");

var boolbase_1 = require("boolbase");

var sort_1 = __importDefault(require("./sort"));

var procedure_1 = require("./procedure");

var general_1 = require("./general");

var subselects_1 = require("./pseudo-selectors/subselects");

function compile(selector, options, context) {
  var next = compileUnsafe(selector, options, context);
  return subselects_1.ensureIsTag(next, options.adapter);
}

exports.compile = compile;

function compileUnsafe(selector, options, context) {
  var token = css_what_1.parse(selector, options);
  return compileToken(token, options, context);
}

exports.compileUnsafe = compileUnsafe;

function includesScopePseudo(t) {
  return t.type === "pseudo" && (t.name === "scope" || Array.isArray(t.data) && t.data.some(function (data) {
    return data.some(includesScopePseudo);
  }));
}

var DESCENDANT_TOKEN = {
  type: "descendant"
};
var FLEXIBLE_DESCENDANT_TOKEN = {
  type: "_flexibleDescendant"
};
var SCOPE_TOKEN = {
  type: "pseudo",
  name: "scope",
  data: null
};

function absolutize(token, _a, context) {
  var adapter = _a.adapter;
  var hasContext = !!(context === null || context === void 0 ? void 0 : context.every(function (e) {
    var parent = adapter.getParent(e);
    return e === subselects_1.PLACEHOLDER_ELEMENT || !!(parent && adapter.isTag(parent));
  }));

  for (var _i = 0, token_1 = token; _i < token_1.length; _i++) {
    var t = token_1[_i];

    if (t.length > 0 && procedure_1.isTraversal(t[0]) && t[0].type !== "descendant") {} else if (hasContext && !t.some(includesScopePseudo)) {
      t.unshift(DESCENDANT_TOKEN);
    } else {
      continue;
    }

    t.unshift(SCOPE_TOKEN);
  }
}

function compileToken(token, options, context) {
  var _a;

  token = token.filter(function (t) {
    return t.length > 0;
  });
  token.forEach(sort_1.default);
  context = (_a = options.context) !== null && _a !== void 0 ? _a : context;
  var isArrayContext = Array.isArray(context);
  var finalContext = context && (Array.isArray(context) ? context : [context]);
  absolutize(token, options, finalContext);
  var shouldTestNextSiblings = false;
  var query = token.map(function (rules) {
    if (rules.length >= 2) {
      var first = rules[0],
          second = rules[1];

      if (first.type !== "pseudo" || first.name !== "scope") {} else if (isArrayContext && second.type === "descendant") {
        rules[1] = FLEXIBLE_DESCENDANT_TOKEN;
      } else if (second.type === "adjacent" || second.type === "sibling") {
        shouldTestNextSiblings = true;
      }
    }

    return compileRules(rules, options, finalContext);
  }).reduce(reduceRules, boolbase_1.falseFunc);
  query.shouldTestNextSiblings = shouldTestNextSiblings;
  return query;
}

exports.compileToken = compileToken;

function compileRules(rules, options, context) {
  var _a;

  return rules.reduce(function (previous, rule) {
    return previous === boolbase_1.falseFunc ? boolbase_1.falseFunc : general_1.compileGeneralSelector(previous, rule, options, context, compileToken);
  }, (_a = options.rootFunc) !== null && _a !== void 0 ? _a : boolbase_1.trueFunc);
}

function reduceRules(a, b) {
  if (b === boolbase_1.falseFunc || a === boolbase_1.trueFunc) {
    return a;
  }

  if (a === boolbase_1.falseFunc || b === boolbase_1.trueFunc) {
    return b;
  }

  return function combine(elem) {
    return a(elem) || b(elem);
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbXBpbGUuanMiXSwibmFtZXMiOlsiX19pbXBvcnREZWZhdWx0IiwibW9kIiwiX19lc01vZHVsZSIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiY29tcGlsZVRva2VuIiwiY29tcGlsZVVuc2FmZSIsImNvbXBpbGUiLCJjc3Nfd2hhdF8xIiwicmVxdWlyZSIsImJvb2xiYXNlXzEiLCJzb3J0XzEiLCJwcm9jZWR1cmVfMSIsImdlbmVyYWxfMSIsInN1YnNlbGVjdHNfMSIsInNlbGVjdG9yIiwib3B0aW9ucyIsImNvbnRleHQiLCJuZXh0IiwiZW5zdXJlSXNUYWciLCJhZGFwdGVyIiwidG9rZW4iLCJwYXJzZSIsImluY2x1ZGVzU2NvcGVQc2V1ZG8iLCJ0IiwidHlwZSIsIm5hbWUiLCJBcnJheSIsImlzQXJyYXkiLCJkYXRhIiwic29tZSIsIkRFU0NFTkRBTlRfVE9LRU4iLCJGTEVYSUJMRV9ERVNDRU5EQU5UX1RPS0VOIiwiU0NPUEVfVE9LRU4iLCJhYnNvbHV0aXplIiwiX2EiLCJoYXNDb250ZXh0IiwiZXZlcnkiLCJlIiwicGFyZW50IiwiZ2V0UGFyZW50IiwiUExBQ0VIT0xERVJfRUxFTUVOVCIsImlzVGFnIiwiX2kiLCJ0b2tlbl8xIiwibGVuZ3RoIiwiaXNUcmF2ZXJzYWwiLCJ1bnNoaWZ0IiwiZmlsdGVyIiwiZm9yRWFjaCIsImRlZmF1bHQiLCJpc0FycmF5Q29udGV4dCIsImZpbmFsQ29udGV4dCIsInNob3VsZFRlc3ROZXh0U2libGluZ3MiLCJxdWVyeSIsIm1hcCIsInJ1bGVzIiwiZmlyc3QiLCJzZWNvbmQiLCJjb21waWxlUnVsZXMiLCJyZWR1Y2UiLCJyZWR1Y2VSdWxlcyIsImZhbHNlRnVuYyIsInByZXZpb3VzIiwicnVsZSIsImNvbXBpbGVHZW5lcmFsU2VsZWN0b3IiLCJyb290RnVuYyIsInRydWVGdW5jIiwiYSIsImIiLCJjb21iaW5lIiwiZWxlbSJdLCJtYXBwaW5ncyI6IkFBQUE7O0FBQ0EsSUFB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QUFPQyxDQUFQO0FBQ0g7O0FBQ0QsTUFBSUEsQ0FBQyxLQUFLMUQsVUFBVSxDQUFDb0QsU0FBakIsSUFBOEJPLENBQUMsS0FBSzNELFVBQVUsQ0FBQ3lELFFBQW5ELEVBQTZEO0FBQ3pELFdBQU9FLENBQVA7QUFDSDs7QUFDRCxTQUFPLFNBQVNDLE9BQVQsQ0FBaUJDLElBQWpCLEVBQXVCO0FBQzFCLFdBQU9ILENBQUMsQ0FBQ0csSUFBRCxDQUFELElBQVdGLENBQUMsQ0FBQ0UsSUFBRCxDQUFuQjtBQUNILEdBRkQ7QUFHSCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xudmFyIF9faW1wb3J0RGVmYXVsdCA9ICh0aGlzICYmIHRoaXMuX19pbXBvcnREZWZhdWx0KSB8fCBmdW5jdGlvbiAobW9kKSB7XG4gICAgcmV0dXJuIChtb2QgJiYgbW9kLl9fZXNNb2R1bGUpID8gbW9kIDogeyBcImRlZmF1bHRcIjogbW9kIH07XG59O1xuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7IHZhbHVlOiB0cnVlIH0pO1xuZXhwb3J0cy5jb21waWxlVG9rZW4gPSBleHBvcnRzLmNvbXBpbGVVbnNhZmUgPSBleHBvcnRzLmNvbXBpbGUgPSB2b2lkIDA7XG52YXIgY3NzX3doYXRfMSA9IHJlcXVpcmUoXCJjc3Mtd2hhdFwiKTtcbnZhciBib29sYmFzZV8xID0gcmVxdWlyZShcImJvb2xiYXNlXCIpO1xudmFyIHNvcnRfMSA9IF9faW1wb3J0RGVmYXVsdChyZXF1aXJlKFwiLi9zb3J0XCIpKTtcbnZhciBwcm9jZWR1cmVfMSA9IHJlcXVpcmUoXCIuL3Byb2NlZHVyZVwiKTtcbnZhciBnZW5lcmFsXzEgPSByZXF1aXJlKFwiLi9nZW5lcmFsXCIpO1xudmFyIHN1YnNlbGVjdHNfMSA9IHJlcXVpcmUoXCIuL3BzZXVkby1zZWxlY3RvcnMvc3Vic2VsZWN0c1wiKTtcbi8qKlxuICogQ29tcGlsZXMgYSBzZWxlY3RvciB0byBhbiBleGVjdXRhYmxlIGZ1bmN0aW9uLlxuICpcbiAqIEBwYXJhbSBzZWxlY3RvciBTZWxlY3RvciB0byBjb21waWxlLlxuICogQHBhcmFtIG9wdGlvbnMgQ29tcGlsYXRpb24gb3B0aW9ucy5cbiAqIEBwYXJhbSBjb250ZXh0IE9wdGlvbmFsIGNvbnRleHQgZm9yIHRoZSBzZWxlY3Rvci5cbiAqL1xuZnVuY3Rpb24gY29tcGlsZShzZWxlY3Rvciwgb3B0aW9ucywgY29udGV4dCkge1xuICAgIHZhciBuZXh0ID0gY29tcGlsZVVuc2FmZShzZWxlY3Rvciwgb3B0aW9ucywgY29udGV4dCk7XG4gICAgcmV0dXJuIHN1YnNlbGVjdHNfMS5lbnN1cmVJc1RhZyhuZXh0LCBvcHRpb25zLmFkYXB0ZXIpO1xufVxuZXhwb3J0cy5jb21waWxlID0gY29tcGlsZTtcbmZ1bmN0aW9uIGNvbXBpbGVVbnNhZmUoc2VsZWN0b3IsIG9wdGlvbnMsIGNvbnRleHQpIHtcbiAgICB2YXIgdG9rZW4gPSBjc3Nfd2hhdF8xLnBhcnNlKHNlbGVjdG9yLCBvcHRpb25zKTtcbiAgICByZXR1cm4gY29tcGlsZVRva2VuKHRva2VuLCBvcHRpb25zLCBjb250ZXh0KTtcbn1cbmV4cG9ydHMuY29tcGlsZVVuc2FmZSA9IGNvbXBpbGVVbnNhZmU7XG5mdW5jdGlvbiBpbmNsdWRlc1Njb3BlUHNldWRvKHQpIHtcbiAgICByZXR1cm4gKHQudHlwZSA9PT0gXCJwc2V1ZG9cIiAmJlxuICAgICAgICAodC5uYW1lID09PSBcInNjb3BlXCIgfHxcbiAgICAgICAgICAgIChBcnJheS5pc0FycmF5KHQuZGF0YSkgJiZcbiAgICAgICAgICAgICAgICB0LmRhdGEuc29tZShmdW5jdGlvbiAoZGF0YSkgeyByZXR1cm4gZGF0YS5zb21lKGluY2x1ZGVzU2NvcGVQc2V1ZG8pOyB9KSkpKTtcbn1cbnZhciBERVNDRU5EQU5UX1RPS0VOID0geyB0eXBlOiBcImRlc2NlbmRhbnRcIiB9O1xudmFyIEZMRVhJQkxFX0RFU0NFTkRBTlRfVE9LRU4gPSB7XG4gICAgdHlwZTogXCJfZmxleGlibGVEZXNjZW5kYW50XCIsXG59O1xudmFyIFNDT1BFX1RPS0VOID0geyB0eXBlOiBcInBzZXVkb1wiLCBuYW1lOiBcInNjb3BlXCIsIGRhdGE6IG51bGwgfTtcbi8qXG4gKiBDU1MgNCBTcGVjIChEcmFmdCk6IDMuMy4xLiBBYnNvbHV0aXppbmcgYSBTY29wZS1yZWxhdGl2ZSBTZWxlY3RvclxuICogaHR0cDovL3d3dy53My5vcmcvVFIvc2VsZWN0b3JzNC8jYWJzb2x1dGl6aW5nXG4gKi9cbmZ1bmN0aW9uIGFic29sdXRpemUodG9rZW4sIF9hLCBjb250ZXh0KSB7XG4gICAgdmFyIGFkYXB0ZXIgPSBfYS5hZGFwdGVyO1xuICAgIC8vIFRPRE8gVXNlIGJldHRlciBjaGVjayBpZiB0aGUgY29udGV4dCBpcyBhIGRvY3VtZW50XG4gICAgdmFyIGhhc0NvbnRleHQgPSAhIShjb250ZXh0ID09PSBudWxsIHx8IGNvbnRleHQgPT09IHZvaWQgMCA/IHZvaWQgMCA6IGNvbnRleHQuZXZlcnkoZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgdmFyIHBhcmVudCA9IGFkYXB0ZXIuZ2V0UGFyZW50KGUpO1xuICAgICAgICByZXR1cm4gZSA9PT0gc3Vic2VsZWN0c18xLlBMQUNFSE9MREVSX0VMRU1FTlQgfHwgISEocGFyZW50ICYmIGFkYXB0ZXIuaXNUYWcocGFyZW50KSk7XG4gICAgfSkpO1xuICAgIGZvciAodmFyIF9pID0gMCwgdG9rZW5fMSA9IHRva2VuOyBfaSA8IHRva2VuXzEubGVuZ3RoOyBfaSsrKSB7XG4gICAgICAgIHZhciB0ID0gdG9rZW5fMVtfaV07XG4gICAgICAgIGlmICh0Lmxlbmd0aCA+IDAgJiYgcHJvY2VkdXJlXzEuaXNUcmF2ZXJzYWwodFswXSkgJiYgdFswXS50eXBlICE9PSBcImRlc2NlbmRhbnRcIikge1xuICAgICAgICAgICAgLy8gRG9uJ3QgY29udGludWUgaW4gZWxzZSBicmFuY2hcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChoYXNDb250ZXh0ICYmICF0LnNvbWUoaW5jbHVkZXNTY29wZVBzZXVkbykpIHtcbiAgICAgICAgICAgIHQudW5zaGlmdChERVNDRU5EQU5UX1RPS0VOKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIHQudW5zaGlmdChTQ09QRV9UT0tFTik7XG4gICAgfVxufVxuZnVuY3Rpb24gY29tcGlsZVRva2VuKHRva2VuLCBvcHRpb25zLCBjb250ZXh0KSB7XG4gICAgdmFyIF9hO1xuICAgIHRva2VuID0gdG9rZW4uZmlsdGVyKGZ1bmN0aW9uICh0KSB7IHJldHVybiB0Lmxlbmd0aCA+IDA7IH0pO1xuICAgIHRva2VuLmZvckVhY2goc29ydF8xLmRlZmF1bHQpO1xuICAgIGNvbnRleHQgPSAoX2EgPSBvcHRpb25zLmNvbnRleHQpICE9PSBudWxsICYmIF9hICE9PSB2b2lkIDAgPyBfYSA6IGNvbnRleHQ7XG4gICAgdmFyIGlzQXJyYXlDb250ZXh0ID0gQXJyYXkuaXNBcnJheShjb250ZXh0KTtcbiAgICB2YXIgZmluYWxDb250ZXh0ID0gY29udGV4dCAmJiAoQXJyYXkuaXNBcnJheShjb250ZXh0KSA/IGNvbnRleHQgOiBbY29udGV4dF0pO1xuICAgIGFic29sdXRpemUodG9rZW4sIG9wdGlvbnMsIGZpbmFsQ29udGV4dCk7XG4gICAgdmFyIHNob3VsZFRlc3ROZXh0U2libGluZ3MgPSBmYWxzZTtcbiAgICB2YXIgcXVlcnkgPSB0b2tlblxuICAgICAgICAubWFwKGZ1bmN0aW9uIChydWxlcykge1xuICAgICAgICBpZiAocnVsZXMubGVuZ3RoID49IDIpIHtcbiAgICAgICAgICAgIHZhciBmaXJzdCA9IHJ1bGVzWzBdLCBzZWNvbmQgPSBydWxlc1sxXTtcbiAgICAgICAgICAgIGlmIChmaXJzdC50eXBlICE9PSBcInBzZXVkb1wiIHx8IGZpcnN0Lm5hbWUgIT09IFwic2NvcGVcIikge1xuICAgICAgICAgICAgICAgIC8vIElnbm9yZVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoaXNBcnJheUNvbnRleHQgJiYgc2Vjb25kLnR5cGUgPT09IFwiZGVzY2VuZGFudFwiKSB7XG4gICAgICAgICAgICAgICAgcnVsZXNbMV0gPSBGTEVYSUJMRV9ERVNDRU5EQU5UX1RPS0VOO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoc2Vjb25kLnR5cGUgPT09IFwiYWRqYWNlbnRcIiB8fFxuICAgICAgICAgICAgICAgIHNlY29uZC50eXBlID09PSBcInNpYmxpbmdcIikge1xuICAgICAgICAgICAgICAgIHNob3VsZFRlc3ROZXh0U2libGluZ3MgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb21waWxlUnVsZXMocnVsZXMsIG9wdGlvbnMsIGZpbmFsQ29udGV4dCk7XG4gICAgfSlcbiAgICAgICAgLnJlZHVjZShyZWR1Y2VSdWxlcywgYm9vbGJhc2VfMS5mYWxzZUZ1bmMpO1xuICAgIHF1ZXJ5LnNob3VsZFRlc3ROZXh0U2libGluZ3MgPSBzaG91bGRUZXN0TmV4dFNpYmxpbmdzO1xuICAgIHJldHVybiBxdWVyeTtcbn1cbmV4cG9ydHMuY29tcGlsZVRva2VuID0gY29tcGlsZVRva2VuO1xuZnVuY3Rpb24gY29tcGlsZVJ1bGVzKHJ1bGVzLCBvcHRpb25zLCBjb250ZXh0KSB7XG4gICAgdmFyIF9hO1xuICAgIHJldHVybiBydWxlcy5yZWR1Y2UoZnVuY3Rpb24gKHByZXZpb3VzLCBydWxlKSB7XG4gICAgICAgIHJldHVybiBwcmV2aW91cyA9PT0gYm9vbGJhc2VfMS5mYWxzZUZ1bmNcbiAgICAgICAgICAgID8gYm9vbGJhc2VfMS5mYWxzZUZ1bmNcbiAgICAgICAgICAgIDogZ2VuZXJhbF8xLmNvbXBpbGVHZW5lcmFsU2VsZWN0b3IocHJldmlvdXMsIHJ1bGUsIG9wdGlvbnMsIGNvbnRleHQsIGNvbXBpbGVUb2tlbik7XG4gICAgfSwgKF9hID0gb3B0aW9ucy5yb290RnVuYykgIT09IG51bGwgJiYgX2EgIT09IHZvaWQgMCA/IF9hIDogYm9vbGJhc2VfMS50cnVlRnVuYyk7XG59XG5mdW5jdGlvbiByZWR1Y2VSdWxlcyhhLCBiKSB7XG4gICAgaWYgKGIgPT09IGJvb2xiYXNlXzEuZmFsc2VGdW5jIHx8IGEgPT09IGJvb2xiYXNlXzEudHJ1ZUZ1bmMpIHtcbiAgICAgICAgcmV0dXJuIGE7XG4gICAgfVxuICAgIGlmIChhID09PSBib29sYmFzZV8xLmZhbHNlRnVuYyB8fCBiID09PSBib29sYmFzZV8xLnRydWVGdW5jKSB7XG4gICAgICAgIHJldHVybiBiO1xuICAgIH1cbiAgICByZXR1cm4gZnVuY3Rpb24gY29tYmluZShlbGVtKSB7XG4gICAgICAgIHJldHVybiBhKGVsZW0pIHx8IGIoZWxlbSk7XG4gICAgfTtcbn1cbiJdfQ==