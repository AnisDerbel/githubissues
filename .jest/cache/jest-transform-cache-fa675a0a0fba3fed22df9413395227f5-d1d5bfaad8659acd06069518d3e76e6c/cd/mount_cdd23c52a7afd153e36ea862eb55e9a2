13610afb5e626c7d3ed3db2fc68966bc
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _omitBy = _interopRequireDefault(require("lodash/omitBy"));

var _isNil = _interopRequireDefault(require("lodash/isNil"));

var _reactIs = require("react-is");

var _Debug = require("enzyme/build/Debug");

var _RSTTraversal = require("enzyme/build/RSTTraversal");

var _utils = require("./utils");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function ownKeys(object, enumerableOnly) {
  var keys = Object.keys(object);

  if (Object.getOwnPropertySymbols) {
    var symbols = Object.getOwnPropertySymbols(object);
    if (enumerableOnly) symbols = symbols.filter(function (sym) {
      return Object.getOwnPropertyDescriptor(object, sym).enumerable;
    });
    keys.push.apply(keys, symbols);
  }

  return keys;
}

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};

    if (i % 2) {
      ownKeys(Object(source), true).forEach(function (key) {
        _defineProperty(target, key, source[key]);
      });
    } else if (Object.getOwnPropertyDescriptors) {
      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));
    } else {
      ownKeys(Object(source)).forEach(function (key) {
        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));
      });
    }
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

function getChildren(node, options) {
  if (options.mode === 'shallow' && typeof node.type === 'function') {
    return null;
  }

  var children = (0, _utils.compact)((0, _RSTTraversal.childrenOfNode)(node).map(function (n) {
    return internalNodeToJson(n, options);
  }));
  return children.length > 0 ? children : null;
}

function getProps(node, options) {
  var props = (0, _omitBy.default)(_objectSpread({}, (0, _RSTTraversal.propsOfNode)(node)), function (val, key) {
    return key === 'children' || val === undefined;
  });

  if (!(0, _isNil.default)(node.key) && options.noKey !== true) {
    props.key = node.key;
  }

  return props;
}

function internalNodeToJson(node, options) {
  if (typeof node === 'string' || typeof node === 'number') {
    return node;
  }

  if ((0, _isNil.default)(node) || node === false) {
    return '';
  }

  if (Array.isArray(node)) {
    if (node.length === 1) {
      return internalNodeToJson(node[0], options);
    }

    return node.map(function (child) {
      return internalNodeToJson(child, options);
    });
  }

  if (options.mode === 'deep' && (typeof node.type === 'function' || node.type.$$typeof === _reactIs.ForwardRef || node.type.$$typeof === _reactIs.Memo)) {
    return internalNodeToJson(node.rendered, options);
  }

  return (0, _utils.applyMap)({
    node: node,
    type: (0, _Debug.typeName)(node),
    props: getProps(node, options),
    children: getChildren(node, options),
    $$typeof: Symbol.for('react.test.json')
  }, options);
}

var mountToJson = function mountToJson(wrapper) {
  var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};

  if ((0, _isNil.default)(wrapper) || wrapper.length === 0) {
    return null;
  }

  if (wrapper.length > 1 && typeof wrapper.getNodesInternal === 'function') {
    var nodes = wrapper.getNodesInternal();
    return nodes.map(function (node) {
      return internalNodeToJson(node, options);
    });
  }

  if (typeof wrapper.getNodeInternal === 'function') {
    var node = wrapper.getNodeInternal();
    return internalNodeToJson(node, options);
  }

  return null;
};

var _default = mountToJson;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vdW50LmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZGVmYXVsdCIsIl9vbWl0QnkiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9pc05pbCIsIl9yZWFjdElzIiwiX0RlYnVnIiwiX1JTVFRyYXZlcnNhbCIsIl91dGlscyIsIm9iaiIsIl9fZXNNb2R1bGUiLCJvd25LZXlzIiwib2JqZWN0IiwiZW51bWVyYWJsZU9ubHkiLCJrZXlzIiwiZ2V0T3duUHJvcGVydHlTeW1ib2xzIiwic3ltYm9scyIsImZpbHRlciIsInN5bSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsImVudW1lcmFibGUiLCJwdXNoIiwiYXBwbHkiLCJfb2JqZWN0U3ByZWFkIiwidGFyZ2V0IiwiaSIsImFyZ3VtZW50cyIsImxlbmd0aCIsInNvdXJjZSIsImZvckVhY2giLCJrZXkiLCJfZGVmaW5lUHJvcGVydHkiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzIiwiZGVmaW5lUHJvcGVydGllcyIsImNvbmZpZ3VyYWJsZSIsIndyaXRhYmxlIiwiZ2V0Q2hpbGRyZW4iLCJub2RlIiwib3B0aW9ucyIsIm1vZGUiLCJ0eXBlIiwiY2hpbGRyZW4iLCJjb21wYWN0IiwiY2hpbGRyZW5PZk5vZGUiLCJtYXAiLCJuIiwiaW50ZXJuYWxOb2RlVG9Kc29uIiwiZ2V0UHJvcHMiLCJwcm9wcyIsInByb3BzT2ZOb2RlIiwidmFsIiwidW5kZWZpbmVkIiwibm9LZXkiLCJBcnJheSIsImlzQXJyYXkiLCJjaGlsZCIsIiQkdHlwZW9mIiwiRm9yd2FyZFJlZiIsIk1lbW8iLCJyZW5kZXJlZCIsImFwcGx5TWFwIiwidHlwZU5hbWUiLCJTeW1ib2wiLCJmb3IiLCJtb3VudFRvSnNvbiIsIndyYXBwZXIiLCJnZXROb2Rlc0ludGVybmFsIiwibm9kZXMiLCJnZXROb2RlSW50ZXJuYWwiLCJfZGVmYXVsdCJdLCJtYXBwaW5ncyI6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TUFBSXNDLE9BQU8sQ0FBQ3RDLE1BQVIsR0FBaUIsQ0FBakIsSUFBc0IsT0FBT3NDLE9BQU8sQ0FBQ0MsZ0JBQWYsS0FBb0MsVUFBOUQsRUFBMEU7QUFDeEUsUUFBTUMsS0FBSyxHQUFHRixPQUFPLENBQUNDLGdCQUFSLEVBQWQ7QUFDQSxXQUFPQyxLQUFLLENBQUN2QixHQUFOLENBQVUsVUFBQVAsSUFBSTtBQUFBLGFBQUlTLGtCQUFrQixDQUFDVCxJQUFELEVBQU9DLE9BQVAsQ0FBdEI7QUFBQSxLQUFkLENBQVA7QUFDRDs7QUFFRCxNQUFJLE9BQU8yQixPQUFPLENBQUNHLGVBQWYsS0FBbUMsVUFBdkMsRUFBbUQ7QUFDakQsUUFBTS9CLElBQUksR0FBRzRCLE9BQU8sQ0FBQ0csZUFBUixFQUFiO0FBQ0EsV0FBT3RCLGtCQUFrQixDQUFDVCxJQUFELEVBQU9DLE9BQVAsQ0FBekI7QUFDRDs7QUFFRCxTQUFPLElBQVA7QUFDRCxDQWhCRDs7QUFrQkEsSUFBSStCLFFBQVEsR0FBR0wsV0FBZjtBQUNBbEUsT0FBTyxDQUFDRSxPQUFSLEdBQWtCcUUsUUFBbEIiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7XG4gIHZhbHVlOiB0cnVlXG59KTtcbmV4cG9ydHMuZGVmYXVsdCA9IHZvaWQgMDtcblxudmFyIF9vbWl0QnkgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJsb2Rhc2gvb21pdEJ5XCIpKTtcblxudmFyIF9pc05pbCA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZShcImxvZGFzaC9pc05pbFwiKSk7XG5cbnZhciBfcmVhY3RJcyA9IHJlcXVpcmUoXCJyZWFjdC1pc1wiKTtcblxudmFyIF9EZWJ1ZyA9IHJlcXVpcmUoXCJlbnp5bWUvYnVpbGQvRGVidWdcIik7XG5cbnZhciBfUlNUVHJhdmVyc2FsID0gcmVxdWlyZShcImVuenltZS9idWlsZC9SU1RUcmF2ZXJzYWxcIik7XG5cbnZhciBfdXRpbHMgPSByZXF1aXJlKFwiLi91dGlsc1wiKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuZnVuY3Rpb24gb3duS2V5cyhvYmplY3QsIGVudW1lcmFibGVPbmx5KSB7IHZhciBrZXlzID0gT2JqZWN0LmtleXMob2JqZWN0KTsgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMpIHsgdmFyIHN5bWJvbHMgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKG9iamVjdCk7IGlmIChlbnVtZXJhYmxlT25seSkgc3ltYm9scyA9IHN5bWJvbHMuZmlsdGVyKGZ1bmN0aW9uIChzeW0pIHsgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Iob2JqZWN0LCBzeW0pLmVudW1lcmFibGU7IH0pOyBrZXlzLnB1c2guYXBwbHkoa2V5cywgc3ltYm9scyk7IH0gcmV0dXJuIGtleXM7IH1cblxuZnVuY3Rpb24gX29iamVjdFNwcmVhZCh0YXJnZXQpIHsgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsgdmFyIHNvdXJjZSA9IGFyZ3VtZW50c1tpXSAhPSBudWxsID8gYXJndW1lbnRzW2ldIDoge307IGlmIChpICUgMikgeyBvd25LZXlzKE9iamVjdChzb3VyY2UpLCB0cnVlKS5mb3JFYWNoKGZ1bmN0aW9uIChrZXkpIHsgX2RlZmluZVByb3BlcnR5KHRhcmdldCwga2V5LCBzb3VyY2Vba2V5XSk7IH0pOyB9IGVsc2UgaWYgKE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3JzKSB7IE9iamVjdC5kZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcnMoc291cmNlKSk7IH0gZWxzZSB7IG93bktleXMoT2JqZWN0KHNvdXJjZSkpLmZvckVhY2goZnVuY3Rpb24gKGtleSkgeyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBrZXkpKTsgfSk7IH0gfSByZXR1cm4gdGFyZ2V0OyB9XG5cbmZ1bmN0aW9uIF9kZWZpbmVQcm9wZXJ0eShvYmosIGtleSwgdmFsdWUpIHsgaWYgKGtleSBpbiBvYmopIHsgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7IHZhbHVlOiB2YWx1ZSwgZW51bWVyYWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlLCB3cml0YWJsZTogdHJ1ZSB9KTsgfSBlbHNlIHsgb2JqW2tleV0gPSB2YWx1ZTsgfSByZXR1cm4gb2JqOyB9XG5cbmZ1bmN0aW9uIGdldENoaWxkcmVuKG5vZGUsIG9wdGlvbnMpIHtcbiAgaWYgKG9wdGlvbnMubW9kZSA9PT0gJ3NoYWxsb3cnICYmIHR5cGVvZiBub2RlLnR5cGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IGNoaWxkcmVuID0gKDAsIF91dGlscy5jb21wYWN0KSgoMCwgX1JTVFRyYXZlcnNhbC5jaGlsZHJlbk9mTm9kZSkobm9kZSkubWFwKG4gPT4gaW50ZXJuYWxOb2RlVG9Kc29uKG4sIG9wdGlvbnMpKSk7XG4gIHJldHVybiBjaGlsZHJlbi5sZW5ndGggPiAwID8gY2hpbGRyZW4gOiBudWxsO1xufVxuXG5mdW5jdGlvbiBnZXRQcm9wcyhub2RlLCBvcHRpb25zKSB7XG4gIGNvbnN0IHByb3BzID0gKDAsIF9vbWl0QnkuZGVmYXVsdCkoX29iamVjdFNwcmVhZCh7fSwgKDAsIF9SU1RUcmF2ZXJzYWwucHJvcHNPZk5vZGUpKG5vZGUpKSwgKHZhbCwga2V5KSA9PiB7XG4gICAgcmV0dXJuIGtleSA9PT0gJ2NoaWxkcmVuJyB8fCB2YWwgPT09IHVuZGVmaW5lZDtcbiAgfSk7XG5cbiAgaWYgKCEoMCwgX2lzTmlsLmRlZmF1bHQpKG5vZGUua2V5KSAmJiBvcHRpb25zLm5vS2V5ICE9PSB0cnVlKSB7XG4gICAgcHJvcHMua2V5ID0gbm9kZS5rZXk7XG4gIH1cblxuICByZXR1cm4gcHJvcHM7XG59XG5cbmZ1bmN0aW9uIGludGVybmFsTm9kZVRvSnNvbihub2RlLCBvcHRpb25zKSB7XG4gIGlmICh0eXBlb2Ygbm9kZSA9PT0gJ3N0cmluZycgfHwgdHlwZW9mIG5vZGUgPT09ICdudW1iZXInKSB7XG4gICAgcmV0dXJuIG5vZGU7XG4gIH1cblxuICBpZiAoKDAsIF9pc05pbC5kZWZhdWx0KShub2RlKSB8fCBub2RlID09PSBmYWxzZSkge1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KG5vZGUpKSB7XG4gICAgLy8gZW56eW1lIGRvZXMgc29tZSBmdW5ueSBzdHVmZiB3aXRoIG1lbW8gZnVuY3Rpb24gY29tcG9uZW50cyB0dXJuaW5nIHRoZSBjaGlsZHJlblxuICAgIC8vIGludG8gYW4gYXJyYXkgcmVzdWx0aW5nIGluIHVuZGVzaXJhYmxlIHNuYXBzaG90c1xuICAgIGlmIChub2RlLmxlbmd0aCA9PT0gMSkge1xuICAgICAgcmV0dXJuIGludGVybmFsTm9kZVRvSnNvbihub2RlWzBdLCBvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbm9kZS5tYXAoY2hpbGQgPT4gaW50ZXJuYWxOb2RlVG9Kc29uKGNoaWxkLCBvcHRpb25zKSk7XG4gIH1cblxuICBpZiAob3B0aW9ucy5tb2RlID09PSAnZGVlcCcgJiYgKHR5cGVvZiBub2RlLnR5cGUgPT09ICdmdW5jdGlvbicgfHwgbm9kZS50eXBlLiQkdHlwZW9mID09PSBfcmVhY3RJcy5Gb3J3YXJkUmVmIHx8IG5vZGUudHlwZS4kJHR5cGVvZiA9PT0gX3JlYWN0SXMuTWVtbykpIHtcbiAgICByZXR1cm4gaW50ZXJuYWxOb2RlVG9Kc29uKG5vZGUucmVuZGVyZWQsIG9wdGlvbnMpO1xuICB9XG5cbiAgcmV0dXJuICgwLCBfdXRpbHMuYXBwbHlNYXApKHtcbiAgICBub2RlLFxuICAgIHR5cGU6ICgwLCBfRGVidWcudHlwZU5hbWUpKG5vZGUpLFxuICAgIHByb3BzOiBnZXRQcm9wcyhub2RlLCBvcHRpb25zKSxcbiAgICBjaGlsZHJlbjogZ2V0Q2hpbGRyZW4obm9kZSwgb3B0aW9ucyksXG4gICAgJCR0eXBlb2Y6IFN5bWJvbC5mb3IoJ3JlYWN0LnRlc3QuanNvbicpXG4gIH0sIG9wdGlvbnMpO1xufVxuXG5jb25zdCBtb3VudFRvSnNvbiA9ICh3cmFwcGVyLCBvcHRpb25zID0ge30pID0+IHtcbiAgaWYgKCgwLCBfaXNOaWwuZGVmYXVsdCkod3JhcHBlcikgfHwgd3JhcHBlci5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIGlmICh3cmFwcGVyLmxlbmd0aCA+IDEgJiYgdHlwZW9mIHdyYXBwZXIuZ2V0Tm9kZXNJbnRlcm5hbCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGNvbnN0IG5vZGVzID0gd3JhcHBlci5nZXROb2Rlc0ludGVybmFsKCk7XG4gICAgcmV0dXJuIG5vZGVzLm1hcChub2RlID0+IGludGVybmFsTm9kZVRvSnNvbihub2RlLCBvcHRpb25zKSk7XG4gIH1cblxuICBpZiAodHlwZW9mIHdyYXBwZXIuZ2V0Tm9kZUludGVybmFsID09PSAnZnVuY3Rpb24nKSB7XG4gICAgY29uc3Qgbm9kZSA9IHdyYXBwZXIuZ2V0Tm9kZUludGVybmFsKCk7XG4gICAgcmV0dXJuIGludGVybmFsTm9kZVRvSnNvbihub2RlLCBvcHRpb25zKTtcbiAgfVxuXG4gIHJldHVybiBudWxsO1xufTtcblxudmFyIF9kZWZhdWx0ID0gbW91bnRUb0pzb247XG5leHBvcnRzLmRlZmF1bHQgPSBfZGVmYXVsdDsiXX0=