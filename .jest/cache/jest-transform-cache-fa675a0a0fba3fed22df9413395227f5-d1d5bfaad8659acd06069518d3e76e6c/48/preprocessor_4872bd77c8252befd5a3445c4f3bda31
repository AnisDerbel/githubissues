280fd665f409fb88e5a75e71932f1e58
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var unicode = require('../common/unicode');

var ERR = require('../common/error-codes');

var $ = unicode.CODE_POINTS;
var DEFAULT_BUFFER_WATERLINE = 1 << 16;

var Preprocessor = function () {
  function Preprocessor() {
    (0, _classCallCheck2.default)(this, Preprocessor);
    this.html = null;
    this.pos = -1;
    this.lastGapPos = -1;
    this.lastCharPos = -1;
    this.gapStack = [];
    this.skipNextNewLine = false;
    this.lastChunkWritten = false;
    this.endOfChunkHit = false;
    this.bufferWaterline = DEFAULT_BUFFER_WATERLINE;
  }

  (0, _createClass2.default)(Preprocessor, [{
    key: "_err",
    value: function _err() {}
  }, {
    key: "_addGap",
    value: function _addGap() {
      this.gapStack.push(this.lastGapPos);
      this.lastGapPos = this.pos;
    }
  }, {
    key: "_processSurrogate",
    value: function _processSurrogate(cp) {
      if (this.pos !== this.lastCharPos) {
        var nextCp = this.html.charCodeAt(this.pos + 1);

        if (unicode.isSurrogatePair(nextCp)) {
          this.pos++;

          this._addGap();

          return unicode.getSurrogatePairCodePoint(cp, nextCp);
        }
      } else if (!this.lastChunkWritten) {
          this.endOfChunkHit = true;
          return $.EOF;
        }

      this._err(ERR.surrogateInInputStream);

      return cp;
    }
  }, {
    key: "dropParsedChunk",
    value: function dropParsedChunk() {
      if (this.pos > this.bufferWaterline) {
        this.lastCharPos -= this.pos;
        this.html = this.html.substring(this.pos);
        this.pos = 0;
        this.lastGapPos = -1;
        this.gapStack = [];
      }
    }
  }, {
    key: "write",
    value: function write(chunk, isLastChunk) {
      if (this.html) {
        this.html += chunk;
      } else {
        this.html = chunk;
      }

      this.lastCharPos = this.html.length - 1;
      this.endOfChunkHit = false;
      this.lastChunkWritten = isLastChunk;
    }
  }, {
    key: "insertHtmlAtCurrentPos",
    value: function insertHtmlAtCurrentPos(chunk) {
      this.html = this.html.substring(0, this.pos + 1) + chunk + this.html.substring(this.pos + 1, this.html.length);
      this.lastCharPos = this.html.length - 1;
      this.endOfChunkHit = false;
    }
  }, {
    key: "advance",
    value: function advance() {
      this.pos++;

      if (this.pos > this.lastCharPos) {
        this.endOfChunkHit = !this.lastChunkWritten;
        return $.EOF;
      }

      var cp = this.html.charCodeAt(this.pos);

      if (this.skipNextNewLine && cp === $.LINE_FEED) {
        this.skipNextNewLine = false;

        this._addGap();

        return this.advance();
      }

      if (cp === $.CARRIAGE_RETURN) {
        this.skipNextNewLine = true;
        return $.LINE_FEED;
      }

      this.skipNextNewLine = false;

      if (unicode.isSurrogate(cp)) {
        cp = this._processSurrogate(cp);
      }

      var isCommonValidRange = cp > 0x1f && cp < 0x7f || cp === $.LINE_FEED || cp === $.CARRIAGE_RETURN || cp > 0x9f && cp < 0xfdd0;

      if (!isCommonValidRange) {
        this._checkForProblematicCharacters(cp);
      }

      return cp;
    }
  }, {
    key: "_checkForProblematicCharacters",
    value: function _checkForProblematicCharacters(cp) {
      if (unicode.isControlCodePoint(cp)) {
        this._err(ERR.controlCharacterInInputStream);
      } else if (unicode.isUndefinedCodePoint(cp)) {
        this._err(ERR.noncharacterInInputStream);
      }
    }
  }, {
    key: "retreat",
    value: function retreat() {
      if (this.pos === this.lastGapPos) {
        this.lastGapPos = this.gapStack.pop();
        this.pos--;
      }

      this.pos--;
    }
  }]);
  return Preprocessor;
}();

module.exports = Preprocessor;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInByZXByb2Nlc3Nvci5qcyJdLCJuYW1lcyI6WyJ1bmljb2RlIiwicmVxdWlyZSIsIkVSUiIsIiQiLCJDT0RFX1BPSU5UUyIsIkRFRkFVTFRfQlVGRkVSX1dBVEVSTElORSIsIlByZXByb2Nlc3NvciIsImh0bWwiLCJwb3MiLCJsYXN0R2FwUG9zIiwibGFzdENoYXJQb3MiLCJnYXBTdGFjayIsInNraXBOZXh0TmV3TGluZSIsImxhc3RDaHVua1dyaXR0ZW4iLCJlbmRPZkNodW5rSGl0IiwiYnVmZmVyV2F0ZXJsaW5lIiwicHVzaCIsImNwIiwibmV4dENwIiwiY2hhckNvZGVBdCIsImlzU3Vycm9nYXRlUGFpciIsIl9hZGRHYXAiLCJnZXRTdXJyb2dhdGVQYWlyQ29kZVBvaW50IiwiRU9GIiwiX2VyciIsInN1cnJvZ2F0ZUluSW5wdXRTdHJlYW0iLCJzdWJzdHJpbmciLCJjaHVuayIsImlzTGFzdENodW5rIiwibGVuZ3RoIiwiTElORV9GRUVEIiwiYWR2YW5jZSIsIkNBUlJJQUdFX1JFVFVSTiIsImlzU3Vycm9nYXRlIiwiX3Byb2Nlc3NTdXJyb2dhdGUiLCJpc0NvbW1vblZhbGlkUmFuZ2UiLCJfY2hlY2tGb3JQcm9ibGVtYXRpY0NoYXJhY3RlcnMiLCJpc0NvbnRyb2xDb2RlUG9pbnQiLCJjb250cm9sQ2hhcmFjdGVySW5JbnB1dFN0cmVhbSIsImlzVW5kZWZpbmVkQ29kZVBvaW50Iiwibm9uY2hhcmFjdGVySW5JbnB1dFN0cmVhbSIsInBvcCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUVBLElBQU1BLE9BQU8sR0FBR0MsT0FBTyxDQUFDLG1CQUFELENBQXZCOztBQUNBLElBQU1DLEdBQUcsR0FBR0QsT0FBTyxDQUFDLHVCQUFELENBQW5COztBQUdBLElBQU1FLENBQUMsR0FBR0gsT0FBTyxDQUFDSSxXQUFsQjtBQUdBLElBQU1DLHdCQUF3QixHQUFHLEtBQUssRUFBdEM7O0lBS01DLFk7QUFDRiwwQkFBYztBQUFB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QWQ7QUFDSCxPQUZELE1BRU8sSUFBSXRDLE9BQU8sQ0FBQ3VDLG9CQUFSLENBQTZCdEIsRUFBN0IsQ0FBSixFQUFzQztBQUN6QyxhQUFLTyxJQUFMLENBQVV0QixHQUFHLENBQUNzQyx5QkFBZDtBQUNIO0FBQ0o7OztXQUVELG1CQUFVO0FBQ04sVUFBSSxLQUFLaEMsR0FBTCxLQUFhLEtBQUtDLFVBQXRCLEVBQWtDO0FBQzlCLGFBQUtBLFVBQUwsR0FBa0IsS0FBS0UsUUFBTCxDQUFjOEIsR0FBZCxFQUFsQjtBQUNBLGFBQUtqQyxHQUFMO0FBQ0g7O0FBRUQsV0FBS0EsR0FBTDtBQUNIOzs7OztBQUdMa0MsTUFBTSxDQUFDQyxPQUFQLEdBQWlCckMsWUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IHVuaWNvZGUgPSByZXF1aXJlKCcuLi9jb21tb24vdW5pY29kZScpO1xuY29uc3QgRVJSID0gcmVxdWlyZSgnLi4vY29tbW9uL2Vycm9yLWNvZGVzJyk7XG5cbi8vQWxpYXNlc1xuY29uc3QgJCA9IHVuaWNvZGUuQ09ERV9QT0lOVFM7XG5cbi8vQ29uc3RcbmNvbnN0IERFRkFVTFRfQlVGRkVSX1dBVEVSTElORSA9IDEgPDwgMTY7XG5cbi8vUHJlcHJvY2Vzc29yXG4vL05PVEU6IEhUTUwgaW5wdXQgcHJlcHJvY2Vzc2luZ1xuLy8oc2VlOiBodHRwOi8vd3d3LndoYXR3Zy5vcmcvc3BlY3Mvd2ViLWFwcHMvY3VycmVudC13b3JrL211bHRpcGFnZS9wYXJzaW5nLmh0bWwjcHJlcHJvY2Vzc2luZy10aGUtaW5wdXQtc3RyZWFtKVxuY2xhc3MgUHJlcHJvY2Vzc29yIHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5odG1sID0gbnVsbDtcblxuICAgICAgICB0aGlzLnBvcyA9IC0xO1xuICAgICAgICB0aGlzLmxhc3RHYXBQb3MgPSAtMTtcbiAgICAgICAgdGhpcy5sYXN0Q2hhclBvcyA9IC0xO1xuXG4gICAgICAgIHRoaXMuZ2FwU3RhY2sgPSBbXTtcblxuICAgICAgICB0aGlzLnNraXBOZXh0TmV3TGluZSA9IGZhbHNlO1xuXG4gICAgICAgIHRoaXMubGFzdENodW5rV3JpdHRlbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLmVuZE9mQ2h1bmtIaXQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5idWZmZXJXYXRlcmxpbmUgPSBERUZBVUxUX0JVRkZFUl9XQVRFUkxJTkU7XG4gICAgfVxuXG4gICAgX2VycigpIHtcbiAgICAgICAgLy8gTk9URTogZXJyIHJlcG9ydGluZyBpcyBub29wIGJ5IGRlZmF1bHQuIEVuYWJsZWQgYnkgbWl4aW4uXG4gICAgfVxuXG4gICAgX2FkZEdhcCgpIHtcbiAgICAgICAgdGhpcy5nYXBTdGFjay5wdXNoKHRoaXMubGFzdEdhcFBvcyk7XG4gICAgICAgIHRoaXMubGFzdEdhcFBvcyA9IHRoaXMucG9zO1xuICAgIH1cblxuICAgIF9wcm9jZXNzU3Vycm9nYXRlKGNwKSB7XG4gICAgICAgIC8vTk9URTogdHJ5IHRvIHBlZWsgYSBzdXJyb2dhdGUgcGFpclxuICAgICAgICBpZiAodGhpcy5wb3MgIT09IHRoaXMubGFzdENoYXJQb3MpIHtcbiAgICAgICAgICAgIGNvbnN0IG5leHRDcCA9IHRoaXMuaHRtbC5jaGFyQ29kZUF0KHRoaXMucG9zICsgMSk7XG5cbiAgICAgICAgICAgIGlmICh1bmljb2RlLmlzU3Vycm9nYXRlUGFpcihuZXh0Q3ApKSB7XG4gICAgICAgICAgICAgICAgLy9OT1RFOiB3ZSBoYXZlIGEgc3Vycm9nYXRlIHBhaXIuIFBlZWsgcGFpciBjaGFyYWN0ZXIgYW5kIHJlY2FsY3VsYXRlIGNvZGUgcG9pbnQuXG4gICAgICAgICAgICAgICAgdGhpcy5wb3MrKztcblxuICAgICAgICAgICAgICAgIC8vTk9URTogYWRkIGdhcCB0aGF0IHNob3VsZCBiZSBhdm9pZGVkIGR1cmluZyByZXRyZWF0XG4gICAgICAgICAgICAgICAgdGhpcy5fYWRkR2FwKCk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gdW5pY29kZS5nZXRTdXJyb2dhdGVQYWlyQ29kZVBvaW50KGNwLCBuZXh0Q3ApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy9OT1RFOiB3ZSBhcmUgYXQgdGhlIGVuZCBvZiBhIGNodW5rLCB0aGVyZWZvcmUgd2UgY2FuJ3QgaW5mZXIgc3Vycm9nYXRlIHBhaXIgeWV0LlxuICAgICAgICBlbHNlIGlmICghdGhpcy5sYXN0Q2h1bmtXcml0dGVuKSB7XG4gICAgICAgICAgICB0aGlzLmVuZE9mQ2h1bmtIaXQgPSB0cnVlO1xuICAgICAgICAgICAgcmV0dXJuICQuRU9GO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9OT1RFOiBpc29sYXRlZCBzdXJyb2dhdGVcbiAgICAgICAgdGhpcy5fZXJyKEVSUi5zdXJyb2dhdGVJbklucHV0U3RyZWFtKTtcblxuICAgICAgICByZXR1cm4gY3A7XG4gICAgfVxuXG4gICAgZHJvcFBhcnNlZENodW5rKCkge1xuICAgICAgICBpZiAodGhpcy5wb3MgPiB0aGlzLmJ1ZmZlcldhdGVybGluZSkge1xuICAgICAgICAgICAgdGhpcy5sYXN0Q2hhclBvcyAtPSB0aGlzLnBvcztcbiAgICAgICAgICAgIHRoaXMuaHRtbCA9IHRoaXMuaHRtbC5zdWJzdHJpbmcodGhpcy5wb3MpO1xuICAgICAgICAgICAgdGhpcy5wb3MgPSAwO1xuICAgICAgICAgICAgdGhpcy5sYXN0R2FwUG9zID0gLTE7XG4gICAgICAgICAgICB0aGlzLmdhcFN0YWNrID0gW107XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB3cml0ZShjaHVuaywgaXNMYXN0Q2h1bmspIHtcbiAgICAgICAgaWYgKHRoaXMuaHRtbCkge1xuICAgICAgICAgICAgdGhpcy5odG1sICs9IGNodW5rO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5odG1sID0gY2h1bms7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmxhc3RDaGFyUG9zID0gdGhpcy5odG1sLmxlbmd0aCAtIDE7XG4gICAgICAgIHRoaXMuZW5kT2ZDaHVua0hpdCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmxhc3RDaHVua1dyaXR0ZW4gPSBpc0xhc3RDaHVuaztcbiAgICB9XG5cbiAgICBpbnNlcnRIdG1sQXRDdXJyZW50UG9zKGNodW5rKSB7XG4gICAgICAgIHRoaXMuaHRtbCA9IHRoaXMuaHRtbC5zdWJzdHJpbmcoMCwgdGhpcy5wb3MgKyAxKSArIGNodW5rICsgdGhpcy5odG1sLnN1YnN0cmluZyh0aGlzLnBvcyArIDEsIHRoaXMuaHRtbC5sZW5ndGgpO1xuXG4gICAgICAgIHRoaXMubGFzdENoYXJQb3MgPSB0aGlzLmh0bWwubGVuZ3RoIC0gMTtcbiAgICAgICAgdGhpcy5lbmRPZkNodW5rSGl0ID0gZmFsc2U7XG4gICAgfVxuXG4gICAgYWR2YW5jZSgpIHtcbiAgICAgICAgdGhpcy5wb3MrKztcblxuICAgICAgICBpZiAodGhpcy5wb3MgPiB0aGlzLmxhc3RDaGFyUG9zKSB7XG4gICAgICAgICAgICB0aGlzLmVuZE9mQ2h1bmtIaXQgPSAhdGhpcy5sYXN0Q2h1bmtXcml0dGVuO1xuICAgICAgICAgICAgcmV0dXJuICQuRU9GO1xuICAgICAgICB9XG5cbiAgICAgICAgbGV0IGNwID0gdGhpcy5odG1sLmNoYXJDb2RlQXQodGhpcy5wb3MpO1xuXG4gICAgICAgIC8vTk9URTogYW55IFUrMDAwQSBMSU5FIEZFRUQgKExGKSBjaGFyYWN0ZXJzIHRoYXQgaW1tZWRpYXRlbHkgZm9sbG93IGEgVSswMDBEIENBUlJJQUdFIFJFVFVSTiAoQ1IpIGNoYXJhY3RlclxuICAgICAgICAvL211c3QgYmUgaWdub3JlZC5cbiAgICAgICAgaWYgKHRoaXMuc2tpcE5leHROZXdMaW5lICYmIGNwID09PSAkLkxJTkVfRkVFRCkge1xuICAgICAgICAgICAgdGhpcy5za2lwTmV4dE5ld0xpbmUgPSBmYWxzZTtcbiAgICAgICAgICAgIHRoaXMuX2FkZEdhcCgpO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWR2YW5jZSgpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy9OT1RFOiBhbGwgVSswMDBEIENBUlJJQUdFIFJFVFVSTiAoQ1IpIGNoYXJhY3RlcnMgbXVzdCBiZSBjb252ZXJ0ZWQgdG8gVSswMDBBIExJTkUgRkVFRCAoTEYpIGNoYXJhY3RlcnNcbiAgICAgICAgaWYgKGNwID09PSAkLkNBUlJJQUdFX1JFVFVSTikge1xuICAgICAgICAgICAgdGhpcy5za2lwTmV4dE5ld0xpbmUgPSB0cnVlO1xuICAgICAgICAgICAgcmV0dXJuICQuTElORV9GRUVEO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5za2lwTmV4dE5ld0xpbmUgPSBmYWxzZTtcblxuICAgICAgICBpZiAodW5pY29kZS5pc1N1cnJvZ2F0ZShjcCkpIHtcbiAgICAgICAgICAgIGNwID0gdGhpcy5fcHJvY2Vzc1N1cnJvZ2F0ZShjcCk7XG4gICAgICAgIH1cblxuICAgICAgICAvL09QVElNSVpBVElPTjogZmlyc3QgY2hlY2sgaWYgY29kZSBwb2ludCBpcyBpbiB0aGUgY29tbW9uIGFsbG93ZWRcbiAgICAgICAgLy9yYW5nZSAoQVNDSUkgYWxwaGFudW1lcmljLCB3aGl0ZXNwYWNlcywgYmlnIGNodW5rIG9mIEJNUClcbiAgICAgICAgLy9iZWZvcmUgZ29pbmcgaW50byBkZXRhaWxlZCBwZXJmb3JtYW5jZSBjb3N0IHZhbGlkYXRpb24uXG4gICAgICAgIGNvbnN0IGlzQ29tbW9uVmFsaWRSYW5nZSA9XG4gICAgICAgICAgICAoY3AgPiAweDFmICYmIGNwIDwgMHg3ZikgfHwgY3AgPT09ICQuTElORV9GRUVEIHx8IGNwID09PSAkLkNBUlJJQUdFX1JFVFVSTiB8fCAoY3AgPiAweDlmICYmIGNwIDwgMHhmZGQwKTtcblxuICAgICAgICBpZiAoIWlzQ29tbW9uVmFsaWRSYW5nZSkge1xuICAgICAgICAgICAgdGhpcy5fY2hlY2tGb3JQcm9ibGVtYXRpY0NoYXJhY3RlcnMoY3ApO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGNwO1xuICAgIH1cblxuICAgIF9jaGVja0ZvclByb2JsZW1hdGljQ2hhcmFjdGVycyhjcCkge1xuICAgICAgICBpZiAodW5pY29kZS5pc0NvbnRyb2xDb2RlUG9pbnQoY3ApKSB7XG4gICAgICAgICAgICB0aGlzLl9lcnIoRVJSLmNvbnRyb2xDaGFyYWN0ZXJJbklucHV0U3RyZWFtKTtcbiAgICAgICAgfSBlbHNlIGlmICh1bmljb2RlLmlzVW5kZWZpbmVkQ29kZVBvaW50KGNwKSkge1xuICAgICAgICAgICAgdGhpcy5fZXJyKEVSUi5ub25jaGFyYWN0ZXJJbklucHV0U3RyZWFtKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHJlYXQoKSB7XG4gICAgICAgIGlmICh0aGlzLnBvcyA9PT0gdGhpcy5sYXN0R2FwUG9zKSB7XG4gICAgICAgICAgICB0aGlzLmxhc3RHYXBQb3MgPSB0aGlzLmdhcFN0YWNrLnBvcCgpO1xuICAgICAgICAgICAgdGhpcy5wb3MtLTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucG9zLS07XG4gICAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IFByZXByb2Nlc3NvcjtcbiJdfQ==