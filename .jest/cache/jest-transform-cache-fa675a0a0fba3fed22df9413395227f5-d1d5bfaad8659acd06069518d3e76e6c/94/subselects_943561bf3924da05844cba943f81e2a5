2da851b8adfa1ae38ba049fe1432b743
"use strict";

var __spreadArrays = this && this.__spreadArrays || function () {
  for (var s = 0, i = 0, il = arguments.length; i < il; i++) {
    s += arguments[i].length;
  }

  for (var r = Array(s), k = 0, i = 0; i < il; i++) {
    for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++) {
      r[k] = a[j];
    }
  }

  return r;
};

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.subselects = exports.getNextSiblings = exports.ensureIsTag = exports.PLACEHOLDER_ELEMENT = void 0;

var boolbase_1 = require("boolbase");

var procedure_1 = require("../procedure");

exports.PLACEHOLDER_ELEMENT = {};

function containsTraversal(t) {
  return t.some(procedure_1.isTraversal);
}

function ensureIsTag(next, adapter) {
  if (next === boolbase_1.falseFunc) return next;
  return function (elem) {
    return adapter.isTag(elem) && next(elem);
  };
}

exports.ensureIsTag = ensureIsTag;

function getNextSiblings(elem, adapter) {
  var siblings = adapter.getSiblings(elem);
  if (siblings.length <= 1) return [];
  var elemIndex = siblings.indexOf(elem);
  if (elemIndex < 0 || elemIndex === siblings.length - 1) return [];
  return siblings.slice(elemIndex + 1).filter(adapter.isTag);
}

exports.getNextSiblings = getNextSiblings;
exports.subselects = {
  is: function is(next, token, options, context, compileToken) {
    return exports.subselects.matches(next, token, options, context, compileToken);
  },
  matches: function matches(next, token, options, context, compileToken) {
    var opts = {
      xmlMode: !!options.xmlMode,
      strict: !!options.strict,
      adapter: options.adapter,
      equals: options.equals,
      rootFunc: next
    };
    return compileToken(token, opts, context);
  },
  not: function not(next, token, options, context, compileToken) {
    var opts = {
      xmlMode: !!options.xmlMode,
      strict: !!options.strict,
      adapter: options.adapter,
      equals: options.equals
    };

    if (opts.strict) {
      if (token.length > 1 || token.some(containsTraversal)) {
        throw new Error("complex selectors in :not aren't allowed in strict mode");
      }
    }

    var func = compileToken(token, opts, context);
    if (func === boolbase_1.falseFunc) return next;
    if (func === boolbase_1.trueFunc) return boolbase_1.falseFunc;
    return function not(elem) {
      return !func(elem) && next(elem);
    };
  },
  has: function has(next, subselect, options, _context, compileToken) {
    var adapter = options.adapter;
    var opts = {
      xmlMode: !!options.xmlMode,
      strict: !!options.strict,
      adapter: adapter,
      equals: options.equals
    };
    var context = subselect.some(containsTraversal) ? [exports.PLACEHOLDER_ELEMENT] : undefined;
    var compiled = compileToken(subselect, opts, context);
    if (compiled === boolbase_1.falseFunc) return boolbase_1.falseFunc;

    if (compiled === boolbase_1.trueFunc) {
      return function (elem) {
        return adapter.getChildren(elem).some(adapter.isTag) && next(elem);
      };
    }

    var hasElement = ensureIsTag(compiled, adapter);
    var _a = compiled.shouldTestNextSiblings,
        shouldTestNextSiblings = _a === void 0 ? false : _a;

    if (context) {
      return function (elem) {
        context[0] = elem;
        var childs = adapter.getChildren(elem);
        var nextElements = shouldTestNextSiblings ? __spreadArrays(childs, getNextSiblings(elem, adapter)) : childs;
        return next(elem) && adapter.existsOne(hasElement, nextElements);
      };
    }

    return function (elem) {
      return next(elem) && adapter.existsOne(hasElement, adapter.getChildren(elem));
    };
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN1YnNlbGVjdHMuanMiXSwibmFtZXMiOlsiX19zcHJlYWRBcnJheXMiLCJzIiwiaSIsImlsIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiciIsIkFycmF5IiwiayIsImEiLCJqIiwiamwiLCJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsInN1YnNlbGVjdHMiLCJnZXROZXh0U2libGluZ3MiLCJlbnN1cmVJc1RhZyIsIlBMQUNFSE9MREVSX0VMRU1FTlQiLCJib29sYmFzZV8xIiwicmVxdWlyZSIsInByb2NlZHVyZV8xIiwiY29udGFpbnNUcmF2ZXJzYWwiLCJ0Iiwic29tZSIsImlzVHJhdmVyc2FsIiwibmV4dCIsImFkYXB0ZXIiLCJmYWxzZUZ1bmMiLCJlbGVtIiwiaXNUYWciLCJzaWJsaW5ncyIsImdldFNpYmxpbmdzIiwiZWxlbUluZGV4IiwiaW5kZXhPZiIsInNsaWNlIiwiZmlsdGVyIiwiaXMiLCJ0b2tlbiIsIm9wdGlvbnMiLCJjb250ZXh0IiwiY29tcGlsZVRva2VuIiwibWF0Y2hlcyIsIm9wdHMiLCJ4bWxNb2RlIiwic3RyaWN0IiwiZXF1YWxzIiwicm9vdEZ1bmMiLCJub3QiLCJFcnJvciIsImZ1bmMiLCJ0cnVlRnVuYyIsImhhcyIsInN1YnNlbGVjdCIsIl9jb250ZXh0IiwidW5kZWZpbmVkIiwiY29tcGlsZWQiLCJnZXRDaGlsZHJlbiIsImhhc0VsZW1lbnQiLCJfYSIsInNob3VsZFRlc3ROZXh0U2libGluZ3MiLCJjaGlsZHMiLCJuZXh0RWxlbWVudHMiLCJleGlzdHNPbmUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLGNBQWMsR0FBSSxRQUFRLEtBQUtBLGNBQWQsSUFBaUMsWUFBWTtBQUM5RCxPQUFLLElBQUlDLENBQUMsR0FBRyxDQUFSLEVBQVdDLENBQUMsR0FBRyxDQUFmLEVBQWtCQyxFQUFFLEdBQUdDLFNBQVMsQ0FBQ0MsTUFBdEMsRUFBOENILENBQUMsR0FBR0MsRUFBbEQsRUFBc0RELENB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cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG52YXIgX19zcHJlYWRBcnJheXMgPSAodGhpcyAmJiB0aGlzLl9fc3ByZWFkQXJyYXlzKSB8fCBmdW5jdGlvbiAoKSB7XG4gICAgZm9yICh2YXIgcyA9IDAsIGkgPSAwLCBpbCA9IGFyZ3VtZW50cy5sZW5ndGg7IGkgPCBpbDsgaSsrKSBzICs9IGFyZ3VtZW50c1tpXS5sZW5ndGg7XG4gICAgZm9yICh2YXIgciA9IEFycmF5KHMpLCBrID0gMCwgaSA9IDA7IGkgPCBpbDsgaSsrKVxuICAgICAgICBmb3IgKHZhciBhID0gYXJndW1lbnRzW2ldLCBqID0gMCwgamwgPSBhLmxlbmd0aDsgaiA8IGpsOyBqKyssIGsrKylcbiAgICAgICAgICAgIHJba10gPSBhW2pdO1xuICAgIHJldHVybiByO1xufTtcbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwgeyB2YWx1ZTogdHJ1ZSB9KTtcbmV4cG9ydHMuc3Vic2VsZWN0cyA9IGV4cG9ydHMuZ2V0TmV4dFNpYmxpbmdzID0gZXhwb3J0cy5lbnN1cmVJc1RhZyA9IGV4cG9ydHMuUExBQ0VIT0xERVJfRUxFTUVOVCA9IHZvaWQgMDtcbnZhciBib29sYmFzZV8xID0gcmVxdWlyZShcImJvb2xiYXNlXCIpO1xudmFyIHByb2NlZHVyZV8xID0gcmVxdWlyZShcIi4uL3Byb2NlZHVyZVwiKTtcbi8qKiBVc2VkIGFzIGEgcGxhY2Vob2xkZXIgZm9yIDpoYXMuIFdpbGwgYmUgcmVwbGFjZWQgd2l0aCB0aGUgYWN0dWFsIGVsZW1lbnQuICovXG5leHBvcnRzLlBMQUNFSE9MREVSX0VMRU1FTlQgPSB7fTtcbmZ1bmN0aW9uIGNvbnRhaW5zVHJhdmVyc2FsKHQpIHtcbiAgICByZXR1cm4gdC5zb21lKHByb2NlZHVyZV8xLmlzVHJhdmVyc2FsKTtcbn1cbmZ1bmN0aW9uIGVuc3VyZUlzVGFnKG5leHQsIGFkYXB0ZXIpIHtcbiAgICBpZiAobmV4dCA9PT0gYm9vbGJhc2VfMS5mYWxzZUZ1bmMpXG4gICAgICAgIHJldHVybiBuZXh0O1xuICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkgeyByZXR1cm4gYWRhcHRlci5pc1RhZyhlbGVtKSAmJiBuZXh0KGVsZW0pOyB9O1xufVxuZXhwb3J0cy5lbnN1cmVJc1RhZyA9IGVuc3VyZUlzVGFnO1xuZnVuY3Rpb24gZ2V0TmV4dFNpYmxpbmdzKGVsZW0sIGFkYXB0ZXIpIHtcbiAgICB2YXIgc2libGluZ3MgPSBhZGFwdGVyLmdldFNpYmxpbmdzKGVsZW0pO1xuICAgIGlmIChzaWJsaW5ncy5sZW5ndGggPD0gMSlcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIHZhciBlbGVtSW5kZXggPSBzaWJsaW5ncy5pbmRleE9mKGVsZW0pO1xuICAgIGlmIChlbGVtSW5kZXggPCAwIHx8IGVsZW1JbmRleCA9PT0gc2libGluZ3MubGVuZ3RoIC0gMSlcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIHJldHVybiBzaWJsaW5ncy5zbGljZShlbGVtSW5kZXggKyAxKS5maWx0ZXIoYWRhcHRlci5pc1RhZyk7XG59XG5leHBvcnRzLmdldE5leHRTaWJsaW5ncyA9IGdldE5leHRTaWJsaW5ncztcbi8qXG4gKiA6bm90LCA6aGFzIGFuZCA6bWF0Y2hlcyBoYXZlIHRvIGNvbXBpbGUgc2VsZWN0b3JzXG4gKiBkb2luZyB0aGlzIGluIHNyYy9wc2V1ZG9zLnRzIHdvdWxkIGxlYWQgdG8gY2lyY3VsYXIgZGVwZW5kZW5jaWVzLFxuICogc28gd2UgYWRkIHRoZW0gaGVyZVxuICovXG5leHBvcnRzLnN1YnNlbGVjdHMgPSB7XG4gICAgLyoqXG4gICAgICogYDppc2AgaXMgYW4gYWxpYXMgZm9yIGA6bWF0Y2hlc2AuXG4gICAgICovXG4gICAgaXM6IGZ1bmN0aW9uIChuZXh0LCB0b2tlbiwgb3B0aW9ucywgY29udGV4dCwgY29tcGlsZVRva2VuKSB7XG4gICAgICAgIHJldHVybiBleHBvcnRzLnN1YnNlbGVjdHMubWF0Y2hlcyhuZXh0LCB0b2tlbiwgb3B0aW9ucywgY29udGV4dCwgY29tcGlsZVRva2VuKTtcbiAgICB9LFxuICAgIG1hdGNoZXM6IGZ1bmN0aW9uIChuZXh0LCB0b2tlbiwgb3B0aW9ucywgY29udGV4dCwgY29tcGlsZVRva2VuKSB7XG4gICAgICAgIHZhciBvcHRzID0ge1xuICAgICAgICAgICAgeG1sTW9kZTogISFvcHRpb25zLnhtbE1vZGUsXG4gICAgICAgICAgICBzdHJpY3Q6ICEhb3B0aW9ucy5zdHJpY3QsXG4gICAgICAgICAgICBhZGFwdGVyOiBvcHRpb25zLmFkYXB0ZXIsXG4gICAgICAgICAgICBlcXVhbHM6IG9wdGlvbnMuZXF1YWxzLFxuICAgICAgICAgICAgcm9vdEZ1bmM6IG5leHQsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBjb21waWxlVG9rZW4odG9rZW4sIG9wdHMsIGNvbnRleHQpO1xuICAgIH0sXG4gICAgbm90OiBmdW5jdGlvbiAobmV4dCwgdG9rZW4sIG9wdGlvbnMsIGNvbnRleHQsIGNvbXBpbGVUb2tlbikge1xuICAgICAgICB2YXIgb3B0cyA9IHtcbiAgICAgICAgICAgIHhtbE1vZGU6ICEhb3B0aW9ucy54bWxNb2RlLFxuICAgICAgICAgICAgc3RyaWN0OiAhIW9wdGlvbnMuc3RyaWN0LFxuICAgICAgICAgICAgYWRhcHRlcjogb3B0aW9ucy5hZGFwdGVyLFxuICAgICAgICAgICAgZXF1YWxzOiBvcHRpb25zLmVxdWFscyxcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKG9wdHMuc3RyaWN0KSB7XG4gICAgICAgICAgICBpZiAodG9rZW4ubGVuZ3RoID4gMSB8fCB0b2tlbi5zb21lKGNvbnRhaW5zVHJhdmVyc2FsKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcImNvbXBsZXggc2VsZWN0b3JzIGluIDpub3QgYXJlbid0IGFsbG93ZWQgaW4gc3RyaWN0IG1vZGVcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGZ1bmMgPSBjb21waWxlVG9rZW4odG9rZW4sIG9wdHMsIGNvbnRleHQpO1xuICAgICAgICBpZiAoZnVuYyA9PT0gYm9vbGJhc2VfMS5mYWxzZUZ1bmMpXG4gICAgICAgICAgICByZXR1cm4gbmV4dDtcbiAgICAgICAgaWYgKGZ1bmMgPT09IGJvb2xiYXNlXzEudHJ1ZUZ1bmMpXG4gICAgICAgICAgICByZXR1cm4gYm9vbGJhc2VfMS5mYWxzZUZ1bmM7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiBub3QoZWxlbSkge1xuICAgICAgICAgICAgcmV0dXJuICFmdW5jKGVsZW0pICYmIG5leHQoZWxlbSk7XG4gICAgICAgIH07XG4gICAgfSxcbiAgICBoYXM6IGZ1bmN0aW9uIChuZXh0LCBzdWJzZWxlY3QsIG9wdGlvbnMsIF9jb250ZXh0LCBjb21waWxlVG9rZW4pIHtcbiAgICAgICAgdmFyIGFkYXB0ZXIgPSBvcHRpb25zLmFkYXB0ZXI7XG4gICAgICAgIHZhciBvcHRzID0ge1xuICAgICAgICAgICAgeG1sTW9kZTogISFvcHRpb25zLnhtbE1vZGUsXG4gICAgICAgICAgICBzdHJpY3Q6ICEhb3B0aW9ucy5zdHJpY3QsXG4gICAgICAgICAgICBhZGFwdGVyOiBhZGFwdGVyLFxuICAgICAgICAgICAgZXF1YWxzOiBvcHRpb25zLmVxdWFscyxcbiAgICAgICAgfTtcbiAgICAgICAgLy8gQHRzLWV4cGVjdC1lcnJvciBVc2VzIGFuIGFycmF5IGFzIGEgcG9pbnRlciB0byB0aGUgY3VycmVudCBlbGVtZW50IChzaWRlIGVmZmVjdHMpXG4gICAgICAgIHZhciBjb250ZXh0ID0gc3Vic2VsZWN0LnNvbWUoY29udGFpbnNUcmF2ZXJzYWwpXG4gICAgICAgICAgICA/IFtleHBvcnRzLlBMQUNFSE9MREVSX0VMRU1FTlRdXG4gICAgICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICAgICAgdmFyIGNvbXBpbGVkID0gY29tcGlsZVRva2VuKHN1YnNlbGVjdCwgb3B0cywgY29udGV4dCk7XG4gICAgICAgIGlmIChjb21waWxlZCA9PT0gYm9vbGJhc2VfMS5mYWxzZUZ1bmMpXG4gICAgICAgICAgICByZXR1cm4gYm9vbGJhc2VfMS5mYWxzZUZ1bmM7XG4gICAgICAgIGlmIChjb21waWxlZCA9PT0gYm9vbGJhc2VfMS50cnVlRnVuYykge1xuICAgICAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChlbGVtKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFkYXB0ZXIuZ2V0Q2hpbGRyZW4oZWxlbSkuc29tZShhZGFwdGVyLmlzVGFnKSAmJiBuZXh0KGVsZW0pO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgaGFzRWxlbWVudCA9IGVuc3VyZUlzVGFnKGNvbXBpbGVkLCBhZGFwdGVyKTtcbiAgICAgICAgdmFyIF9hID0gY29tcGlsZWQuc2hvdWxkVGVzdE5leHRTaWJsaW5ncywgc2hvdWxkVGVzdE5leHRTaWJsaW5ncyA9IF9hID09PSB2b2lkIDAgPyBmYWxzZSA6IF9hO1xuICAgICAgICAvKlxuICAgICAgICAgKiBgc2hvdWxkVGVzdE5leHRTaWJsaW5nc2Agd2lsbCBvbmx5IGJlIHRydWUgaWYgdGhlIHF1ZXJ5IHN0YXJ0cyB3aXRoXG4gICAgICAgICAqIGEgdHJhdmVyc2FsIChzaWJsaW5nIG9yIGFkamFjZW50KS4gVGhhdCBtZWFucyB3ZSB3aWxsIGFsd2F5cyBoYXZlIGEgY29udGV4dC5cbiAgICAgICAgICovXG4gICAgICAgIGlmIChjb250ZXh0KSB7XG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gKGVsZW0pIHtcbiAgICAgICAgICAgICAgICBjb250ZXh0WzBdID0gZWxlbTtcbiAgICAgICAgICAgICAgICB2YXIgY2hpbGRzID0gYWRhcHRlci5nZXRDaGlsZHJlbihlbGVtKTtcbiAgICAgICAgICAgICAgICB2YXIgbmV4dEVsZW1lbnRzID0gc2hvdWxkVGVzdE5leHRTaWJsaW5nc1xuICAgICAgICAgICAgICAgICAgICA/IF9fc3ByZWFkQXJyYXlzKGNoaWxkcywgZ2V0TmV4dFNpYmxpbmdzKGVsZW0sIGFkYXB0ZXIpKSA6IGNoaWxkcztcbiAgICAgICAgICAgICAgICByZXR1cm4gKG5leHQoZWxlbSkgJiYgYWRhcHRlci5leGlzdHNPbmUoaGFzRWxlbWVudCwgbmV4dEVsZW1lbnRzKSk7XG4gICAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoZWxlbSkge1xuICAgICAgICAgICAgcmV0dXJuIG5leHQoZWxlbSkgJiZcbiAgICAgICAgICAgICAgICBhZGFwdGVyLmV4aXN0c09uZShoYXNFbGVtZW50LCBhZGFwdGVyLmdldENoaWxkcmVuKGVsZW0pKTtcbiAgICAgICAgfTtcbiAgICB9LFxufTtcbiJdfQ==