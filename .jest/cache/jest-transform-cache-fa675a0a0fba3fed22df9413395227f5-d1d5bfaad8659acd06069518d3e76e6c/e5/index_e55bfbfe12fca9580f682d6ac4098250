2ed2d2f8e0f10ceb1de55e7810575d4d
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var defaultTreeAdapter = require('../tree-adapters/default');

var mergeOptions = require('../utils/merge-options');

var doctype = require('../common/doctype');

var HTML = require('../common/html');

var $ = HTML.TAG_NAMES;
var NS = HTML.NAMESPACES;
var DEFAULT_OPTIONS = {
  treeAdapter: defaultTreeAdapter
};
var AMP_REGEX = /&/g;
var NBSP_REGEX = /\u00a0/g;
var DOUBLE_QUOTE_REGEX = /"/g;
var LT_REGEX = /</g;
var GT_REGEX = />/g;

var Serializer = function () {
  function Serializer(node, options) {
    (0, _classCallCheck2.default)(this, Serializer);
    this.options = mergeOptions(DEFAULT_OPTIONS, options);
    this.treeAdapter = this.options.treeAdapter;
    this.html = '';
    this.startNode = node;
  }

  (0, _createClass2.default)(Serializer, [{
    key: "serialize",
    value: function serialize() {
      this._serializeChildNodes(this.startNode);

      return this.html;
    }
  }, {
    key: "_serializeChildNodes",
    value: function _serializeChildNodes(parentNode) {
      var childNodes = this.treeAdapter.getChildNodes(parentNode);

      if (childNodes) {
        for (var i = 0, cnLength = childNodes.length; i < cnLength; i++) {
          var currentNode = childNodes[i];

          if (this.treeAdapter.isElementNode(currentNode)) {
            this._serializeElement(currentNode);
          } else if (this.treeAdapter.isTextNode(currentNode)) {
            this._serializeTextNode(currentNode);
          } else if (this.treeAdapter.isCommentNode(currentNode)) {
            this._serializeCommentNode(currentNode);
          } else if (this.treeAdapter.isDocumentTypeNode(currentNode)) {
            this._serializeDocumentTypeNode(currentNode);
          }
        }
      }
    }
  }, {
    key: "_serializeElement",
    value: function _serializeElement(node) {
      var tn = this.treeAdapter.getTagName(node);
      var ns = this.treeAdapter.getNamespaceURI(node);
      this.html += '<' + tn;

      this._serializeAttributes(node);

      this.html += '>';

      if (tn !== $.AREA && tn !== $.BASE && tn !== $.BASEFONT && tn !== $.BGSOUND && tn !== $.BR && tn !== $.COL && tn !== $.EMBED && tn !== $.FRAME && tn !== $.HR && tn !== $.IMG && tn !== $.INPUT && tn !== $.KEYGEN && tn !== $.LINK && tn !== $.META && tn !== $.PARAM && tn !== $.SOURCE && tn !== $.TRACK && tn !== $.WBR) {
        var childNodesHolder = tn === $.TEMPLATE && ns === NS.HTML ? this.treeAdapter.getTemplateContent(node) : node;

        this._serializeChildNodes(childNodesHolder);

        this.html += '</' + tn + '>';
      }
    }
  }, {
    key: "_serializeAttributes",
    value: function _serializeAttributes(node) {
      var attrs = this.treeAdapter.getAttrList(node);

      for (var i = 0, attrsLength = attrs.length; i < attrsLength; i++) {
        var attr = attrs[i];
        var value = Serializer.escapeString(attr.value, true);
        this.html += ' ';

        if (!attr.namespace) {
          this.html += attr.name;
        } else if (attr.namespace === NS.XML) {
          this.html += 'xml:' + attr.name;
        } else if (attr.namespace === NS.XMLNS) {
          if (attr.name !== 'xmlns') {
            this.html += 'xmlns:';
          }

          this.html += attr.name;
        } else if (attr.namespace === NS.XLINK) {
          this.html += 'xlink:' + attr.name;
        } else {
          this.html += attr.prefix + ':' + attr.name;
        }

        this.html += '="' + value + '"';
      }
    }
  }, {
    key: "_serializeTextNode",
    value: function _serializeTextNode(node) {
      var content = this.treeAdapter.getTextNodeContent(node);
      var parent = this.treeAdapter.getParentNode(node);
      var parentTn = void 0;

      if (parent && this.treeAdapter.isElementNode(parent)) {
        parentTn = this.treeAdapter.getTagName(parent);
      }

      if (parentTn === $.STYLE || parentTn === $.SCRIPT || parentTn === $.XMP || parentTn === $.IFRAME || parentTn === $.NOEMBED || parentTn === $.NOFRAMES || parentTn === $.PLAINTEXT || parentTn === $.NOSCRIPT) {
        this.html += content;
      } else {
        this.html += Serializer.escapeString(content, false);
      }
    }
  }, {
    key: "_serializeCommentNode",
    value: function _serializeCommentNode(node) {
      this.html += '<!--' + this.treeAdapter.getCommentNodeContent(node) + '-->';
    }
  }, {
    key: "_serializeDocumentTypeNode",
    value: function _serializeDocumentTypeNode(node) {
      var name = this.treeAdapter.getDocumentTypeNodeName(node);
      this.html += '<' + doctype.serializeContent(name, null, null) + '>';
    }
  }]);
  return Serializer;
}();

Serializer.escapeString = function (str, attrMode) {
  str = str.replace(AMP_REGEX, '&amp;').replace(NBSP_REGEX, '&nbsp;');

  if (attrMode) {
    str = str.replace(DOUBLE_QUOTE_REGEX, '&quot;');
  } else {
    str = str.replace(LT_REGEX, '&lt;').replace(GT_REGEX, '&gt;');
  }

  return str;
};

module.exports = Serializer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbImRlZmF1bHRUcmVlQWRhcHRlciIsInJlcXVpcmUiLCJtZXJnZU9wdGlvbnMiLCJkb2N0eXBlIiwiSFRNTCIsIiQiLCJUQUdfTkFNRVMiLCJOUyIsIk5BTUVTUEFDRVMiLCJERUZBVUxUX09QVElPTlMiLCJ0cmVlQWRhcHRlciIsIkFNUF9SRUdFWCIsIk5CU1BfUkVHRVgiLCJET1VCTEVfUVVPVEVfUkVHRVgiLCJMVF9SRUdFWCIsIkdUX1JFR0VYIiwiU2VyaWFsaXplciIsIm5vZGUiLCJvcHRpb25zIiwiaHRtbCIsInN0YXJ0Tm9kZSIsIl9zZXJpYWxpemVDaGlsZE5vZGVzIiwicGFyZW50Tm9kZSIsImNoaWxkTm9kZXMiLCJnZXRDaGlsZE5vZGVzIiwiaSIsImNuTGVuZ3RoIiwibGVuZ3RoIiwiY3VycmVudE5vZGUiLCJpc0VsZW1lbnROb2RlIiwiX3NlcmlhbGl6ZUVsZW1lbnQiLCJpc1RleHROb2RlIiwiX3NlcmlhbGl6ZVRleHROb2RlIiwiaXNDb21tZW50Tm9kZSIsIl9zZXJpYWxpemVDb21tZW50Tm9kZSIsImlzRG9jdW1lbnRUeXBlTm9kZSIsIl9zZXJpYWxpemVEb2N1bWVudFR5cGVOb2RlIiwidG4iLCJnZXRUYWdOYW1lIiwibnMiLCJnZXROYW1lc3BhY2VVUkkiLCJfc2VyaWFsaXplQXR0cmlidXRlcyIsIkFSRUEiLCJCQVNFIiwiQkFTRUZPTlQiLCJCR1NPVU5EIiwiQlIiLCJDT0wiLCJFTUJFRCIsIkZSQU1FIiwiSFIiLCJJTUciLCJJTlBVVCIsIktFWUdFTiIsIkxJTksiLCJNRVRBIiwiUEFSQU0iLCJTT1VSQ0UiLCJUUkFDSyIsIldCUiIsImNoaWxkTm9kZXNIb2xkZXIiLCJURU1QTEFURSIsImdldFRlbXBsYXRlQ29udGVudCIsImF0dHJzIiwiZ2V0QXR0ckxpc3QiLCJhdHRyc0xlbmd0aCIsImF0dHIiLCJ2YWx1ZSIsImVzY2FwZVN0cmluZyIsIm5hbWVzcGFjZSIsIm5hbWUiLCJYTUwiLCJYTUxOUyIsIlhMSU5LIiwicHJlZml4IiwiY29udGVudCIsImdldFRleHROb2RlQ29udGVudCIsInBhcmVudCIsImdldFBhcmVudE5vZGUiLCJwYXJlbnRUbiIsIlNUWUxFIiwiU0NSSVBUIiwiWE1QIiwiSUZSQU1FIiwiTk9FTUJFRCIsIk5PRlJBTUVTIiwiUExBSU5URVhUIiwiTk9TQ1JJUFQiLCJnZXRDb21tZW50Tm9kZUNvbnRlbnQiLCJnZXREb2N1bWVudFR5cGVOb2RlTmFtZSIsInNlcmlhbGl6ZUNvbnRlbnQiLCJzdHIiLCJhdHRyTW9kZSIsInJlcGxhY2UiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7QUFFQSxJQUFNQSxrQkFBa0IsR0FBR0MsT0FBTyxDQUFDLDBCQUFELENBQWxDOztBQUNBLElBQU1DLFlBQVksR0FBR0QsT0FBTyxDQUFDLHdCQUFELENBQTVCOztBQUNBLElBQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLG1CQUFELENBQXZCOztBQUNBLElBQU1HLElBQUksR0FBR0gsT0FBTyxDQUFDLGdCQUFELENBQXBCOztBQUdBLElBQU1JLENBQUMsR0FBR0QsSUFBSSxDQUFDRSxTQUFmO0FBQ0EsSUFBTUMsRUFBRSxHQUFHSCxJQUFJLENBQUNJLFVBQWhCO0FBR0EsSUFBTUMsZUFBZSxHQUFHO0FBQ3BCQyxFQUFBQSxXQUFXLEVBQUVWO0FBRE8sQ0FBeEI7QUFLQSxJQUFNVyxTQUFTLEdBQUcsSUFBbEI7QUFDQSxJQUFNQyxVQUFVLEdBQUcsU0FBbkI7QUFDQSxJQUFNQyxrQkFBa0IsR0FBRyxJQUEzQjtBQUNBLElBQU1DLFFBQVEsR0FBRyxJQUFqQjtBQUNBLElBQU1DLFFBQVEsR0FBRyxJQUFqQjs7SUFHTUMsVTtBQUNGLHNCQUFZQyxJQUFaLEVBQWtCQyxPQUFsQixFQUEyQjtBQUFBO0FBQ3ZCLFNBQUtBLE9BQUwsR0FBZWhCLFlBQVksQ0FBQ08sZUFBRCxFQUFrQlMsT0FBbEIsQ0FBM0I7QUFDQSxTQUFLUixXQUFMLEdBQW1CLEtBQUtRLE9BQUwsQ0FB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QUFQO0FBQ0gsQ0FWRDs7QUFZQUcsTUFBTSxDQUFDQyxPQUFQLEdBQWlCL0UsVUFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XG5cbmNvbnN0IGRlZmF1bHRUcmVlQWRhcHRlciA9IHJlcXVpcmUoJy4uL3RyZWUtYWRhcHRlcnMvZGVmYXVsdCcpO1xuY29uc3QgbWVyZ2VPcHRpb25zID0gcmVxdWlyZSgnLi4vdXRpbHMvbWVyZ2Utb3B0aW9ucycpO1xuY29uc3QgZG9jdHlwZSA9IHJlcXVpcmUoJy4uL2NvbW1vbi9kb2N0eXBlJyk7XG5jb25zdCBIVE1MID0gcmVxdWlyZSgnLi4vY29tbW9uL2h0bWwnKTtcblxuLy9BbGlhc2VzXG5jb25zdCAkID0gSFRNTC5UQUdfTkFNRVM7XG5jb25zdCBOUyA9IEhUTUwuTkFNRVNQQUNFUztcblxuLy9EZWZhdWx0IHNlcmlhbGl6ZXIgb3B0aW9uc1xuY29uc3QgREVGQVVMVF9PUFRJT05TID0ge1xuICAgIHRyZWVBZGFwdGVyOiBkZWZhdWx0VHJlZUFkYXB0ZXJcbn07XG5cbi8vRXNjYXBpbmcgcmVnZXhlc1xuY29uc3QgQU1QX1JFR0VYID0gLyYvZztcbmNvbnN0IE5CU1BfUkVHRVggPSAvXFx1MDBhMC9nO1xuY29uc3QgRE9VQkxFX1FVT1RFX1JFR0VYID0gL1wiL2c7XG5jb25zdCBMVF9SRUdFWCA9IC88L2c7XG5jb25zdCBHVF9SRUdFWCA9IC8+L2c7XG5cbi8vU2VyaWFsaXplclxuY2xhc3MgU2VyaWFsaXplciB7XG4gICAgY29uc3RydWN0b3Iobm9kZSwgb3B0aW9ucykge1xuICAgICAgICB0aGlzLm9wdGlvbnMgPSBtZXJnZU9wdGlvbnMoREVGQVVMVF9PUFRJT05TLCBvcHRpb25zKTtcbiAgICAgICAgdGhpcy50cmVlQWRhcHRlciA9IHRoaXMub3B0aW9ucy50cmVlQWRhcHRlcjtcblxuICAgICAgICB0aGlzLmh0bWwgPSAnJztcbiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBub2RlO1xuICAgIH1cblxuICAgIC8vQVBJXG4gICAgc2VyaWFsaXplKCkge1xuICAgICAgICB0aGlzLl9zZXJpYWxpemVDaGlsZE5vZGVzKHRoaXMuc3RhcnROb2RlKTtcblxuICAgICAgICByZXR1cm4gdGhpcy5odG1sO1xuICAgIH1cblxuICAgIC8vSW50ZXJuYWxzXG4gICAgX3NlcmlhbGl6ZUNoaWxkTm9kZXMocGFyZW50Tm9kZSkge1xuICAgICAgICBjb25zdCBjaGlsZE5vZGVzID0gdGhpcy50cmVlQWRhcHRlci5nZXRDaGlsZE5vZGVzKHBhcmVudE5vZGUpO1xuXG4gICAgICAgIGlmIChjaGlsZE5vZGVzKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMCwgY25MZW5ndGggPSBjaGlsZE5vZGVzLmxlbmd0aDsgaSA8IGNuTGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50Tm9kZSA9IGNoaWxkTm9kZXNbaV07XG5cbiAgICAgICAgICAgICAgICBpZiAodGhpcy50cmVlQWRhcHRlci5pc0VsZW1lbnROb2RlKGN1cnJlbnROb2RlKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXJpYWxpemVFbGVtZW50KGN1cnJlbnROb2RlKTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMudHJlZUFkYXB0ZXIuaXNUZXh0Tm9kZShjdXJyZW50Tm9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VyaWFsaXplVGV4dE5vZGUoY3VycmVudE5vZGUpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy50cmVlQWRhcHRlci5pc0NvbW1lbnROb2RlKGN1cnJlbnROb2RlKSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZXJpYWxpemVDb21tZW50Tm9kZShjdXJyZW50Tm9kZSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRyZWVBZGFwdGVyLmlzRG9jdW1lbnRUeXBlTm9kZShjdXJyZW50Tm9kZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VyaWFsaXplRG9jdW1lbnRUeXBlTm9kZShjdXJyZW50Tm9kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgX3NlcmlhbGl6ZUVsZW1lbnQobm9kZSkge1xuICAgICAgICBjb25zdCB0biA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0VGFnTmFtZShub2RlKTtcbiAgICAgICAgY29uc3QgbnMgPSB0aGlzLnRyZWVBZGFwdGVyLmdldE5hbWVzcGFjZVVSSShub2RlKTtcblxuICAgICAgICB0aGlzLmh0bWwgKz0gJzwnICsgdG47XG4gICAgICAgIHRoaXMuX3NlcmlhbGl6ZUF0dHJpYnV0ZXMobm9kZSk7XG4gICAgICAgIHRoaXMuaHRtbCArPSAnPic7XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgdG4gIT09ICQuQVJFQSAmJlxuICAgICAgICAgICAgdG4gIT09ICQuQkFTRSAmJlxuICAgICAgICAgICAgdG4gIT09ICQuQkFTRUZPTlQgJiZcbiAgICAgICAgICAgIHRuICE9PSAkLkJHU09VTkQgJiZcbiAgICAgICAgICAgIHRuICE9PSAkLkJSICYmXG4gICAgICAgICAgICB0biAhPT0gJC5DT0wgJiZcbiAgICAgICAgICAgIHRuICE9PSAkLkVNQkVEICYmXG4gICAgICAgICAgICB0biAhPT0gJC5GUkFNRSAmJlxuICAgICAgICAgICAgdG4gIT09ICQuSFIgJiZcbiAgICAgICAgICAgIHRuICE9PSAkLklNRyAmJlxuICAgICAgICAgICAgdG4gIT09ICQuSU5QVVQgJiZcbiAgICAgICAgICAgIHRuICE9PSAkLktFWUdFTiAmJlxuICAgICAgICAgICAgdG4gIT09ICQuTElOSyAmJlxuICAgICAgICAgICAgdG4gIT09ICQuTUVUQSAmJlxuICAgICAgICAgICAgdG4gIT09ICQuUEFSQU0gJiZcbiAgICAgICAgICAgIHRuICE9PSAkLlNPVVJDRSAmJlxuICAgICAgICAgICAgdG4gIT09ICQuVFJBQ0sgJiZcbiAgICAgICAgICAgIHRuICE9PSAkLldCUlxuICAgICAgICApIHtcbiAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZXNIb2xkZXIgPVxuICAgICAgICAgICAgICAgIHRuID09PSAkLlRFTVBMQVRFICYmIG5zID09PSBOUy5IVE1MID8gdGhpcy50cmVlQWRhcHRlci5nZXRUZW1wbGF0ZUNvbnRlbnQobm9kZSkgOiBub2RlO1xuXG4gICAgICAgICAgICB0aGlzLl9zZXJpYWxpemVDaGlsZE5vZGVzKGNoaWxkTm9kZXNIb2xkZXIpO1xuICAgICAgICAgICAgdGhpcy5odG1sICs9ICc8LycgKyB0biArICc+JztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9zZXJpYWxpemVBdHRyaWJ1dGVzKG5vZGUpIHtcbiAgICAgICAgY29uc3QgYXR0cnMgPSB0aGlzLnRyZWVBZGFwdGVyLmdldEF0dHJMaXN0KG5vZGUpO1xuXG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBhdHRyc0xlbmd0aCA9IGF0dHJzLmxlbmd0aDsgaSA8IGF0dHJzTGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSBhdHRyc1tpXTtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gU2VyaWFsaXplci5lc2NhcGVTdHJpbmcoYXR0ci52YWx1ZSwgdHJ1ZSk7XG5cbiAgICAgICAgICAgIHRoaXMuaHRtbCArPSAnICc7XG5cbiAgICAgICAgICAgIGlmICghYXR0ci5uYW1lc3BhY2UpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmh0bWwgKz0gYXR0ci5uYW1lO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRyLm5hbWVzcGFjZSA9PT0gTlMuWE1MKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5odG1sICs9ICd4bWw6JyArIGF0dHIubmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0ci5uYW1lc3BhY2UgPT09IE5TLlhNTE5TKSB7XG4gICAgICAgICAgICAgICAgaWYgKGF0dHIubmFtZSAhPT0gJ3htbG5zJykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmh0bWwgKz0gJ3htbG5zOic7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgdGhpcy5odG1sICs9IGF0dHIubmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0ci5uYW1lc3BhY2UgPT09IE5TLlhMSU5LKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5odG1sICs9ICd4bGluazonICsgYXR0ci5uYW1lO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmh0bWwgKz0gYXR0ci5wcmVmaXggKyAnOicgKyBhdHRyLm5hbWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMuaHRtbCArPSAnPVwiJyArIHZhbHVlICsgJ1wiJztcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9zZXJpYWxpemVUZXh0Tm9kZShub2RlKSB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLnRyZWVBZGFwdGVyLmdldFRleHROb2RlQ29udGVudChub2RlKTtcbiAgICAgICAgY29uc3QgcGFyZW50ID0gdGhpcy50cmVlQWRhcHRlci5nZXRQYXJlbnROb2RlKG5vZGUpO1xuICAgICAgICBsZXQgcGFyZW50VG4gPSB2b2lkIDA7XG5cbiAgICAgICAgaWYgKHBhcmVudCAmJiB0aGlzLnRyZWVBZGFwdGVyLmlzRWxlbWVudE5vZGUocGFyZW50KSkge1xuICAgICAgICAgICAgcGFyZW50VG4gPSB0aGlzLnRyZWVBZGFwdGVyLmdldFRhZ05hbWUocGFyZW50KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChcbiAgICAgICAgICAgIHBhcmVudFRuID09PSAkLlNUWUxFIHx8XG4gICAgICAgICAgICBwYXJlbnRUbiA9PT0gJC5TQ1JJUFQgfHxcbiAgICAgICAgICAgIHBhcmVudFRuID09PSAkLlhNUCB8fFxuICAgICAgICAgICAgcGFyZW50VG4gPT09ICQuSUZSQU1FIHx8XG4gICAgICAgICAgICBwYXJlbnRUbiA9PT0gJC5OT0VNQkVEIHx8XG4gICAgICAgICAgICBwYXJlbnRUbiA9PT0gJC5OT0ZSQU1FUyB8fFxuICAgICAgICAgICAgcGFyZW50VG4gPT09ICQuUExBSU5URVhUIHx8XG4gICAgICAgICAgICBwYXJlbnRUbiA9PT0gJC5OT1NDUklQVFxuICAgICAgICApIHtcbiAgICAgICAgICAgIHRoaXMuaHRtbCArPSBjb250ZW50O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5odG1sICs9IFNlcmlhbGl6ZXIuZXNjYXBlU3RyaW5nKGNvbnRlbnQsIGZhbHNlKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9zZXJpYWxpemVDb21tZW50Tm9kZShub2RlKSB7XG4gICAgICAgIHRoaXMuaHRtbCArPSAnPCEtLScgKyB0aGlzLnRyZWVBZGFwdGVyLmdldENvbW1lbnROb2RlQ29udGVudChub2RlKSArICctLT4nO1xuICAgIH1cblxuICAgIF9zZXJpYWxpemVEb2N1bWVudFR5cGVOb2RlKG5vZGUpIHtcbiAgICAgICAgY29uc3QgbmFtZSA9IHRoaXMudHJlZUFkYXB0ZXIuZ2V0RG9jdW1lbnRUeXBlTm9kZU5hbWUobm9kZSk7XG5cbiAgICAgICAgdGhpcy5odG1sICs9ICc8JyArIGRvY3R5cGUuc2VyaWFsaXplQ29udGVudChuYW1lLCBudWxsLCBudWxsKSArICc+JztcbiAgICB9XG59XG5cbi8vIE5PVEU6IHVzZWQgaW4gdGVzdHMgYW5kIGJ5IHJld3JpdGluZyBzdHJlYW1cblNlcmlhbGl6ZXIuZXNjYXBlU3RyaW5nID0gZnVuY3Rpb24oc3RyLCBhdHRyTW9kZSkge1xuICAgIHN0ciA9IHN0ci5yZXBsYWNlKEFNUF9SRUdFWCwgJyZhbXA7JykucmVwbGFjZShOQlNQX1JFR0VYLCAnJm5ic3A7Jyk7XG5cbiAgICBpZiAoYXR0ck1vZGUpIHtcbiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoRE9VQkxFX1FVT1RFX1JFR0VYLCAnJnF1b3Q7Jyk7XG4gICAgfSBlbHNlIHtcbiAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UoTFRfUkVHRVgsICcmbHQ7JykucmVwbGFjZShHVF9SRUdFWCwgJyZndDsnKTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RyO1xufTtcblxubW9kdWxlLmV4cG9ydHMgPSBTZXJpYWxpemVyO1xuIl19