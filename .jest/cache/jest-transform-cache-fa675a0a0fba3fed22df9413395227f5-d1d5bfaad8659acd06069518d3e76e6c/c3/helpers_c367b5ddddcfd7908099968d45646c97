e04b899478c0cc33cedf7cf67f069c9c
"use strict";

var _interopRequireDefault2 = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/slicedToArray"));

var _toConsumableArray2 = _interopRequireDefault2(require("@babel/runtime/helpers/toConsumableArray"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.composeProviders = composeProviders;
exports.applyProviders = applyProviders;
exports.coalesceProviders = coalesceProviders;
exports.DYNAMIC_PROVIDER = void 0;

var _lodash = _interopRequireDefault(require("lodash.isequal"));

var _lodash2 = _interopRequireDefault(require("lodash.ismatch"));

var _provideValue = require("../provideValue");

var _helpers = require("../matchers/helpers");

var _parseEffect = _interopRequireDefault(require("../parseEffect"));

var _object = require("../../utils/object");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

var DYNAMIC_PROVIDER = '@@redux-saga-test-plan/dynamic-provider';
exports.DYNAMIC_PROVIDER = DYNAMIC_PROVIDER;

function isDynamicallyProvidedValue(value) {
  return !!value && typeof value === 'object' && DYNAMIC_PROVIDER in value;
}

function composeProviders() {
  for (var _len = arguments.length, providers = new Array(_len), _key = 0; _key < _len; _key++) {
    providers[_key] = arguments[_key];
  }

  return function (effect, next) {
    for (var i = 0, l = providers.length; i < l; i++) {
      var provider = providers[i];
      var result = provider(effect, next);

      if (result !== _provideValue.NEXT) {
        return result;
      }
    }

    return _provideValue.NEXT;
  };
}

function applyProviders(providerFns) {
  return composeProviders.apply(void 0, (0, _toConsumableArray2.default)(providerFns));
}

function coalesceProviders(providers) {
  var collected = {};

  function addToCollected(key, value) {
    if (key in collected) {
      collected[key].push(value);
    } else {
      collected[key] = [value];
    }
  }

  providers.forEach(function (providersObject) {
    if (Array.isArray(providersObject)) {
      var _providersObject = (0, _slicedToArray2.default)(providersObject, 2),
          expectedEffect = _providersObject[0],
          providedValue = _providersObject[1];

      var parsedEffect;
      var comparer;

      if ((0, _helpers.isPartialMatcher)(expectedEffect)) {
        parsedEffect = expectedEffect;
        comparer = _lodash2.default;
      } else {
        parsedEffect = (0, _parseEffect.default)(expectedEffect);
        comparer = _lodash.default;
      }

      if (parsedEffect.providerKey && parsedEffect.effect) {
        addToCollected(parsedEffect.providerKey, function (actualEffect, next) {
          var pass = comparer(actualEffect, parsedEffect.effect);

          if (isDynamicallyProvidedValue(providedValue) && pass) {
            return providedValue.fn(actualEffect, next);
          }

          return pass ? providedValue : next();
        });
      }
    } else {
      Object.keys(providersObject).forEach(function (providerKey) {
        var provider = providersObject[providerKey];
        addToCollected(providerKey, provider);
      });
    }
  });
  return (0, _object.mapValues)(collected, applyProviders);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImhlbHBlcnMuanMiXSwibmFtZXMiOlsiT2JqZWN0IiwiZGVmaW5lUHJvcGVydHkiLCJleHBvcnRzIiwidmFsdWUiLCJjb21wb3NlUHJvdmlkZXJzIiwiYXBwbHlQcm92aWRlcnMiLCJjb2FsZXNjZVByb3ZpZGVycyIsIkRZTkFNSUNfUFJPVklERVIiLCJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfbG9kYXNoMiIsIl9wcm92aWRlVmFsdWUiLCJfaGVscGVycyIsIl9wYXJzZUVmZmVjdCIsIl9vYmplY3QiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsImlzRHluYW1pY2FsbHlQcm92aWRlZFZhbHVlIiwicHJvdmlkZXJzIiwiZWZmZWN0IiwibmV4dCIsImkiLCJsIiwibGVuZ3RoIiwicHJvdmlkZXIiLCJyZXN1bHQiLCJORVhUIiwicHJvdmlkZXJGbnMiLCJjb2xsZWN0ZWQiLCJhZGRUb0NvbGxlY3RlZCIsImtleSIsInB1c2giLCJmb3JFYWNoIiwicHJvdmlkZXJzT2JqZWN0IiwiQXJyYXkiLCJpc0FycmF5IiwiZXhwZWN0ZWRFZmZlY3QiLCJwcm92aWRlZFZhbHVlIiwicGFyc2VkRWZmZWN0IiwiY29tcGFyZXIiLCJpc1BhcnRpYWxNYXRjaGVyIiwicHJvdmlkZXJLZXkiLCJhY3R1YWxFZmZlY3QiLCJwYXNzIiwiZm4iLCJrZXlzIiwibWFwVmFsdWVzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7QUFFQUEsTUFBTSxDQUFDQyxjQUFQLENBQXNCQyxPQUF0QixFQUErQixZQUEvQixFQUE2QztBQUMzQ0MsRUFBQUEsS0FBSyxFQUFFO0FBRG9DLENBQTdDO0FBR0FELE9BQU8sQ0FBQ0UsZ0JBQVIsR0FBMkJBLGdCQUEzQjtBQUNBRixPQUFPLENBQUNHLGNBQVIsR0FBeUJBLGNBQXpCO0FBQ0FILE9BQU8sQ0FBQ0ksaUJBQVIsR0FBNEJBLGlCQUE1QjtBQUNBSixPQUFPLENBQUNLLGdCQUFSLEdBQTJCLEtBQUss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Q0QsT0FIRCxNQUdPO0FBQ0xzQixRQUFBQSxZQUFZLEdBQUcsQ0FBQyxHQUFHMUIsWUFBWSxDQUFDSSxPQUFqQixFQUEwQm9CLGNBQTFCLENBQWY7QUFDQUcsUUFBQUEsUUFBUSxHQUFHakMsT0FBTyxDQUFDVSxPQUFuQjtBQUNEOztBQUVELFVBQUlzQixZQUFZLENBQUNHLFdBQWIsSUFBNEJILFlBQVksQ0FBQ25CLE1BQTdDLEVBQXFEO0FBQ25EVSxRQUFBQSxjQUFjLENBQUNTLFlBQVksQ0FBQ0csV0FBZCxFQUEyQixVQUFDQyxZQUFELEVBQWV0QixJQUFmLEVBQXdCO0FBQy9ELGNBQU11QixJQUFJLEdBQUdKLFFBQVEsQ0FBQ0csWUFBRCxFQUFlSixZQUFZLENBQUNuQixNQUE1QixDQUFyQjs7QUFFQSxjQUFJRiwwQkFBMEIsQ0FBQ29CLGFBQUQsQ0FBMUIsSUFBNkNNLElBQWpELEVBQXVEO0FBQ3JELG1CQUFPTixhQUFhLENBQUNPLEVBQWQsQ0FBaUJGLFlBQWpCLEVBQStCdEIsSUFBL0IsQ0FBUDtBQUNEOztBQUVELGlCQUFPdUIsSUFBSSxHQUFHTixhQUFILEdBQW1CakIsSUFBSSxFQUFsQztBQUNELFNBUmEsQ0FBZDtBQVNEO0FBQ0YsS0F4QkQsTUF3Qk87QUFDTHRCLE1BQUFBLE1BQU0sQ0FBQytDLElBQVAsQ0FBWVosZUFBWixFQUE2QkQsT0FBN0IsQ0FBcUMsVUFBQVMsV0FBVyxFQUFJO0FBRWxELFlBQU1qQixRQUFRLEdBQUdTLGVBQWUsQ0FBQ1EsV0FBRCxDQUFoQztBQUNBWixRQUFBQSxjQUFjLENBQUNZLFdBQUQsRUFBY2pCLFFBQWQsQ0FBZDtBQUNELE9BSkQ7QUFLRDtBQUNGLEdBaENEO0FBaUNBLFNBQU8sQ0FBQyxHQUFHWCxPQUFPLENBQUNpQyxTQUFaLEVBQXVCbEIsU0FBdkIsRUFBa0N6QixjQUFsQyxDQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsIFwiX19lc01vZHVsZVwiLCB7XG4gIHZhbHVlOiB0cnVlXG59KTtcbmV4cG9ydHMuY29tcG9zZVByb3ZpZGVycyA9IGNvbXBvc2VQcm92aWRlcnM7XG5leHBvcnRzLmFwcGx5UHJvdmlkZXJzID0gYXBwbHlQcm92aWRlcnM7XG5leHBvcnRzLmNvYWxlc2NlUHJvdmlkZXJzID0gY29hbGVzY2VQcm92aWRlcnM7XG5leHBvcnRzLkRZTkFNSUNfUFJPVklERVIgPSB2b2lkIDA7XG5cbnZhciBfbG9kYXNoID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKFwibG9kYXNoLmlzZXF1YWxcIikpO1xuXG52YXIgX2xvZGFzaDIgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCJsb2Rhc2guaXNtYXRjaFwiKSk7XG5cbnZhciBfcHJvdmlkZVZhbHVlID0gcmVxdWlyZShcIi4uL3Byb3ZpZGVWYWx1ZVwiKTtcblxudmFyIF9oZWxwZXJzID0gcmVxdWlyZShcIi4uL21hdGNoZXJzL2hlbHBlcnNcIik7XG5cbnZhciBfcGFyc2VFZmZlY3QgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoXCIuLi9wYXJzZUVmZmVjdFwiKSk7XG5cbnZhciBfb2JqZWN0ID0gcmVxdWlyZShcIi4uLy4uL3V0aWxzL29iamVjdFwiKTtcblxuZnVuY3Rpb24gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChvYmopIHsgcmV0dXJuIG9iaiAmJiBvYmouX19lc01vZHVsZSA/IG9iaiA6IHsgZGVmYXVsdDogb2JqIH07IH1cblxuY29uc3QgRFlOQU1JQ19QUk9WSURFUiA9ICdAQHJlZHV4LXNhZ2EtdGVzdC1wbGFuL2R5bmFtaWMtcHJvdmlkZXInO1xuZXhwb3J0cy5EWU5BTUlDX1BST1ZJREVSID0gRFlOQU1JQ19QUk9WSURFUjtcblxuZnVuY3Rpb24gaXNEeW5hbWljYWxseVByb3ZpZGVkVmFsdWUodmFsdWUpIHtcbiAgcmV0dXJuICEhdmFsdWUgJiYgdHlwZW9mIHZhbHVlID09PSAnb2JqZWN0JyAmJiBEWU5BTUlDX1BST1ZJREVSIGluIHZhbHVlO1xufVxuXG5mdW5jdGlvbiBjb21wb3NlUHJvdmlkZXJzKC4uLnByb3ZpZGVycykge1xuICByZXR1cm4gKGVmZmVjdCwgbmV4dCkgPT4ge1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gcHJvdmlkZXJzLmxlbmd0aDsgaSA8IGw7IGkrKykge1xuICAgICAgY29uc3QgcHJvdmlkZXIgPSBwcm92aWRlcnNbaV07XG4gICAgICBjb25zdCByZXN1bHQgPSBwcm92aWRlcihlZmZlY3QsIG5leHQpO1xuXG4gICAgICBpZiAocmVzdWx0ICE9PSBfcHJvdmlkZVZhbHVlLk5FWFQpIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gX3Byb3ZpZGVWYWx1ZS5ORVhUO1xuICB9O1xufVxuXG5mdW5jdGlvbiBhcHBseVByb3ZpZGVycyhwcm92aWRlckZucykge1xuICByZXR1cm4gY29tcG9zZVByb3ZpZGVycyguLi5wcm92aWRlckZucyk7XG59XG5cbmZ1bmN0aW9uIGNvYWxlc2NlUHJvdmlkZXJzKHByb3ZpZGVycykge1xuICBjb25zdCBjb2xsZWN0ZWQgPSB7fTtcblxuICBmdW5jdGlvbiBhZGRUb0NvbGxlY3RlZChrZXksIHZhbHVlKSB7XG4gICAgaWYgKGtleSBpbiBjb2xsZWN0ZWQpIHtcbiAgICAgIGNvbGxlY3RlZFtrZXldLnB1c2godmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb2xsZWN0ZWRba2V5XSA9IFt2YWx1ZV07XG4gICAgfVxuICB9XG5cbiAgcHJvdmlkZXJzLmZvckVhY2gocHJvdmlkZXJzT2JqZWN0ID0+IHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShwcm92aWRlcnNPYmplY3QpKSB7XG4gICAgICBjb25zdCBbZXhwZWN0ZWRFZmZlY3QsIHByb3ZpZGVkVmFsdWVdID0gcHJvdmlkZXJzT2JqZWN0O1xuICAgICAgbGV0IHBhcnNlZEVmZmVjdDtcbiAgICAgIGxldCBjb21wYXJlcjtcblxuICAgICAgaWYgKCgwLCBfaGVscGVycy5pc1BhcnRpYWxNYXRjaGVyKShleHBlY3RlZEVmZmVjdCkpIHtcbiAgICAgICAgcGFyc2VkRWZmZWN0ID0gZXhwZWN0ZWRFZmZlY3Q7XG4gICAgICAgIGNvbXBhcmVyID0gX2xvZGFzaDIuZGVmYXVsdDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBhcnNlZEVmZmVjdCA9ICgwLCBfcGFyc2VFZmZlY3QuZGVmYXVsdCkoZXhwZWN0ZWRFZmZlY3QpO1xuICAgICAgICBjb21wYXJlciA9IF9sb2Rhc2guZGVmYXVsdDtcbiAgICAgIH1cblxuICAgICAgaWYgKHBhcnNlZEVmZmVjdC5wcm92aWRlcktleSAmJiBwYXJzZWRFZmZlY3QuZWZmZWN0KSB7XG4gICAgICAgIGFkZFRvQ29sbGVjdGVkKHBhcnNlZEVmZmVjdC5wcm92aWRlcktleSwgKGFjdHVhbEVmZmVjdCwgbmV4dCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHBhc3MgPSBjb21wYXJlcihhY3R1YWxFZmZlY3QsIHBhcnNlZEVmZmVjdC5lZmZlY3QpO1xuXG4gICAgICAgICAgaWYgKGlzRHluYW1pY2FsbHlQcm92aWRlZFZhbHVlKHByb3ZpZGVkVmFsdWUpICYmIHBhc3MpIHtcbiAgICAgICAgICAgIHJldHVybiBwcm92aWRlZFZhbHVlLmZuKGFjdHVhbEVmZmVjdCwgbmV4dCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHBhc3MgPyBwcm92aWRlZFZhbHVlIDogbmV4dCgpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LmtleXMocHJvdmlkZXJzT2JqZWN0KS5mb3JFYWNoKHByb3ZpZGVyS2V5ID0+IHtcbiAgICAgICAgLy8gJEZsb3dGaXhNZVxuICAgICAgICBjb25zdCBwcm92aWRlciA9IHByb3ZpZGVyc09iamVjdFtwcm92aWRlcktleV07XG4gICAgICAgIGFkZFRvQ29sbGVjdGVkKHByb3ZpZGVyS2V5LCBwcm92aWRlcik7XG4gICAgICB9KTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gKDAsIF9vYmplY3QubWFwVmFsdWVzKShjb2xsZWN0ZWQsIGFwcGx5UHJvdmlkZXJzKTtcbn0iXX0=