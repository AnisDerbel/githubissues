aff7579834b26e8f8f48a8e6f9fda0b5
"use strict";

exports.__esModule = true;
exports["default"] = void 0;

var _batch = require("./batch");

var nullListeners = {
  notify: function notify() {}
};

function createListenerCollection() {
  var batch = (0, _batch.getBatch)();
  var first = null;
  var last = null;
  return {
    clear: function clear() {
      first = null;
      last = null;
    },
    notify: function notify() {
      batch(function () {
        var listener = first;

        while (listener) {
          listener.callback();
          listener = listener.next;
        }
      });
    },
    get: function get() {
      var listeners = [];
      var listener = first;

      while (listener) {
        listeners.push(listener);
        listener = listener.next;
      }

      return listeners;
    },
    subscribe: function subscribe(callback) {
      var isSubscribed = true;
      var listener = last = {
        callback: callback,
        next: null,
        prev: last
      };

      if (listener.prev) {
        listener.prev.next = listener;
      } else {
        first = listener;
      }

      return function unsubscribe() {
        if (!isSubscribed || first === null) return;
        isSubscribed = false;

        if (listener.next) {
          listener.next.prev = listener.prev;
        } else {
          last = listener.prev;
        }

        if (listener.prev) {
          listener.prev.next = listener.next;
        } else {
          first = listener.next;
        }
      };
    }
  };
}

var Subscription = function () {
  function Subscription(store, parentSub) {
    this.store = store;
    this.parentSub = parentSub;
    this.unsubscribe = null;
    this.listeners = nullListeners;
    this.handleChangeWrapper = this.handleChangeWrapper.bind(this);
  }

  var _proto = Subscription.prototype;

  _proto.addNestedSub = function addNestedSub(listener) {
    this.trySubscribe();
    return this.listeners.subscribe(listener);
  };

  _proto.notifyNestedSubs = function notifyNestedSubs() {
    this.listeners.notify();
  };

  _proto.handleChangeWrapper = function handleChangeWrapper() {
    if (this.onStateChange) {
      this.onStateChange();
    }
  };

  _proto.isSubscribed = function isSubscribed() {
    return Boolean(this.unsubscribe);
  };

  _proto.trySubscribe = function trySubscribe() {
    if (!this.unsubscribe) {
      this.unsubscribe = this.parentSub ? this.parentSub.addNestedSub(this.handleChangeWrapper) : this.store.subscribe(this.handleChangeWrapper);
      this.listeners = createListenerCollection();
    }
  };

  _proto.tryUnsubscribe = function tryUnsubscribe() {
    if (this.unsubscribe) {
      this.unsubscribe();
      this.unsubscribe = null;
      this.listeners.clear();
      this.listeners = nullListeners;
    }
  };

  return Subscription;
}();

exports["default"] = Subscription;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlN1YnNjcmlwdGlvbi5qcyJdLCJuYW1lcyI6WyJleHBvcnRzIiwiX19lc01vZHVsZSIsIl9iYXRjaCIsInJlcXVpcmUiLCJudWxsTGlzdGVuZXJzIiwibm90aWZ5IiwiY3JlYXRlTGlzdGVuZXJDb2xsZWN0aW9uIiwiYmF0Y2giLCJnZXRCYXRjaCIsImZpcnN0IiwibGFzdCIsImNsZWFyIiwibGlzdGVuZXIiLCJjYWxsYmFjayIsIm5leHQiLCJnZXQiLCJsaXN0ZW5lcnMiLCJwdXNoIiwic3Vic2NyaWJlIiwiaXNTdWJzY3JpYmVkIiwicHJldiIsInVuc3Vic2NyaWJlIiwiU3Vic2NyaXB0aW9uIiwic3RvcmUiLCJwYXJlbnRTdWIiLCJoYW5kbGVDaGFuZ2VXcmFwcGVyIiwiYmluZCIsIl9wcm90byIsInByb3RvdHlwZSIsImFkZE5lc3RlZFN1YiIsInRyeVN1YnNjcmliZSIsIm5vdGlmeU5lc3RlZFN1YnMiLCJvblN0YXRlQ2hhbmdlIiwiQm9vbGVhbiIsInRyeVVuc3Vic2NyaWJlIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQUEsT0FBTyxDQUFDQyxVQUFSLEdBQXFCLElBQXJCO0FBQ0FELE9BQU8sQ0FBQyxTQUFELENBQVAsR0FBcUIsS0FBSyxDQUExQjs7QUFFQSxJQUFJRSxNQUFNLEdBQUdDLE9BQU8sQ0FBQyxTQUFELENBQXBCOztBQUtBLElBQUlDLGFBQWEsR0FBRztBQUNsQkMsRUFBQUEsTUFBTSxFQUFFLFNBQVNBLE1BQVQsR0FBa0IsQ0FBRTtBQURWLENBQXBCOztBQUlBLFNBQVNDLHdCQUFULEdBQW9DO0FBQ2xDLE1BQUlDLEtBQUssR0FBRyxDQUFDLEdBQUdMLE1BQU0sQ0FBQ00sUUFBWCxHQUFaO0FBQ0EsTUFBSUMsS0FBSyxHQUFHLElBQVo7QUFDQSxNQUFJQyxJQUFJLEdBQUcsSUFBWDtBQUNBLFNBQU87QUFDTEMsSUFBQUEsS0FBSyxFQUFFLFNBQVNBLEtBQVQsR0FBaUI7QUFDdEJGLE1BQUFBLEtBQUssR0FBRyxJQUFSO0FBQ0FDLE1BQUFBLElBQUksR0FBRyxJQUFQO0FBQ0QsS0FKSTtBQUtMTCxJQUFBQSxNQUFNLEVBQUUsU0FBU0EsTUFBVCxHQUFrQjtBQUN4QkUsTUFBQUEsS0FBSyxDQUFDLFlBQVk7QUFDaEIsWUFBSUssUUFBUSxHQUFHSCxLQUFmOztBQUVBLGVBQU9HLFFBQVAsRUFBaUI7QUFDZkEsVUFBQUEsUUFBUSxDQUFDQyxRQUFUO0FBQ0FELFVBQUFBLFFBQVEsR0FBR0EsUUFBUSxDQUFDRSxJQUFwQjtBQUNEO0FBQ0YsT0FQSSxDQUFMO0FBUUQsS0FkSTtBQWVMQyxJQUFBQSxHQUFHLEVBQUUsU0FBU0EsR0FBVCxHQUFlO0FBQ2xCLFVBQUlDLFNBQVMsR0FBRyxFQUFoQjtBQUNBLFVBQUlKLFFBQVEsR0FBR0gsS0FBZjs7QUFFQSxhQUFPRyxRQUFQLEVBQWlCO0FBQ2ZJLFFBQUFBLFNBQVMsQ0FBQ0MsSUFBVixDQUFlTCxRQUFmO0FBQ0FBLFFBQUFBLFFBQVEsR0FBR0EsUUFBUSxDQUFDRSxJQUFwQjtBQUNEOztBQUVELGFBQU9FLFNBQVA7QUFDRCxLQXpCSTtBQTBCTEUsSUFBQUEsU0FBUyxFQUFFLFNBQVNBLFNBQVQsQ0FBbUJMLFFBQW5CLEVBQTZCO0FBQ3RDLFVBQUlNLFlBQVksR0FBRyxJQUFuQjtBQUNBLFVBQUlQLFFBQVEsR0FBR0YsSUFBSSxHQUFHO0FBQ3BCRyxRQUFBQSxRQUFRLEVBQUVBLFFBRFU7QUFFcEJDLFFBQUFBLElBQUksRUFBRSxJQUZjO0FBR3BCTSxRQUFBQSxJQUFJLEVBQUVWO0FBSGMsT0FBdEI7O0FBTUEsVUFBSUUsUUFBUSxDQUFDUSxJQUFiLEVBQW1CO0FBQ2pCUixRQUFBQSxRQUFRLENBQUNRLElBQVQsQ0FBY04sSUFBZCxHQUFxQkYsUUFBckI7QUFDRCxPQUZELE1BRU87QUFDTEgsUUFBQUEsS0FBSyxHQUFHRyxRQUFSO0FBQ0Q7O0FBRUQsYUFBTyxTQUFTUyxXQUFULEdBQXVCO0FBQzVCLFlBQUksQ0FBQ0YsWUFBRCxJQUFpQlYsS0FBSyxLQUFLLElBQS9CLEVBQXFDO0FBQ3JDVSxRQUFBQSxZQUFZLEdBQUcsS0FBZjs7QUFFQSxZQUFJUCxRQUFRLENBQUNFLElBQWIsRUFBbUI7QUFDakJGLFVBQUFBLFFBQVEsQ0FBQ0UsSUFBVCxDQUFjTSxJQUFkLEdBQXFCUixRQUFRLENBQUNRLElBQTlCO0FBQ0QsU0FGRCxNQUVPO0FBQ0xWLFVBQUFBLElBQUksR0FBR0UsUUFBUSxDQUFDUSxJQUFoQjtBQUNEOztBQUVELFlBQUlSLFFBQVEsQ0FBQ1EsSUFBYixFQUFtQjtBQUNqQlIsVUFBQUEsUUFBUSxDQUFDUSxJQUFULENBQWNOLElBQWQsR0FBcUJGLFFBQVEsQ0FBQ0UsSUFBOUI7QUFDRCxTQUZELE1BRU87QUFDTEwsVUFBQUEsS0FBSyxHQUFHRyxRQUFRLENBQUNFLElBQWpCO0FBQ0Q7QUFDRixPQWZEO0FBZ0JEO0FBeERJLEdBQVA7QUEwREQ7O0FBRUQsSUFBSVEsWUFBWSxHQUFnQixZQUFZO0FBQzFDLFdBQVNBLFlBQVQsQ0FBc0JDLEtBQXRCLEVBQTZCQyxTQUE3QixFQUF3QztBQUN0QyxTQUFLRCxLQUFMLEdBQWFBLEtBQWI7QUFDQSxTQUFLQyxTQUFMLEdBQWlCQSxTQUFqQjtBQUNBLFNBQUtILFdBQUwsR0FBbUIsSUFBbkI7QUFDQSxTQUFLTCxTQUFMLEdBQWlCWixhQUFqQjtBQUNBLFNBQUtxQixtQkFBTCxHQUEyQixLQUFLQSxtQkFBTCxDQUF5QkMsSUFBekIsQ0FBOEIsSUFBOUIsQ0FBM0I7QUFDRDs7QUFFRCxNQUFJQyxNQUFNLEdBQUdMLFlBQVksQ0FBQ00sU0FBMUI7O0FBRUFELEVBQUFBLE1BQU0sQ0FBQ0UsWUFBUCxHQUFzQixTQUFTQSxZQUFULENBQXNCakIsUUFBdEIsRUFBZ0M7QUFDcEQsU0FBS2tCLFlBQUw7QUFDQSxXQUFPLEtBQUtkLFNBQUwsQ0FBZUUsU0FBZixDQUF5Qk4sUUFBekIsQ0FBUDtBQUNELEdBSEQ7O0FBS0FlLEVBQUFBLE1BQU0sQ0FBQ0ksZ0JBQVAsR0FBMEIsU0FBU0EsZ0JBQVQsR0FBNEI7QUFDcEQsU0FBS2YsU0FBTCxDQUFlWCxNQUFmO0FBQ0QsR0FGRDs7QUFJQXNCLEVBQUFBLE1BQU0sQ0FBQ0YsbUJBQVAsR0FBNkIsU0FBU0EsbUJBQVQsR0FBK0I7QUFDMUQsUUFBSSxLQUFLTyxhQUFULEVBQXdCO0FBQ3RCLFdBQUtBLGFBQUw7QUFDRDtBQUNGLEdBSkQ7O0FBTUFMLEVBQUFBLE1BQU0sQ0FBQ1IsWUFBUCxHQUFzQixTQUFTQSxZQUFULEdBQXdCO0FBQzVDLFdBQU9jLE9BQU8sQ0FBQyxLQUFLWixXQUFOLENBQWQ7QUFDRCxHQUZEOztBQUlBTSxFQUFBQSxNQUFNLENBQUNHLFlBQVAsR0FBc0IsU0FBU0EsWUFBVCxHQUF3QjtBQUM1QyxRQUFJLENBQUMsS0FBS1QsV0FBVixFQUF1QjtBQUNyQixXQUFLQSxXQUFMLEdBQW1CLEtBQUtHLFNBQUwsR0FBaUIsS0FBS0EsU0FBTCxDQUFlSyxZQUFmLENBQTRCLEtBQUtKLG1CQUFqQyxDQUFqQixHQUF5RSxLQUFLRixLQUFMLENBQVdMLFNBQVgsQ0FBcUIsS0FBS08sbUJBQTFCLENBQTVGO0FBQ0EsV0FBS1QsU0FBTCxHQUFpQlYsd0JBQXdCLEVBQXpDO0FBQ0Q7QUFDRixHQUxEOztBQU9BcUIsRUFBQUEsTUFBTSxDQUFDTyxjQUFQLEdBQXdCLFNBQVNBLGNBQVQsR0FBMEI7QUFDaEQsUUFBSSxLQUFLYixXQUFULEVBQXNCO0FBQ3BCLFdBQUtBLFdBQUw7QUFDQSxXQUFLQSxXQUFMLEdBQW1CLElBQW5CO0FBQ0EsV0FBS0wsU0FBTCxDQUFlTCxLQUFmO0FBQ0EsV0FBS0ssU0FBTCxHQUFpQlosYUFBakI7QUFDRDtBQUNGLEdBUEQ7O0FBU0EsU0FBT2tCLFlBQVA7QUFDRCxDQS9DK0IsRUFBaEM7O0FBaURBdEIsT0FBTyxDQUFDLFNBQUQsQ0FBUCxHQUFxQnNCLFlBQXJCIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmV4cG9ydHMuX19lc01vZHVsZSA9IHRydWU7XG5leHBvcnRzW1wiZGVmYXVsdFwiXSA9IHZvaWQgMDtcblxudmFyIF9iYXRjaCA9IHJlcXVpcmUoXCIuL2JhdGNoXCIpO1xuXG4vLyBlbmNhcHN1bGF0ZXMgdGhlIHN1YnNjcmlwdGlvbiBsb2dpYyBmb3IgY29ubmVjdGluZyBhIGNvbXBvbmVudCB0byB0aGUgcmVkdXggc3RvcmUsIGFzXG4vLyB3ZWxsIGFzIG5lc3Rpbmcgc3Vic2NyaXB0aW9ucyBvZiBkZXNjZW5kYW50IGNvbXBvbmVudHMsIHNvIHRoYXQgd2UgY2FuIGVuc3VyZSB0aGVcbi8vIGFuY2VzdG9yIGNvbXBvbmVudHMgcmUtcmVuZGVyIGJlZm9yZSBkZXNjZW5kYW50c1xudmFyIG51bGxMaXN0ZW5lcnMgPSB7XG4gIG5vdGlmeTogZnVuY3Rpb24gbm90aWZ5KCkge31cbn07XG5cbmZ1bmN0aW9uIGNyZWF0ZUxpc3RlbmVyQ29sbGVjdGlvbigpIHtcbiAgdmFyIGJhdGNoID0gKDAsIF9iYXRjaC5nZXRCYXRjaCkoKTtcbiAgdmFyIGZpcnN0ID0gbnVsbDtcbiAgdmFyIGxhc3QgPSBudWxsO1xuICByZXR1cm4ge1xuICAgIGNsZWFyOiBmdW5jdGlvbiBjbGVhcigpIHtcbiAgICAgIGZpcnN0ID0gbnVsbDtcbiAgICAgIGxhc3QgPSBudWxsO1xuICAgIH0sXG4gICAgbm90aWZ5OiBmdW5jdGlvbiBub3RpZnkoKSB7XG4gICAgICBiYXRjaChmdW5jdGlvbiAoKSB7XG4gICAgICAgIHZhciBsaXN0ZW5lciA9IGZpcnN0O1xuXG4gICAgICAgIHdoaWxlIChsaXN0ZW5lcikge1xuICAgICAgICAgIGxpc3RlbmVyLmNhbGxiYWNrKCk7XG4gICAgICAgICAgbGlzdGVuZXIgPSBsaXN0ZW5lci5uZXh0O1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9LFxuICAgIGdldDogZnVuY3Rpb24gZ2V0KCkge1xuICAgICAgdmFyIGxpc3RlbmVycyA9IFtdO1xuICAgICAgdmFyIGxpc3RlbmVyID0gZmlyc3Q7XG5cbiAgICAgIHdoaWxlIChsaXN0ZW5lcikge1xuICAgICAgICBsaXN0ZW5lcnMucHVzaChsaXN0ZW5lcik7XG4gICAgICAgIGxpc3RlbmVyID0gbGlzdGVuZXIubmV4dDtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGxpc3RlbmVycztcbiAgICB9LFxuICAgIHN1YnNjcmliZTogZnVuY3Rpb24gc3Vic2NyaWJlKGNhbGxiYWNrKSB7XG4gICAgICB2YXIgaXNTdWJzY3JpYmVkID0gdHJ1ZTtcbiAgICAgIHZhciBsaXN0ZW5lciA9IGxhc3QgPSB7XG4gICAgICAgIGNhbGxiYWNrOiBjYWxsYmFjayxcbiAgICAgICAgbmV4dDogbnVsbCxcbiAgICAgICAgcHJldjogbGFzdFxuICAgICAgfTtcblxuICAgICAgaWYgKGxpc3RlbmVyLnByZXYpIHtcbiAgICAgICAgbGlzdGVuZXIucHJldi5uZXh0ID0gbGlzdGVuZXI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBmaXJzdCA9IGxpc3RlbmVyO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZnVuY3Rpb24gdW5zdWJzY3JpYmUoKSB7XG4gICAgICAgIGlmICghaXNTdWJzY3JpYmVkIHx8IGZpcnN0ID09PSBudWxsKSByZXR1cm47XG4gICAgICAgIGlzU3Vic2NyaWJlZCA9IGZhbHNlO1xuXG4gICAgICAgIGlmIChsaXN0ZW5lci5uZXh0KSB7XG4gICAgICAgICAgbGlzdGVuZXIubmV4dC5wcmV2ID0gbGlzdGVuZXIucHJldjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBsYXN0ID0gbGlzdGVuZXIucHJldjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChsaXN0ZW5lci5wcmV2KSB7XG4gICAgICAgICAgbGlzdGVuZXIucHJldi5uZXh0ID0gbGlzdGVuZXIubmV4dDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBmaXJzdCA9IGxpc3RlbmVyLm5leHQ7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICB9O1xufVxuXG52YXIgU3Vic2NyaXB0aW9uID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHtcbiAgZnVuY3Rpb24gU3Vic2NyaXB0aW9uKHN0b3JlLCBwYXJlbnRTdWIpIHtcbiAgICB0aGlzLnN0b3JlID0gc3RvcmU7XG4gICAgdGhpcy5wYXJlbnRTdWIgPSBwYXJlbnRTdWI7XG4gICAgdGhpcy51bnN1YnNjcmliZSA9IG51bGw7XG4gICAgdGhpcy5saXN0ZW5lcnMgPSBudWxsTGlzdGVuZXJzO1xuICAgIHRoaXMuaGFuZGxlQ2hhbmdlV3JhcHBlciA9IHRoaXMuaGFuZGxlQ2hhbmdlV3JhcHBlci5iaW5kKHRoaXMpO1xuICB9XG5cbiAgdmFyIF9wcm90byA9IFN1YnNjcmlwdGlvbi5wcm90b3R5cGU7XG5cbiAgX3Byb3RvLmFkZE5lc3RlZFN1YiA9IGZ1bmN0aW9uIGFkZE5lc3RlZFN1YihsaXN0ZW5lcikge1xuICAgIHRoaXMudHJ5U3Vic2NyaWJlKCk7XG4gICAgcmV0dXJuIHRoaXMubGlzdGVuZXJzLnN1YnNjcmliZShsaXN0ZW5lcik7XG4gIH07XG5cbiAgX3Byb3RvLm5vdGlmeU5lc3RlZFN1YnMgPSBmdW5jdGlvbiBub3RpZnlOZXN0ZWRTdWJzKCkge1xuICAgIHRoaXMubGlzdGVuZXJzLm5vdGlmeSgpO1xuICB9O1xuXG4gIF9wcm90by5oYW5kbGVDaGFuZ2VXcmFwcGVyID0gZnVuY3Rpb24gaGFuZGxlQ2hhbmdlV3JhcHBlcigpIHtcbiAgICBpZiAodGhpcy5vblN0YXRlQ2hhbmdlKSB7XG4gICAgICB0aGlzLm9uU3RhdGVDaGFuZ2UoKTtcbiAgICB9XG4gIH07XG5cbiAgX3Byb3RvLmlzU3Vic2NyaWJlZCA9IGZ1bmN0aW9uIGlzU3Vic2NyaWJlZCgpIHtcbiAgICByZXR1cm4gQm9vbGVhbih0aGlzLnVuc3Vic2NyaWJlKTtcbiAgfTtcblxuICBfcHJvdG8udHJ5U3Vic2NyaWJlID0gZnVuY3Rpb24gdHJ5U3Vic2NyaWJlKCkge1xuICAgIGlmICghdGhpcy51bnN1YnNjcmliZSkge1xuICAgICAgdGhpcy51bnN1YnNjcmliZSA9IHRoaXMucGFyZW50U3ViID8gdGhpcy5wYXJlbnRTdWIuYWRkTmVzdGVkU3ViKHRoaXMuaGFuZGxlQ2hhbmdlV3JhcHBlcikgOiB0aGlzLnN0b3JlLnN1YnNjcmliZSh0aGlzLmhhbmRsZUNoYW5nZVdyYXBwZXIpO1xuICAgICAgdGhpcy5saXN0ZW5lcnMgPSBjcmVhdGVMaXN0ZW5lckNvbGxlY3Rpb24oKTtcbiAgICB9XG4gIH07XG5cbiAgX3Byb3RvLnRyeVVuc3Vic2NyaWJlID0gZnVuY3Rpb24gdHJ5VW5zdWJzY3JpYmUoKSB7XG4gICAgaWYgKHRoaXMudW5zdWJzY3JpYmUpIHtcbiAgICAgIHRoaXMudW5zdWJzY3JpYmUoKTtcbiAgICAgIHRoaXMudW5zdWJzY3JpYmUgPSBudWxsO1xuICAgICAgdGhpcy5saXN0ZW5lcnMuY2xlYXIoKTtcbiAgICAgIHRoaXMubGlzdGVuZXJzID0gbnVsbExpc3RlbmVycztcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIFN1YnNjcmlwdGlvbjtcbn0oKTtcblxuZXhwb3J0c1tcImRlZmF1bHRcIl0gPSBTdWJzY3JpcHRpb247Il19